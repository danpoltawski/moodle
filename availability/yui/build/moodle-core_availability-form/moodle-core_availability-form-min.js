YUI.add("moodle-core_availability-form",function(a,b){M.core_availability=M.core_availability||{},M.core_availability.form={plugins:{},field:null,mainDiv:null,rootList:null,idCounter:0,restrictByGroup:null,init:function(b){for(var c in b){var d=b[c],e=M[d[0]].form;e.init.apply(e,d)}this.field=a.one("#id_availabilityconditionsjson"),this.field.setAttribute("aria-hidden","true"),this.mainDiv=a.Node.create('<div class="availability-field fcontainer"></div>'),this.field.insert(this.mainDiv,"after");var f=this.field.get("value"),g=null;if(""!==f)try{g=a.JSON.parse(f)}catch(h){this.field.set("value","")}if(this.rootList=new M.core_availability.List(g,(!0)),this.mainDiv.appendChild(this.rootList.node),this.update(),this.rootList.renumber(),this.mainDiv.setAttribute("aria-live","polite"),this.field.ancestor("form").on("submit",function(){this.mainDiv.all("input,textarea,select").set("disabled",!0)},this),this.restrictByGroup=a.one("#restrictbygroup"),this.restrictByGroup){this.restrictByGroup.on("click",this.addRestrictByGroup,this);var i=a.one("#id_groupmode"),j=a.one("#id_groupingid");i&&i.on("change",this.updateRestrictByGroup,this),j&&j.on("change",this.updateRestrictByGroup,this),this.updateRestrictByGroup()}},update:function(){var b=this.rootList.getValue(),c=[];this.rootList.fillErrors(c),0!==c.length&&(b.errors=c),this.field.set("value",a.JSON.stringify(b)),this.updateRestrictByGroup()},updateRestrictByGroup:function(){if(this.restrictByGroup){if("&"!==this.rootList.getValue().op)return void this.restrictByGroup.set("disabled",!0);var b=this.rootList.hasItemOfType("group")||this.rootList.hasItemOfType("grouping");if(b)return void this.restrictByGroup.set("disabled",!0);var c=a.one("#id_groupmode"),d=a.one("#id_groupingid");return c&&0!==Number(c.get("value"))||d&&0!==Number(d.get("value"))?void this.restrictByGroup.set("disabled",!1):void this.restrictByGroup.set("disabled",!0)}},addRestrictByGroup:function(b){b.preventDefault();var c,d=a.one("#id_groupingid");c=d&&0!==Number(d.get("value"))?new M.core_availability.Item({type:"grouping",id:Number(d.get("value"))},(!0)):new M.core_availability.Item({type:"group"},(!0)),this.rootList.addChild(c),this.update(),this.rootList.renumber(),this.rootList.updateHtml()}},M.core_availability.plugin={allowAdd:!1,init:function(a,b,c){var d=a.replace(/^availability_/,"");this.allowAdd=b,M.core_availability.form.plugins[d]=this,this.initInner.apply(this,c)},initInner:function(){},getNode:function(){throw"getNode not implemented"},fillValue:function(){throw"fillValue not implemented"},fillErrors:function(){},focusAfterAdd:function(a){var b=a.one("input:not([disabled]),select:not([disabled])");b.focus()}},M.core_availability.List=function(b,c,d){this.children=[],void 0!==c&&(this.root=c),this.node=a.Node.create('<div class="availability-list"><h3 class="accesshide"></h3><div class="availability-inner"><div class="availability-header"><span class="p-l-1">'+M.util.get_string("listheader_sign_before","availability")+'</span> <label><span class="accesshide">'+M.util.get_string("label_sign","availability")+' </span><select class="availability-neg custom-select m-x-1" title="'+M.util.get_string("label_sign","availability")+'"><option value="">'+M.util.get_string("listheader_sign_pos","availability")+'</option><option value="!">'+M.util.get_string("listheader_sign_neg","availability")+'</option></select></label> <span class="availability-single">'+M.util.get_string("listheader_single","availability")+'</span><span class="availability-multi">'+M.util.get_string("listheader_multi_before","availability")+' <label><span class="accesshide">'+M.util.get_string("label_multi","availability")+' </span><select class="availability-op custom-select m-x-1" title="'+M.util.get_string("label_multi","availability")+'"><option value="&">'+M.util.get_string("listheader_multi_and","availability")+'</option><option value="|">'+M.util.get_string("listheader_multi_or","availability")+"</option></select></label> "+M.util.get_string("listheader_multi_after","availability")+'</span></div><div class="availability-children"></div><div class="availability-none"><span class="p-x-1">'+M.util.get_string("none","moodle")+'</span></div><div class="clearfix m-t-1"></div><div class="availability-button"></div></div><div class="clearfix"></div></div>'),c||this.node.addClass("availability-childlist"),this.inner=this.node.one("> .availability-inner");var e=!0;if(c?(b&&void 0!==b.show&&(e=b.show),this.eyeIcon=new M.core_availability.EyeIcon((!1),e),this.node.one(".availability-header").get("firstChild").insert(this.eyeIcon.span,"before")):d&&(b&&void 0!==b.showc&&(e=b.showc),this.eyeIcon=new M.core_availability.EyeIcon((!1),e),this.inner.insert(this.eyeIcon.span,"before")),!c){var f=new M.core_availability.DeleteIcon(this),g=this.node.one(".availability-none");g.appendChild(document.createTextNode(" ")),g.appendChild(f.span),g.appendChild(a.Node.create('<span class="m-t-1 label label-warning">'+M.util.get_string("invalid","availability")+"</span>"))}var h=a.Node.create('<button type="button" class="btn btn-default m-t-1">'+M.util.get_string("addrestriction","availability")+"</button>");if(h.on("click",function(){this.clickAdd()},this),this.node.one("div.availability-button").appendChild(h),b){switch(b.op){case"&":case"|":this.node.one(".availability-neg").set("value","");break;case"!&":case"!|":this.node.one(".availability-neg").set("value","!")}switch(b.op){case"&":case"!&":this.node.one(".availability-op").set("value","&");break;case"|":case"!|":this.node.one(".availability-op").set("value","|")}for(var i=0;i<b.c.length;i++){var j=b.c[i];this.root&&b&&void 0!==b.showc&&(j.showc=b.showc[i]);var k;k=void 0!==j.type?new M.core_availability.Item(j,this.root):new M.core_availability.List(j,(!1),this.root),this.addChild(k)}}this.node.one(".availability-neg").on("change",function(){M.core_availability.form.update(),this.updateHtml()},this),this.node.one(".availability-op").on("change",function(){M.core_availability.form.update(),this.updateHtml()},this),this.updateHtml()},M.core_availability.List.prototype.addChild=function(b){this.children.length>0&&this.inner.one(".availability-children").appendChild(a.Node.create('<div class="availability-connector"><span class="label"></span></div>')),this.children.push(b),this.inner.one(".availability-children").appendChild(b.node)},M.core_availability.List.prototype.focusAfterAdd=function(){this.inner.one("button").focus()},M.core_availability.List.prototype.isIndividualShowIcons=function(){if(!this.root)throw"Can only call this on root list";var a="!"===this.node.one(".availability-neg").get("value"),b="|"===this.node.one(".availability-op").get("value");return!a&&!b||a&&b},M.core_availability.List.prototype.renumber=function(a){var b,c={count:this.children.length};void 0===a?(c.number="",b=""):(c.number=a+":",b=a+".");var d=M.util.get_string("setheading","availability",c);this.node.one("> h3").set("innerHTML",d);for(var e=0;e<this.children.length;e++){var f=this.children[e];f.renumber(b+(e+1))}},M.core_availability.List.prototype.updateHtml=function(){if(this.children.length>0?(this.inner.one("> .availability-children").removeAttribute("aria-hidden"),this.inner.one("> .availability-none").setAttribute("aria-hidden","true"),this.inner.one("> .availability-header").removeAttribute("aria-hidden"),this.children.length>1?(this.inner.one(".availability-single").setAttribute("aria-hidden","true"),this.inner.one(".availability-multi").removeAttribute("aria-hidden")):(this.inner.one(".availability-single").removeAttribute("aria-hidden"),this.inner.one(".availability-multi").setAttribute("aria-hidden","true"))):(this.inner.one("> .availability-children").setAttribute("aria-hidden","true"),this.inner.one("> .availability-none").removeAttribute("aria-hidden"),this.inner.one("> .availability-header").setAttribute("aria-hidden","true")),this.root){for(var a=this.isIndividualShowIcons(),b=0;b<this.children.length;b++){var c=this.children[b];a?c.eyeIcon.span.removeAttribute("aria-hidden"):c.eyeIcon.span.setAttribute("aria-hidden","true")}a?this.eyeIcon.span.setAttribute("aria-hidden","true"):this.eyeIcon.span.removeAttribute("aria-hidden")}var d;d="&"===this.inner.one(".availability-op").get("value")?M.util.get_string("and","availability"):M.util.get_string("or","availability"),this.inner.all("> .availability-children > .availability-connector span.label").each(function(a){a.set("innerHTML",d)})},M.core_availability.List.prototype.deleteDescendant=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c===a){this.children.splice(b,1);var d=c.node;return this.children.length>0&&(d.previous(".availability-connector")?d.previous(".availability-connector").remove():d.next(".availability-connector").remove()),this.inner.one("> .availability-children").removeChild(d),M.core_availability.form.update(),this.updateHtml(),this.inner.one("> .availability-button").one("button").focus(),!0}if(c instanceof M.core_availability.List){var e=c.deleteDescendant(a);if(e)return!0}}return!1},M.core_availability.List.prototype.clickAdd=function(){var b,c,d,e,f=a.Node.create('<div><ul class="list-unstyled container-fluid"></ul><div class="availability-buttons mdl-align"><button type="button" class="btn btn-default">'+M.util.get_string("cancel","moodle")+"</button></div></div>"),g=f.one("button"),h={dialog:null},i=f.one("ul");for(var j in M.core_availability.form.plugins)M.core_availability.form.plugins[j].allowAdd&&(b=a.Node.create('<li class="clearfix row"></li>'),c="availability_addrestriction_"+j,d=a.Node.create('<button type="button" class="btn btn-default col-xs-6"id="'+c+'">'+M.util.get_string("title","availability_"+j)+"</button>"),d.on("click",this.getAddHandler(j,h),this),b.appendChild(d),e=a.Node.create('<label for="'+c+'" class="col-xs-6">'+M.util.get_string("description","availability_"+j)+"</label>"),b.appendChild(e),i.appendChild(b));b=a.Node.create('<li class="clearfix row"></li>'),c="availability_addrestriction_list_",d=a.Node.create('<button type="button" class="btn btn-default col-xs-6"id="'+c+'">'+M.util.get_string("condition_group","availability")+"</button>"),d.on("click",this.getAddHandler(null,h),this),b.appendChild(d),e=a.Node.create('<label for="'+c+'" class="col-xs-6">'+M.util.get_string("condition_group_info","availability")+"</label>"),b.appendChild(e),i.appendChild(b);var k={headerContent:M.util.get_string("addrestriction","availability"),bodyContent:f,additionalBaseClass:"availability-dialogue",draggable:!0,modal:!0,closeButton:!1,width:"450px"};h.dialog=new M.core.dialogue(k),h.dialog.show(),g.on("click",function(){h.dialog.destroy(),this.inner.one("> .availability-button").one("button").focus()},this)},M.core_availability.List.prototype.getAddHandler=function(a,b){return function(){var c;c=a?new M.core_availability.Item({type:a,creating:!0},this.root):new M.core_availability.List({c:[],showc:!0},(!1),this.root),this.addChild(c),M.core_availability.form.update(),M.core_availability.form.rootList.renumber(),this.updateHtml(),b.dialog.destroy(),c.focusAfterAdd()}},M.core_availability.List.prototype.getValue=function(){var a={};a.op=this.node.one(".availability-neg").get("value")+this.node.one(".availability-op").get("value"),a.c=[];var b;for(b=0;b<this.children.length;b++)a.c.push(this.children[b].getValue());if(this.root)if(this.isIndividualShowIcons())for(a.showc=[],b=0;b<this.children.length;b++)a.showc.push(!this.children[b].eyeIcon.isHidden());else a.show=!this.eyeIcon.isHidden();return a},M.core_availability.List.prototype.fillErrors=function(a){0!==this.children.length||this.root||a.push("availability:error_list_nochildren");for(var b=0;b<this.children.length;b++)this.children[b].fillErrors(a)},M.core_availability.List.prototype.hasItemOfType=function(a){for(var b=0;b<this.children.length;b++){var c=this.children[b];if(c instanceof M.core_availability.List){if(c.hasItemOfType(a))return!0}else if(c.pluginType===a)return!0}return!1},M.core_availability.List.prototype.eyeIcon=null,M.core_availability.List.prototype.root=!1,M.core_availability.List.prototype.children=null,M.core_availability.List.prototype.node=null,M.core_availability.List.prototype.inner=null,M.core_availability.Item=function(b,c){if(this.pluginType=b.type,void 0===M.core_availability.form.plugins[b.type]?(this.plugin=null,this.pluginNode=a.Node.create('<div class="availability-warning">'+M.util.get_string("missingplugin","availability")+"</div>")):(this.plugin=M.core_availability.form.plugins[b.type],this.pluginNode=this.plugin.getNode(b),this.pluginNode.addClass("availability_"+b.type)),this.node=a.Node.create('<div class="availability-item d-inline-block"><h3 class="accesshide"></h3></div>'),c){var d=!0;void 0!==b.showc&&(d=b.showc),this.eyeIcon=new M.core_availability.EyeIcon((!0),d),this.node.appendChild(this.eyeIcon.span)}this.pluginNode.addClass("availability-plugincontrols"),this.node.appendChild(this.pluginNode);var e=new M.core_availability.DeleteIcon(this);this.node.appendChild(e.span),this.node.appendChild(document.createTextNode(" ")),this.node.appendChild(a.Node.create('<span class="m-t-1 label label-warning"/>'))},M.core_availability.Item.prototype.getValue=function(){var a={type:this.pluginType};return this.plugin&&this.plugin.fillValue(a,this.pluginNode),a},M.core_availability.Item.prototype.fillErrors=function(a){var b=a.length;this.plugin?this.plugin.fillErrors(a,this.pluginNode):a.push("core_availability:item_unknowntype");var c=this.node.one("> .label-warning");a.length===b||c.get("firstChild")?a.length===b&&c.get("firstChild")&&c.get("firstChild").remove():c.appendChild(document.createTextNode(M.util.get_string("invalid","availability")))},M.core_availability.Item.prototype.renumber=function(a){var b={number:a};this.plugin?b.type=M.util.get_string("title","availability_"+this.pluginType):b.type="["+this.pluginType+"]",b.number=a+":";var c=M.util.get_string("itemheading","availability",b);this.node.one("> h3").set("innerHTML",c)},M.core_availability.Item.prototype.focusAfterAdd=function(){this.plugin.focusAfterAdd(this.pluginNode)},M.core_availability.Item.prototype.pluginType=null,M.core_availability.Item.prototype.plugin=null,M.core_availability.Item.prototype.eyeIcon=null,M.core_availability.Item.prototype.node=null,M.core_availability.Item.prototype.pluginNode=null,M.core_availability.EyeIcon=function(b,c){this.individual=b,this.span=a.Node.create('<a class="availability-eye col-form-label" href="#" role="button">');var d=a.Node.create("<img />");this.span.appendChild(d);var e=b?"_individual":"_all",f=function(){var a=M.util.get_string("hidden"+e,"availability");d.set("src",M.util.image_url("i/show","core")),d.set("alt",a),this.span.set("title",a+" • "+M.util.get_string("show_verb","availability"))},g=function(){var a=M.util.get_string("shown"+e,"availability");d.set("src",M.util.image_url("i/hide","core")),d.set("alt",a),this.span.set("title",a+" • "+M.util.get_string("hide_verb","availability"))};c?g.call(this):f.call(this);var h=function(a){a.preventDefault(),this.isHidden()?g.call(this):f.call(this),M.core_availability.form.update()};this.span.on("click",h,this),this.span.on("key",h,"up:32",this),this.span.on("key",function(a){a.preventDefault()},"down:32",this)},M.core_availability.EyeIcon.prototype.individual=!1,M.core_availability.EyeIcon.prototype.span=null,M.core_availability.EyeIcon.prototype.isHidden=function(){var a=this.individual?"_individual":"_all",b=M.util.get_string("hidden"+a,"availability");return this.span.one("img").get("alt")===b},M.core_availability.DeleteIcon=function(b){this.span=a.Node.create('<a class="d-inline-block col-form-label availability-delete p-x-1" href="#" title="'+M.util.get_string("delete","moodle")+'" role="button">');var c=a.Node.create('<img src="'+M.util.image_url("t/delete","core")+'" alt="'+M.util.get_string("delete","moodle")+'" />');this.span.appendChild(c);var d=function(a){a.preventDefault(),M.core_availability.form.rootList.deleteDescendant(b),M.core_availability.form.rootList.renumber()};this.span.on("click",d,this),this.span.on("key",d,"up:32",this),this.span.on("key",function(a){a.preventDefault()},"down:32",this)},M.core_availability.DeleteIcon.prototype.span=null},"@VERSION@",{requires:["base","node","event","event-delegate","panel","moodle-core-notification-dialogue","json"]});