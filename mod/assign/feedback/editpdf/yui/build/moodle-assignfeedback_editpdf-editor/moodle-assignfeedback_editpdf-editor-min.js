YUI.add("moodle-assignfeedback_editpdf-editor",function(a,b){var c=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",d=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax_progress.php",e={DIALOGUE:"assignfeedback_editpdf_widget"},f={PREVIOUSBUTTON:".navigate-previous-button",NEXTBUTTON:" .navigate-next-button",SEARCHCOMMENTSBUTTON:".searchcommentsbutton",SEARCHFILTER:".assignfeedback_editpdf_commentsearch input",SEARCHCOMMENTSLIST:".assignfeedback_editpdf_commentsearch ul",PAGESELECT:".navigate-page-select",LOADINGICON:".loading",PROGRESSBARCONTAINER:".progress-info.progress-striped",DRAWINGREGION:".drawingregion",DRAWINGCANVAS:".drawingcanvas",SAVE:".savebutton",COMMENTCOLOURBUTTON:".commentcolourbutton",COMMENTMENU:".commentdrawable a",ANNOTATIONCOLOURBUTTON:".annotationcolourbutton",DELETEANNOTATIONBUTTON:".deleteannotationbutton",UNSAVEDCHANGESDIV:".assignfeedback_editpdf_unsavedchanges",UNSAVEDCHANGESINPUT:'input[name="assignfeedback_editpdf_haschanges"]',STAMPSBUTTON:".currentstampbutton",DIALOGUE:"."+e.DIALOGUE},g="rgba(200, 200, 255, 0.9)",h="rgba(200, 200, 255, 0.5)",i="rgb(51, 51, 51)",j={white:"rgb(255,255,255)",yellow:"rgb(255,236,174)",red:"rgb(249,181,179)",green:"rgb(214,234,178)",blue:"rgb(203,217,237)",clear:"rgba(255,255,255, 0)"},k={white:"rgb(255,255,255)",yellow:"rgb(255,207,53)",red:"rgb(239,69,64)",green:"rgb(152,202,62)",blue:"rgb(125,159,211)",black:"rgb(51,51,51)"},l=300,m={comment:".commentbutton",pen:".penbutton",line:".linebutton",rectangle:".rectanglebutton",oval:".ovalbutton",stamp:".stampbutton",select:".selectbutton",drag:".dragbutton",highlight:".highlightbutton"},n=4,o=function(a,b){this.x=parseInt(a,10),this.y=parseInt(b,10),this.clip=function(a){return this.x<a.x&&(this.x=a.x),this.x>a.x+a.width&&(this.x=a.x+a.width),this.y<a.y&&(this.y=a.y),this.y>a.y+a.height&&(this.y=a.y+a.height),this}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.point=o;var p=function(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d,this.bound=function(a){var b,c=0,d=0,e=0,f=0,g=0;for(g=0;g<a.length;g++)b=a[g],(b.x<c||0===g)&&(c=b.x),(b.x>d||0===g)&&(d=b.x),(b.y<e||0===g)&&(e=b.y),(b.y>f||0===g)&&(f=b.y);return this.x=c,this.y=e,this.width=d-c,this.height=f-e,this},this.has_min_width=function(){return this.width>=5},this.has_min_height=function(){return this.height>=5},this.set_min_width=function(){this.width=5},this.set_min_height=function(){this.height=5}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.rect=p;var q=function(){this.start=!1,this.end=!1,this.starttime=0,this.annotationstart=!1,this.tool="drag",this.commentcolour="yellow",this.annotationcolour="red",this.stamp="",this.path=[]};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.edit=q;var r=function(a){this.editor=a,this.shapes=[],this.nodes=[],this.erase=function(){if(this.shapes)for(;this.shapes.length>0;)this.editor.graphic.removeShape(this.shapes.pop());if(this.nodes)for(;this.nodes.length>0;)this.nodes.pop().remove()},this.scroll_update=function(a,b){var c,d,e;for(c=0;c<this.nodes.length;c++)d=this.nodes[c].getData("x"),e=this.nodes[c].getData("y"),void 0!==d&&void 0!==e&&(this.nodes[c].setX(parseInt(d,10)-a),this.nodes[c].setY(parseInt(e,10)-b))},this.store_position=function(a,b,c){var d,e,g;d=this.editor.get_dialogue_element(f.DRAWINGREGION),e=parseInt(d.get("scrollLeft"),10),g=parseInt(d.get("scrollTop"),10),a.setData("x",b+e),a.setData("y",c+g)}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.drawable=r;var s=function(a){s.superclass.constructor.apply(this,[a])};s.NAME="annotation",s.ATTRS={},a.extend(s,a.Base,{editor:null,gradeid:0,pageno:0,x:0,y:0,endx:0,endy:0,path:"",type:"rect",colour:"red",drawable:!1,initializer:function(a){this.editor=a.editor||null,this.gradeid=parseInt(a.gradeid,10)||0,this.pageno=parseInt(a.pageno,10)||0,this.x=parseInt(a.x,10)||0,this.y=parseInt(a.y,10)||0,this.endx=parseInt(a.endx,10)||0,this.endy=parseInt(a.endy,10)||0,this.path=a.path||"",this.type=a.type||"rect",this.colour=a.colour||"red",this.drawable=!1},clean:function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),endx:parseInt(this.endx,10),endy:parseInt(this.endy,10),type:this.type,path:this.path,pageno:this.pageno,colour:this.colour}},draw_highlight:function(){var b,c,d=this.editor.get_dialogue_element(f.DRAWINGREGION),e=this.editor.get_dialogue_element(f.DRAWINGCANVAS).getXY();if(this.editor.currentannotation===this){b=new M.assignfeedback_editpdf.rect,b.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),c=this.editor.graphic.addShape({type:a.Rect,width:b.width,height:b.height,stroke:{weight:n,color:g},fill:{color:h},x:b.x,y:b.y}),this.drawable.shapes.push(c);var i=a.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),j=a.Node.create('<a href="#" role="button"></a>');i.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")}),i.setStyles({backgroundColor:"white"}),j.addClass("deleteannotationbutton"),j.append(i),d.append(j),j.setData("annotation",this),j.setStyle("zIndex","200"),j.on("click",this.remove,this),j.on("key",this.remove,"space,enter",this),j.setX(e[0]+b.x+b.width-18),j.setY(e[1]+b.y+6),this.drawable.nodes.push(j)}return this.drawable},draw:function(){return this.draw_highlight(),this.drawable},remove:function(a){var b,c;for(a.preventDefault(),b=this.editor.pages[this.editor.currentpage].annotations,c=0;c<b.length;c++)if(b[c]===this)return b.splice(c,1),this.drawable&&this.drawable.erase(),this.editor.currentannotation=!1,void this.editor.save_current_page()},move:function(b,c){var d,e,f,g,h,i=b-this.x,j=c-this.y;this.x+=i,this.y+=j,this.endx+=i,this.endy+=j,this.path&&(d=[],e=this.path.split(":"),a.each(e,function(a){f=a.split(","),g=parseInt(f[0],10),h=parseInt(f[1],10),d.push(g+i+","+(h+j))}),this.path=d.join(":")),this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())},draw_current_edit:function(a){var b=a&&!1;return b},init_from_edit:function(a){var b=new M.assignfeedback_editpdf.rect;return b.bound([a.start,a.end]),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=b.x,this.y=b.y,this.endx=b.x+b.width,this.endy=b.y+b.height,this.colour=a.annotationcolour,this.path="",b.has_min_width()&&b.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotation=s;var t=function(a){t.superclass.constructor.apply(this,[a])};t.NAME="annotationline",t.ATTRS={},a.extend(t,M.assignfeedback_editpdf.annotation,{draw:function(){var b,c;return b=new M.assignfeedback_editpdf.drawable(this.editor),c=this.editor.graphic.addShape({type:a.Path,fill:!1,stroke:{weight:n,color:k[this.colour]}}),c.moveTo(this.x,this.y),c.lineTo(this.endx,this.endy),c.end(),b.shapes.push(c),this.drawable=b,t.superclass.draw.apply(this)},draw_current_edit:function(b){var c,d=new M.assignfeedback_editpdf.drawable(this.editor);return c=this.editor.graphic.addShape({type:a.Path,fill:!1,stroke:{weight:n,color:k[b.annotationcolour]}}),c.moveTo(b.start.x,b.start.y),c.lineTo(b.end.x,b.end.y),c.end(),d.shapes.push(c),d},init_from_edit:function(a){return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=a.start.x,this.y=a.start.y,this.endx=a.end.x,this.endy=a.end.y,this.colour=a.annotationcolour,this.path="",!(this.endx-this.x===0&&this.endy-this.y===0)}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationline=t;var u=function(a){u.superclass.constructor.apply(this,[a])};u.NAME="annotationrectangle",u.ATTRS={},a.extend(u,M.assignfeedback_editpdf.annotation,{draw:function(){var b,c,d;return b=new M.assignfeedback_editpdf.drawable(this.editor),c=new M.assignfeedback_editpdf.rect,c.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),d=this.editor.graphic.addShape({type:a.Rect,width:c.width,height:c.height,stroke:{weight:n,color:k[this.colour]},x:c.x,y:c.y}),b.shapes.push(d),this.drawable=b,u.superclass.draw.apply(this)},draw_current_edit:function(b){var c,d,e=new M.assignfeedback_editpdf.drawable(this.editor);return d=new M.assignfeedback_editpdf.rect,d.bound([new M.assignfeedback_editpdf.point(b.start.x,b.start.y),new M.assignfeedback_editpdf.point(b.end.x,b.end.y)]),d.has_min_width()||d.set_min_width(),d.has_min_height()||d.set_min_height(),c=this.editor.graphic.addShape({type:a.Rect,width:d.width,height:d.height,stroke:{weight:n,color:k[b.annotationcolour]},x:d.x,y:d.y}),e.shapes.push(c),e}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationrectangle=u;var v=function(a){v.superclass.constructor.apply(this,[a])};v.NAME="annotationoval",v.ATTRS={},a.extend(v,M.assignfeedback_editpdf.annotation,{draw:function(){var b,c,d;return b=new M.assignfeedback_editpdf.drawable(this.editor),c=new M.assignfeedback_editpdf.rect,c.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),d=this.editor.graphic.addShape({type:a.Ellipse,width:c.width,height:c.height,stroke:{weight:n,color:k[this.colour]},x:c.x,y:c.y}),b.shapes.push(d),this.drawable=b,v.superclass.draw.apply(this)},draw_current_edit:function(b){var c,d,e=new M.assignfeedback_editpdf.drawable(this.editor);return d=new M.assignfeedback_editpdf.rect,d.bound([new M.assignfeedback_editpdf.point(b.start.x,b.start.y),new M.assignfeedback_editpdf.point(b.end.x,b.end.y)]),d.has_min_width()||d.set_min_width(),d.has_min_height()||d.set_min_height(),c=this.editor.graphic.addShape({type:a.Ellipse,width:d.width,height:d.height,stroke:{weight:n,color:k[b.annotationcolour]},x:d.x,y:d.y}),e.shapes.push(c),e}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationoval=v;var w=function(a){w.superclass.constructor.apply(this,[a])};w.NAME="annotationpen",w.ATTRS={},a.extend(w,M.assignfeedback_editpdf.annotation,{draw:function(){var b,c,d,e,f;return b=new M.assignfeedback_editpdf.drawable(this.editor),c=this.editor.graphic.addShape({type:a.Path,fill:!1,stroke:{weight:n,color:k[this.colour]}}),d=!0,e=this.path.split(":"),a.each(e,function(a){f=a.split(","),d?(c.moveTo(f[0],f[1]),d=!1):c.lineTo(f[0],f[1])},this),c.end(),b.shapes.push(c),this.drawable=b,w.superclass.draw.apply(this)},draw_current_edit:function(b){var c,d,e=new M.assignfeedback_editpdf.drawable(this.editor);return c=this.editor.graphic.addShape({type:a.Path,fill:!1,stroke:{weight:n,color:k[b.annotationcolour]}}),d=!0,a.each(b.path,function(a){d?(c.moveTo(a.x,a.y),d=!1):c.lineTo(a.x,a.y)},this),c.end(),e.shapes.push(c),e},init_from_edit:function(a){var b=new M.assignfeedback_editpdf.rect,c=[],d=0;for(b.bound(a.path),d=0;d<a.path.length;d++)c.push(parseInt(a.path[d].x,10)+","+parseInt(a.path[d].y,10));return this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=b.x,this.y=b.y,this.endx=b.x+b.width,this.endy=b.y+b.height,this.colour=a.annotationcolour,this.path=c.join(":"),b.has_min_width()||b.has_min_height()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationpen=w;var x=function(a){x.superclass.constructor.apply(this,[a])};x.NAME="annotationhighlight",x.ATTRS={},a.extend(x,M.assignfeedback_editpdf.annotation,{draw:function(){var b,c,d,e;return b=new M.assignfeedback_editpdf.drawable(this.editor),d=new M.assignfeedback_editpdf.rect,d.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]),e=k[this.colour],e=e.replace("rgb","rgba"),e=e.replace(")",",0.5)"),c=this.editor.graphic.addShape({type:a.Rect,width:d.width,height:d.height,stroke:!1,fill:{color:e},x:d.x,y:d.y}),b.shapes.push(c),this.drawable=b,x.superclass.draw.apply(this)},draw_current_edit:function(b){var c,d,e,f=new M.assignfeedback_editpdf.drawable(this.editor);return d=new M.assignfeedback_editpdf.rect,d.bound([new M.assignfeedback_editpdf.point(b.start.x,b.start.y),new M.assignfeedback_editpdf.point(b.end.x,b.end.y)]),d.has_min_width()||d.set_min_width(),e=k[b.annotationcolour],e=e.replace("rgb","rgba"),e=e.replace(")",",0.5)"),c=this.editor.graphic.addShape({type:a.Rect,width:d.width,height:16,stroke:!1,fill:{color:e},x:d.x,y:b.start.y}),f.shapes.push(c),f},init_from_edit:function(a){var b=new M.assignfeedback_editpdf.rect;return b.bound([a.start,a.end]),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=b.x,this.y=a.start.y,this.endx=b.x+b.width,this.endy=a.start.y+16,this.colour=a.annotationcolour,this.page="",b.has_min_width()}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationhighlight=x;var y=function(a){y.superclass.constructor.apply(this,[a])};y.NAME="annotationstamp",y.ATTRS={},a.extend(y,M.assignfeedback_editpdf.annotation,{draw:function(){var b,c,d=new M.assignfeedback_editpdf.drawable(this.editor),e=this.editor.get_dialogue_element(f.DRAWINGREGION);return c=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),b=a.Node.create("<div/>"),b.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(this.path)+")",width:this.endx-this.x,height:this.endy-this.y,backgroundSize:"100% 100%",zIndex:50}),e.append(b),b.setX(c.x),b.setY(c.y),d.store_position(b,c.x,c.y),this.editor.get("readonly")||(b.on("gesturemovestart",this.editor.edit_start,null,this.editor),b.on("gesturemove",this.editor.edit_move,null,this.editor),b.on("gesturemoveend",this.editor.edit_end,null,this.editor)),d.nodes.push(b),this.drawable=d,y.superclass.draw.apply(this)},draw_current_edit:function(b){var c,d,e=new M.assignfeedback_editpdf.rect,g=new M.assignfeedback_editpdf.drawable(this.editor),h=this.editor.get_dialogue_element(f.DRAWINGREGION);return e.bound([b.start,b.end]),d=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(e.x,e.y)),c=a.Node.create("<div/>"),c.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(b.stamp)+")",width:e.width,height:e.height,backgroundSize:"100% 100%",zIndex:50}),h.append(c),c.setX(d.x),c.setY(d.y),g.store_position(c,d.x,d.y),g.nodes.push(c),g},init_from_edit:function(a){var b=new M.assignfeedback_editpdf.rect;return b.bound([a.start,a.end]),b.width<40&&(b.width=40),b.height<40&&(b.height=40),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=b.x,this.y=b.y,this.endx=b.x+b.width,this.endy=b.y+b.height,this.colour=a.annotationcolour,this.path=a.stamp,!0},move:function(a,b){var c=a-this.x,d=b-this.y;this.x+=c,this.y+=d,this.endx+=c,this.endy+=d,this.drawable&&this.drawable.erase(),this.editor.drawables.push(this.draw())}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.annotationstamp=y;var z,A="Dropdown menu";z=function(a){a.draggable=!1,a.centered=!1,a.width="auto",a.visible=!1,a.footerContent="",z.superclass.constructor.apply(this,[a])},a.extend(z,M.core.dialogue,{initializer:function(b){var c,d,e,f;z.superclass.initializer.call(this,b),f=this.get("boundingBox"),f.addClass("assignfeedback_editpdf_dropdown"),c=this.get("buttonNode"),d=this.bodyNode,e=a.Node.create("<h3/>"),e.addClass("accesshide"),e.setHTML(this.get("headerText")),d.prepend(e),d.on("clickoutside",function(a){this.get("visible")&&a.target.get("id")!==c.get("id")&&a.target.ancestor().get("id")!==c.get("id")&&(a.preventDefault(),this.hide())},this),c.on("click",function(a){a.preventDefault(),this.show()},this),c.on("key",this.show,"enter,space",this)},show:function(){var b=this.get("buttonNode"),c=z.superclass.show.call(this);return this.align(b,[a.WidgetPositionAlign.TL,a.WidgetPositionAlign.BL]),c}},{NAME:A,ATTRS:{headerText:{value:""},buttonNode:{value:null}}}),a.Base.modifyAttrs(z,{modal:{getter:function(){return!1}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.dropdown=z;var B,C="Colourpicker";B=function(a){B.superclass.constructor.apply(this,[a])},a.extend(B,M.assignfeedback_editpdf.dropdown,{initializer:function(b){var c,d=a.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');a.each(this.get("colours"),function(b,c){var e,f,g,h,i;g=M.util.get_string(c,"assignfeedback_editpdf"),i=this.get("iconprefix")+c,h=M.util.image_url(i,"assignfeedback_editpdf"),e=a.Node.create('<button><img alt="'+g+'" src="'+h+'"/></button>'),e.setAttribute("data-colour",c),e.setAttribute("data-rgb",b),e.setStyle("backgroundImage","none"),f=a.Node.create("<li/>"),f.append(e),d.append(f)},this),c=a.Node.create("<div/>"),d.delegate("click",this.callback_handler,"button",this),d.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf")),c.append(d),this.set("bodyContent",c),B.superclass.initializer.call(this,b)},callback_handler:function(b){b.preventDefault();var c,d=this.get("callback"),e=this.get("context");this.hide(),(c=a.bind(d,e,b))()}},{NAME:C,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null},iconprefix:{value:"colour_"}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.colourpicker=B;var D,E="Colourpicker";D=function(a){D.superclass.constructor.apply(this,[a])},a.extend(D,M.assignfeedback_editpdf.dropdown,{initializer:function(b){var c=a.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');a.each(this.get("stamps"),function(b){var d,e,f;f=M.util.get_string("stamp","assignfeedback_editpdf"),d=a.Node.create('<button><img height="16" width="16" alt="'+f+'" src="'+b+'"/></button>'),d.setAttribute("data-stamp",b),d.setStyle("backgroundImage","none"),e=a.Node.create("<li/>"),e.append(d),c.append(e)},this),c.delegate("click",this.callback_handler,"button",this),c.delegate("key",this.callback_handler,"down:13","button",this),this.set("headerText",M.util.get_string("stamppicker","assignfeedback_editpdf")),this.set("bodyContent",c),D.superclass.initializer.call(this,b)},callback_handler:function(b){b.preventDefault();var c,d=this.get("callback"),e=this.get("context");this.hide(),(c=a.bind(d,e,b))()}},{NAME:E,ATTRS:{stamps:{value:[]},callback:{value:null},context:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.stamppicker=D;var F,G="Commentmenu";F=function(a){F.superclass.constructor.apply(this,[a])},a.extend(F,M.assignfeedback_editpdf.dropdown,{initializer:function(b){var c,d,e,f;f=this.get("comment"),c=a.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),d=a.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>"),d.on("click",f.add_to_quicklist,f),d.on("key",f.add_to_quicklist,"enter,space",f),c.append(d),d=a.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>"),d.on("click",function(a){a.preventDefault(),this.menu.hide(),this.remove()},f),d.on("key",function(){f.menu.hide(),f.remove()},"enter,space",f),c.append(d),d=a.Node.create("<li><hr/></li>"),c.append(d),this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf")),e=a.Node.create("<div/>"),e.append(c),this.set("bodyContent",e),F.superclass.initializer.call(this,b)},show:function(){var b=this.get("boundingBox").one("ul");b.all(".quicklist_comment").remove(!0);var c=this.get("comment");c.deleteme=!1,a.each(c.editor.quicklist.comments,function(d){var e=a.Node.create('<li class="quicklist_comment"></li>'),f=a.Node.create('<a href="#" tabindex="-1">'+d.rawtext+"</a>"),g=a.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/></a>');e.append(f),e.append(g),b.append(e),f.on("click",c.set_from_quick_comment,c,d),f.on("key",c.set_from_quick_comment,"space,enter",c,d),g.on("click",c.remove_from_quicklist,c,d),g.on("key",c.remove_from_quicklist,"space,enter",c,d)},this),F.superclass.show.call(this)}},{NAME:G,ATTRS:{comment:{value:null}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentmenu=F;var H,I="commentsearch";H=function(a){a.draggable=!1,a.centered=!0,a.width="400px",a.visible=!1,a.headerContent=M.util.get_string("searchcomments","assignfeedback_editpdf"),a.footerContent="",H.superclass.constructor.apply(this,[a])},a.extend(H,M.core.dialogue,{initializer:function(b){var c,d,e,f,g,h;h=this.get("boundingBox"),h.addClass("assignfeedback_editpdf_commentsearch"),c=this.get("editor"),d=a.Node.create("<div/>"),e=M.util.get_string("filter","assignfeedback_editpdf"),f=a.Node.create('<input type="text" size="20" placeholder="'+e+'"/>'),d.append(f),g=a.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),d.append(g),f.on("keyup",this.filter_search_comments,this),g.delegate("click",this.focus_on_comment,"a",this),g.delegate("key",this.focus_on_comment,"enter,space","a",this),this.set("bodyContent",d),H.superclass.initializer.call(this,b)},filter_search_comments:function(){var b,c,d,e;e=this.get("id"),b=a.one("#"+e+f.SEARCHFILTER),c=a.one("#"+e+f.SEARCHCOMMENTSLIST),d=b.get("value"),c.all("li").each(function(a){a.get("text").indexOf(d)!==-1?a.show():a.hide()})},focus_on_comment:function(a){a.preventDefault();var b=a.target.ancestor("li"),c=b.getData("comment"),d=this.get("editor"),e=d.get_dialogue_element(f.PAGESELECT);this.hide(),d.currentpage=parseInt(e.get("value"),10),c.pageno!==d.currentpage&&(d.currentpage=c.pageno,d.change_page()),c.drawable.nodes[0].one("textarea").focus()},show:function(){var b=this.get("boundingBox").one("ul"),c=this.get("editor");b.all("li").remove(!0),a.each(c.pages,function(c){a.each(c.comments,function(c){var d=a.Node.create('<li><a href="#" tabindex="-1"><pre>'+c.rawtext+"</pre></a></li>");b.append(d),d.setData("comment",c)},this)},this),this.centerDialogue(),H.superclass.show.call(this)}},{NAME:I,ATTRS:{editor:{value:null}}}),a.Base.modifyAttrs(H,{modal:{getter:function(){return!0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.commentsearch=H;var J=function(b,c,d,e,g,h,k,l){this.editor=b,this.gradeid=c||0,this.x=parseInt(e,10)||0,this.y=parseInt(g,10)||0,this.width=parseInt(h,10)||0,this.rawtext=l||"",this.pageno=d||0,this.colour=k||"yellow",this.drawable=!1,this.deleteme=!1,this.menulink=null,this.menu=null,this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:this.currentpage,colour:this.colour}},this.draw=function(b){var c,d,e,g,h,k=new M.assignfeedback_editpdf.drawable(this.editor),l=this.editor.get_dialogue_element(f.DRAWINGREGION);return c=a.Node.create("<textarea/>"),d=a.Node.create('<div class="commentdrawable"/>'),e=a.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>'),this.menulink=e,d.append(c),this.editor.get("readonly")?c.setAttribute("readonly","readonly"):d.append(e),this.width<100&&(this.width=100),g=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y)),c.setStyles({width:this.width+"px",backgroundColor:j[this.colour],color:i}),l.append(d),d.setStyle("position","absolute"),d.setX(g.x),d.setY(g.y),k.store_position(d,g.x,g.y),k.nodes.push(d),c.set("value",this.rawtext),h=c.get("scrollHeight"),c.setStyles({height:h+"px",overflow:"hidden"}),this.editor.get("readonly")||this.attach_events(c,e),b&&c.focus(),this.drawable=k,k},this.delete_comment_later=function(){this.deleteme&&this.remove()},this.attach_events=function(c,d){c.on("blur",function(){this.rawtext=c.get("value"),this.width=parseInt(c.getStyle("width"),10),""===this.rawtext.replace(/^\s+|\s+$/g,"")&&(this.deleteme=!0,a.later(400,this,this.delete_comment_later)),this.editor.save_current_page(),this.editor.editingcomment=!1},this),d.setData("comment",this),c.on("keyup",function(){var a=c.get("scrollHeight"),b=parseInt(c.getStyle("height"),10);a===b+8&&(a-=8),c.setStyle("height",a+"px")}),c.on("gesturemovestart",function(a){"select"===b.currentedit.tool&&(a.preventDefault(),c.setData("dragging",!0),c.setData("offsetx",a.clientX-c.getX()),c.setData("offsety",a.clientY-c.getY()))}),c.on("gesturemoveend",function(){"select"===b.currentedit.tool&&(c.setData("dragging",!1),this.editor.save_current_page())},null,this),c.on("gesturemove",function(a){if("select"===b.currentedit.tool){var d,e,f,g,h,i=a.clientX-c.getData("offsetx"),j=a.clientY-c.getData("offsety");d=parseInt(c.getStyle("width"),10),e=parseInt(c.getStyle("height"),10),f=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(i,j)),h=this.editor.get_canvas_bounds(!0),h.x=0,h.y=0,h.width-=d+42,h.height-=e+8,f.clip(h),this.x=f.x,this.y=f.y,g=this.editor.get_window_coordinates(f),c.ancestor().setX(g.x),c.ancestor().setY(g.y),this.drawable.store_position(c.ancestor(),g.x,g.y)}},null,this),this.menu=new M.assignfeedback_editpdf.commentmenu({buttonNode:this.menulink,comment:this})},this.remove=function(){var a,b=0;for(a=this.editor.pages[this.editor.currentpage].comments,b=0;b<a.length;b++)if(a[b]===this)return a.splice(b,1),this.drawable.erase(),void this.editor.save_current_page()},this.remove_from_quicklist=function(a,b){a.preventDefault(),this.menu.hide(),this.editor.quicklist.remove(b)},this.set_from_quick_comment=function(a,b){a.preventDefault(),this.menu.hide(),this.rawtext=b.rawtext,this.width=b.width,this.colour=b.colour,this.editor.save_current_page(),this.editor.redraw()},this.add_to_quicklist=function(a){a.preventDefault(),this.menu.hide(),this.editor.quicklist.add(this)},this.draw_current_edit=function(b){var c,d,e=new M.assignfeedback_editpdf.drawable(this.editor);return d=new M.assignfeedback_editpdf.rect,d.bound([b.start,b.end]),c=this.editor.graphic.addShape({type:a.Rect,width:d.width,height:d.height,fill:{color:j[b.commentcolour]},x:d.x,y:d.y}),e.shapes.push(c),e},this.init_from_edit=function(a){var b=new M.assignfeedback_editpdf.rect;return b.bound([a.start,a.end]),b.width<100&&(b.width=100),this.gradeid=this.editor.get("gradeid"),this.pageno=this.editor.currentpage,this.x=b.x,this.y=b.y,this.width=b.width,this.colour=a.commentcolour,this.rawtext="",b.has_min_width()&&b.has_min_height()}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.comment=J;var K=function(a,b,c,d){this.rawtext=b||"",this.id=a||0,this.width=c||100,this.colour=d||"yellow"};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcomment=K;var L=function(b){this.editor=b,this.comments=[],this.add=function(b){var d,e=c;""!==b.rawtext&&(d={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.editor.get("userid"),commenttext:b.rawtext,width:b.width,colour:b.colour,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(b,c){var d,e;try{if(d=a.JSON.parse(c.responseText),d.error)return new M.core.ajaxException(d);e=new M.assignfeedback_editpdf.quickcomment(d.id,d.rawtext,d.width,d.colour),this.comments.push(e)}catch(f){return new M.core.exception(f)}},failure:function(a,b){return M.core.exception(b.responseText)}}},a.io(e,d))},this.remove=function(b){var d,e=c;b&&(d={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.editor.get("userid"),commentid:b.id,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(){var a;a=this.comments.indexOf(b),a>=0&&this.comments.splice(a,1)},failure:function(a,b){return M.core.exception(b.responseText)}}},a.io(e,d))},this.load=function(){var b,d=c;b={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.editor.get("userid"),attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(b,c){var d;try{if(d=a.JSON.parse(c.responseText),d.error)return new M.core.ajaxException(d);a.each(d,function(a){var b=new M.assignfeedback_editpdf.quickcomment(a.id,a.rawtext,a.width,a.colour);this.comments.push(b)},this)}catch(e){return new M.core.exception(e)}},failure:function(a,b){return M.core.exception(b.responseText)}}},a.io(d,b)}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.quickcommentlist=L;var N=function(){N.superclass.constructor.apply(this,arguments)};N.prototype={dialogue:null,panel:null,pagecount:0,currentpage:0,pages:[],loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit,currentdrawable:!1,drawables:[],currentcomment:null,currentannotation:null,lastanntationtool:"pen",quicklist:null,searchcommentswindow:null,currentstamp:null,stamps:[],editingcomment:!1,initializer:function(){var b;b=a.one("#"+this.get("linkid")),b&&(b.on("click",this.link_handler,this),b.on("key",this.link_handler,"down:13",this),require(["mod_assign/grading_review_panel"],function(c){var d=new c,e=d.getReviewPanel("assignfeedback_editpdf");e&&(e=a.one(e),e.empty(),b.ancestor(".fitem").hide(),this.open_in_panel(e)),this.currentedit.start=!1,this.currentedit.end=!1,this.get("readonly")||(this.quicklist=new M.assignfeedback_editpdf.quickcommentlist(this))}.bind(this)))},refresh_button_state:function(){var a,b,c,d;a=this.get_dialogue_element(f.COMMENTCOLOURBUTTON),c=M.util.image_url("background_colour_"+this.currentedit.commentcolour,"assignfeedback_editpdf"),a.one("img").setAttribute("src",c),"clear"===this.currentedit.commentcolour?a.one("img").setStyle("borderStyle","dashed"):a.one("img").setStyle("borderStyle","solid"),a=this.get_dialogue_element(f.ANNOTATIONCOLOURBUTTON),c=M.util.image_url("colour_"+this.currentedit.annotationcolour,"assignfeedback_editpdf"),a.one("img").setAttribute("src",c),b=this.get_dialogue_element(m[this.currentedit.tool]),b.addClass("assignfeedback_editpdf_selectedbutton"),b.setAttribute("aria-pressed","true"),d=this.get_dialogue_element(f.DRAWINGREGION),d.setAttribute("data-currenttool",this.currentedit.tool),a=this.get_dialogue_element(f.STAMPSBUTTON),a.one("img").setAttrs({src:this.get_stamp_image_url(this.currentedit.stamp),height:"16",width:"16"})},get_canvas_bounds:function(){var a=this.get_dialogue_element(f.DRAWINGCANVAS),b=a.getXY(),c=b[0],d=b[1],e=parseInt(a.getStyle("width"),10),g=parseInt(a.getStyle("height"),10);return new M.assignfeedback_editpdf.rect(c,d,e,g)},get_canvas_coordinates:function(a){var b=this.get_canvas_bounds(),c=new M.assignfeedback_editpdf.point(a.x-b.x,a.y-b.y);return b.x=b.y=0,c.clip(b),c},get_window_coordinates:function(a){var b=this.get_canvas_bounds(),c=new M.assignfeedback_editpdf.point(a.x+b.x,a.y+b.y);return c},open_in_panel:function(b){var c,d;this.panel=b,b.append(this.get("body")),b.addClass(e.DIALOGUE),this.loadingicon=this.get_dialogue_element(f.LOADINGICON),c=this.get_dialogue_element(f.DRAWINGCANVAS),this.graphic=new a.Graphic({render:c}),d=this.get_dialogue_element(f.DRAWINGREGION),d.on("scroll",this.move_canvas,this),this.get("readonly")||(c.on("gesturemovestart",this.edit_start,null,this),c.on("gesturemove",this.edit_move,null,this),c.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.load_all_pages()},link_handler:function(b){var c,d,g=!0;b.preventDefault(),this.dialogue||(this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),modal:!0,width:"840px",visible:!1,draggable:!0}),this.dialogue.get("boundingBox").addClass(e.DIALOGUE),this.loadingicon=this.get_dialogue_element(f.LOADINGICON),c=this.get_dialogue_element(f.DRAWINGCANVAS),this.graphic=new a.Graphic({render:c}),d=this.get_dialogue_element(f.DRAWINGREGION),d.on("scroll",this.move_canvas,this),
this.get("readonly")||(c.on("gesturemovestart",this.edit_start,null,this),c.on("gesturemove",this.edit_move,null,this),c.on("gesturemoveend",this.edit_end,null,this),this.refresh_button_state()),this.load_all_pages(),c.on("windowresize",this.resize,this),g=!1),this.dialogue.centerDialogue(),this.dialogue.show(),this.dialogue.dd.on("drag:end",this.redraw,this),g&&this.resize()},load_all_pages:function(){var b,e,g,h=c;b={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"loadallpages",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(a,b){this.all_pages_loaded(b.responseText)},failure:function(a,b){return new M.core.exception(b.responseText)}}},a.io(h,b),this.pagecount<=0&&(e={method:"get",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"conversionstatus",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(b,c){if(g=0,0===this.pagecount){var h=this.get("pagetotal"),i=this.get_dialogue_element(f.PROGRESSBARCONTAINER),j=i.one(".bar");if(j){var k=c.response/h*100;j.setStyle("width",k+"%"),i.setAttribute("aria-valuenow",k)}M.util.js_pending("checkconversionstatus"),a.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),a.io(d,e)})}},failure:function(b,c){return g+=1,0===this.pagecount&&g<5&&(M.util.js_pending("checkconversionstatus"),a.later(1e3,this,function(){M.util.js_complete("checkconversionstatus"),a.io(d,e)})),new M.core.exception(c.responseText)}}},M.util.js_pending("checkconversionstatus"),a.later(1e3,this,function(){g=0,M.util.js_complete("checkconversionstatus"),a.io(d,e)}))},all_pages_loaded:function(b){var c,d,e,f,g;try{if(c=a.JSON.parse(b),c.error||!c.pagecount)return this.dialogue&&this.dialogue.hide(),g=new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf")}),void g.show()}catch(h){return this.dialogue&&this.dialogue.hide(),g=new M.core.alert({title:M.util.get_string("cannotopenpdf","assignfeedback_editpdf")}),void g.show()}for(this.pagecount=c.pagecount,this.pages=c.pages,d=0;d<this.pages.length;d++){for(e=0;e<this.pages[d].comments.length;e++)f=this.pages[d].comments[e],this.pages[d].comments[e]=new M.assignfeedback_editpdf.comment(this,f.gradeid,f.pageno,f.x,f.y,f.width,f.colour,f.rawtext);for(e=0;e<this.pages[d].annotations.length;e++)c=this.pages[d].annotations[e],this.pages[d].annotations[e]=this.create_annotation(c.type,c)}this.quicklist&&this.quicklist.load(),this.setup_navigation(),this.setup_toolbar(),this.change_page()},get_stamp_image_url:function(b){var c=this.get("stampfiles"),d="";return a.Array.each(c,function(a){a.indexOf(b)>0&&(d=a)},this),d},setup_toolbar:function(){var b,c,d,e,g,h,i,l;e=this.get_dialogue_element(f.SEARCHCOMMENTSBUTTON),e.on("click",this.open_search_comments,this),e.on("key",this.open_search_comments,"down:13",this),this.get("readonly")||(a.each(m,function(a,c){b=this.get_dialogue_element(a),b.on("click",this.handle_tool_button,this,c),b.on("key",this.handle_tool_button,"down:13",this,c),b.setAttribute("aria-pressed","false")},this),c=this.get_dialogue_element(f.COMMENTCOLOURBUTTON),i=new M.assignfeedback_editpdf.colourpicker({buttonNode:c,colours:j,iconprefix:"background_colour_",callback:function(a){var b=a.target.getAttribute("data-colour");b||(b=a.target.ancestor().getAttribute("data-colour")),this.currentedit.commentcolour=b,this.handle_tool_button(a,"comment")},context:this}),d=this.get_dialogue_element(f.ANNOTATIONCOLOURBUTTON),i=new M.assignfeedback_editpdf.colourpicker({buttonNode:d,iconprefix:"colour_",colours:k,callback:function(a){var b=a.target.getAttribute("data-colour");b||(b=a.target.ancestor().getAttribute("data-colour")),this.currentedit.annotationcolour=b,this.lastannotationtool?this.handle_tool_button(a,this.lastannotationtool):this.handle_tool_button(a,"pen")},context:this}),h=this.get("stampfiles"),h.length<=0?this.get_dialogue_element(m.stamp).ancestor().hide():(l=h[0].substr(h[0].lastIndexOf("/")+1),this.currentedit.stamp=l,g=this.get_dialogue_element(f.STAMPSBUTTON),i=new M.assignfeedback_editpdf.stamppicker({buttonNode:g,stamps:h,callback:function(a){var b,c=a.target.getAttribute("data-stamp");c||(c=a.target.ancestor().getAttribute("data-stamp")),b=c.substr(c.lastIndexOf("/")),this.currentedit.stamp=b,this.handle_tool_button(a,"stamp")},context:this}),this.refresh_button_state()))},handle_tool_button:function(a,b){var c;a.preventDefault(),c=this.get_dialogue_element(m[this.currentedit.tool]),c.removeClass("assignfeedback_editpdf_selectedbutton"),c.setAttribute("aria-pressed","false"),this.currentedit.tool=b,"comment"!==b&&"select"!==b&&"drag"!==b&&"stamp"!==b&&(this.lastannotationtool=b),this.refresh_button_state()},stringify_current_page:function(){var b,c=[],d=[],e=0;for(e=0;e<this.pages[this.currentpage].comments.length;e++)c[e]=this.pages[this.currentpage].comments[e].clean();for(e=0;e<this.pages[this.currentpage].annotations.length;e++)d[e]=this.pages[this.currentpage].annotations[e].clean();return b={comments:c,annotations:d},a.JSON.stringify(b)},get_current_drawable:function(){var a,b,c=!1;return!(!this.currentedit.start||!this.currentedit.end)&&("comment"===this.currentedit.tool?(a=new M.assignfeedback_editpdf.comment(this),c=a.draw_current_edit(this.currentedit)):(b=this.create_annotation(this.currentedit.tool,{}),b&&(c=b.draw_current_edit(this.currentedit))),c)},get_dialogue_element:function(a){return this.panel?this.panel.one(a):this.dialogue.get("boundingBox").one(a)},redraw_current_edit:function(){this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=this.get_current_drawable()},edit_start:function(b){b.preventDefault();var c,d=this.get_dialogue_element(f.DRAWINGCANVAS),e=d.getXY(),g=d.get("docScrollY"),h=d.get("docScrollX"),i={x:b.clientX-e[0]+h,y:b.clientY-e[1]+g},j=!1;if(3!==b.button&&!this.currentedit.starttime&&!this.editingcomment){if(this.currentedit.starttime=(new Date).getTime(),this.currentedit.start=i,this.currentedit.end={x:i.x,y:i.y},"select"===this.currentedit.tool){var k=this.currentedit.end.x,l=this.currentedit.end.y,m=this.pages[this.currentpage].annotations;a.each(m,function(a){(k-a.x)*(k-a.endx)<=0&&(l-a.y)*(l-a.endy)<=0&&(j=a)}),j&&(c=this.currentannotation,this.currentannotation=j,c&&c!==j&&c.drawable&&(c.drawable.erase(),this.drawables.push(c.draw())),this.currentannotation.drawable&&this.currentannotation.drawable.erase(),this.drawables.push(this.currentannotation.draw()))}this.currentannotation&&(this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y})}},edit_move:function(a){a.preventDefault();var b,c,d=this.get_canvas_bounds(),e=this.get_dialogue_element(f.DRAWINGCANVAS),g=this.get_dialogue_element(f.DRAWINGREGION),h=new M.assignfeedback_editpdf.point(a.clientX+e.get("docScrollX"),a.clientY+e.get("docScrollY")),i=this.get_canvas_coordinates(h);i.x<0||i.x>d.width||i.y<0||i.y>d.height||("pen"===this.currentedit.tool&&this.currentedit.path.push(i),"select"===this.currentedit.tool?this.currentannotation&&this.currentedit&&this.currentannotation.move(this.currentedit.annotationstart.x+i.x-this.currentedit.start.x,this.currentedit.annotationstart.y+i.y-this.currentedit.start.y):"drag"===this.currentedit.tool?(b=i.x-this.currentedit.start.x,c=i.y-this.currentedit.start.y,g.getDOMNode().scrollLeft-=b,g.getDOMNode().scrollTop-=c):this.currentedit.start&&(this.currentedit.end=i,this.redraw_current_edit()))},edit_end:function(){var a,b,c;a=(new Date).getTime()-this.currentedit.start,a<l||this.currentedit.start===!1||("comment"===this.currentedit.tool?(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,b=new M.assignfeedback_editpdf.comment(this),b.init_from_edit(this.currentedit)&&(this.pages[this.currentpage].comments.push(b),this.drawables.push(b.draw(!0)),this.editingcomment=!0)):(c=this.create_annotation(this.currentedit.tool,{}),c&&(this.currentdrawable&&this.currentdrawable.erase(),this.currentdrawable=!1,c.init_from_edit(this.currentedit)&&(this.pages[this.currentpage].annotations.push(c),this.drawables.push(c.draw())))),this.save_current_page(),this.currentedit.starttime=0,this.currentedit.start=!1,this.currentedit.end=!1,this.currentedit.path=[])},resize:function(){var b,c;if(this.dialogue){if(!this.dialogue.get("visible"))return;this.dialogue.centerDialogue()}return c=a.one("body").get("winHeight")-120,c<100&&(c=100),b=this.get_dialogue_element(f.DRAWINGREGION),this.dialogue&&b.setStyle("maxHeight",c+"px"),this.redraw(),!0},create_annotation:function(a,b){return b.type=a,b.editor=this,"line"===a?new M.assignfeedback_editpdf.annotationline(b):"rectangle"===a?new M.assignfeedback_editpdf.annotationrectangle(b):"oval"===a?new M.assignfeedback_editpdf.annotationoval(b):"pen"===a?new M.assignfeedback_editpdf.annotationpen(b):"highlight"===a?new M.assignfeedback_editpdf.annotationhighlight(b):"stamp"===a&&new M.assignfeedback_editpdf.annotationstamp(b)},save_current_page:function(){var b,d=c,e=this.get_dialogue_element(f.PAGESELECT);this.currentpage=parseInt(e.get("value"),10),b={method:"post",context:this,sync:!1,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),page:this.stringify_current_page()},on:{success:function(b,c){var d;try{if(d=a.JSON.parse(c.responseText),d.error)return new M.core.ajaxException(d);a.one(f.UNSAVEDCHANGESINPUT).set("value","true"),a.one(f.UNSAVEDCHANGESDIV).setStyle("opacity",1),a.one(f.UNSAVEDCHANGESDIV).setStyle("display","inline-block"),a.one(f.UNSAVEDCHANGESDIV).transition({duration:1,delay:2,opacity:0},function(){a.one(f.UNSAVEDCHANGESDIV).setStyle("display","none")})}catch(e){return new M.core.exception(e)}},failure:function(a,b){return new M.core.exception(b.responseText)}}},a.io(d,b)},open_search_comments:function(a){this.searchcommentswindow||(this.searchcommentswindow=new M.assignfeedback_editpdf.commentsearch({editor:this})),this.searchcommentswindow.show(),a.preventDefault()},redraw:function(){var a,b;if(b=this.pages[this.currentpage],void 0!==b){for(;this.drawables.length>0;)this.drawables.pop().erase();for(a=0;a<b.annotations.length;a++)this.drawables.push(b.annotations[a].draw());for(a=0;a<b.comments.length;a++)this.drawables.push(b.comments[a].draw(!1))}},change_page:function(){var a,b,c,d=this.get_dialogue_element(f.DRAWINGCANVAS);b=this.get_dialogue_element(f.PREVIOUSBUTTON),c=this.get_dialogue_element(f.NEXTBUTTON),this.currentpage>0?b.removeAttribute("disabled"):b.setAttribute("disabled","true"),this.currentpage<this.pagecount-1?c.removeAttribute("disabled"):c.setAttribute("disabled","true"),a=this.pages[this.currentpage],this.loadingicon.hide(),d.setStyle("backgroundImage",'url("'+a.url+'")'),d.setStyle("width",a.width+"px"),d.setStyle("height",a.height+"px"),this.get_dialogue_element(f.PAGESELECT).set("selectedIndex",this.currentpage),this.resize()},setup_navigation:function(){var b,c,d,e,g,h;b=this.get_dialogue_element(f.PAGESELECT);var i=b.all("option");if(i.size()<=1)for(c=0;c<this.pages.length;c++)e=a.Node.create("<option/>"),e.setAttribute("value",c),d={page:c+1,total:this.pages.length},e.setHTML(M.util.get_string("pagexofy","assignfeedback_editpdf",d)),b.append(e);b.removeAttribute("disabled"),b.on("change",function(){this.currentpage=b.get("value"),this.change_page()},this),g=this.get_dialogue_element(f.PREVIOUSBUTTON),h=this.get_dialogue_element(f.NEXTBUTTON),g.on("click",this.previous_page,this),g.on("key",this.previous_page,"down:13",this),h.on("click",this.next_page,this),h.on("key",this.next_page,"down:13",this)},previous_page:function(a){a.preventDefault();var b=this.get_dialogue_element(f.PAGESELECT);this.currentpage=parseInt(b.get("value"),10)-1,this.currentpage<0&&(this.currentpage=0),this.change_page()},next_page:function(a){a.preventDefault();var b=this.get_dialogue_element(f.PAGESELECT);this.currentpage=parseInt(b.get("value"),10)+1,this.currentpage>=this.pages.length&&(this.currentpage=this.pages.length-1),this.change_page()},move_canvas:function(){var a,b,c,d;for(a=this.get_dialogue_element(f.DRAWINGREGION),b=parseInt(a.get("scrollLeft"),10),c=parseInt(a.get("scrollTop"),10),d=0;d<this.drawables.length;d++)this.drawables[d].scroll_update(b,c)}},a.extend(N,a.Base,N.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:a.Lang.isInteger,value:0},assignmentid:{validator:a.Lang.isInteger,value:0},attemptnumber:{validator:a.Lang.isInteger,value:0},header:{validator:a.Lang.isString,value:""},body:{validator:a.Lang.isString,value:""},footer:{validator:a.Lang.isString,value:""},linkid:{validator:a.Lang.isString,value:""},deletelinkid:{validator:a.Lang.isString,value:""},readonly:{validator:a.Lang.isBoolean,value:!0},stampfiles:{validator:a.Lang.isArray,value:""},pagetotal:{validator:a.Lang.isInteger,value:0}}}),M.assignfeedback_editpdf=M.assignfeedback_editpdf||{},M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{},M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(a){return M.assignfeedback_editpdf.instance=new N(a),M.assignfeedback_editpdf.instance}},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","event-resize","transition","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});