YUI.add("moodle-mod_quiz-toolboxes",function(a,b){var c={ACTIVITYINSTANCE:"activityinstance",AVAILABILITYINFODIV:"div.availabilityinfo",CONTENTWITHOUTLINK:"contentwithoutlink",CONDITIONALHIDDEN:"conditionalhidden",DIMCLASS:"dimmed",DIMMEDTEXT:"dimmed_text",EDITINSTRUCTIONS:"editinstructions",EDITINGMAXMARK:"editor_displayed",HIDE:"hide",JOIN:"page_join",MODINDENTCOUNT:"mod-indent-",MODINDENTHUGE:"mod-indent-huge",PAGE:"page",SECTIONHIDDENCLASS:"hidden",SECTIONIDPREFIX:"section-",SLOT:"slot",SHOW:"editing_show",TITLEEDITOR:"titleeditor"},d={ACTIONAREA:".actions",ACTIONLINKTEXT:".actionlinktext",ACTIVITYACTION:"a.cm-edit-action[data-action], a.editing_maxmark, a.editing_section, input.shuffle_questions",ACTIVITYFORM:"span.instancemaxmarkcontainer form",ACTIVITYINSTANCE:"."+c.ACTIVITYINSTANCE,SECTIONINSTANCE:".sectioninstance",ACTIVITYLI:"li.activity, li.section",ACTIVITYMAXMARK:"input[name=maxmark]",COMMANDSPAN:".commands",CONTENTAFTERLINK:"div.contentafterlink",CONTENTWITHOUTLINK:"div.contentwithoutlink",DELETESECTIONICON:"a.editing_delete img",EDITMAXMARK:"a.editing_maxmark",EDITSECTION:"a.editing_section",EDITSECTIONICON:"a.editing_section img",EDITSHUFFLEQUESTIONSACTION:"input.cm-edit-action[data-action]",EDITSHUFFLEAREA:".instanceshufflequestions .shuffle-progress",HIDE:"a.editing_hide",HIGHLIGHT:"a.editing_highlight",INSTANCENAME:"span.instancename",INSTANCEMAXMARK:"span.instancemaxmark",INSTANCESECTION:"span.instancesection",INSTANCESECTIONAREA:"div.section-heading",MODINDENTDIV:".mod-indent",MODINDENTOUTER:".mod-indent-outer",NUMQUESTIONS:".numberofquestions",PAGECONTENT:"div#page-content",PAGELI:"li.page",SECTIONUL:"ul.section",SECTIONFORM:".instancesectioncontainer form",SECTIONINPUT:"input[name=section]",SHOW:"a."+c.SHOW,SLOTLI:"li.slot",SUMMARKS:".mod_quiz_summarks"},e=a.one(document.body);M.mod_quiz=M.mod_quiz||{};var f=function(){f.superclass.constructor.apply(this,arguments)};a.extend(f,a.Base,{send_request:function(b,c,e,f){b||(b={});var g,h=this.get("config").pageparams;for(g in h)b[g]=h[g];b.sesskey=M.cfg.sesskey,b.courseid=this.get("courseid"),b.quizid=this.get("quizid");var i=M.cfg.wwwroot+this.get("ajaxurl"),j=[],k={method:"POST",data:b,on:{success:function(b,f){try{j=a.JSON.parse(f.responseText),j.error&&new M.core.ajaxException(j)}catch(g){}j.hasOwnProperty("newsummarks")&&a.one(d.SUMMARKS).setHTML(j.newsummarks),j.hasOwnProperty("newnumquestions")&&a.one(d.NUMQUESTIONS).setHTML(M.util.get_string("numquestionsx","quiz",j.newnumquestions)),e&&a.bind(e,this,j)(),c&&window.setTimeout(function(){c.hide()},400)},failure:function(a,b){c&&c.hide(),new M.core.ajaxException(b)}},context:this};if(f)for(g in f)k[g]=f[g];return c&&c.show(),a.io(i,k),this}},{NAME:"mod_quiz-toolbox",ATTRS:{courseid:{value:0},quizid:{value:0},ajaxurl:{value:null},config:{value:{}}}});var g=function(){g.superclass.constructor.apply(this,arguments)};a.extend(g,f,{editmaxmarkevents:[],NODE_PAGE:1,NODE_SLOT:2,NODE_JOIN:3,initializer:function(){M.mod_quiz.quizbase.register_module(this),a.delegate("click",this.handle_data_action,e,d.ACTIVITYACTION,this),a.delegate("click",this.handle_data_action,e,d.DEPENDENCY_LINK,this)},handle_data_action:function(a){var b=a.target;b.test("a")||(b=b.ancestor(d.ACTIVITYACTION));var c=b.getData("action"),e=b.ancestor(d.ACTIVITYLI);if(b.test("a")&&c&&e)switch(c){case"editmaxmark":this.edit_maxmark(a,b,e,c);break;case"delete":this.delete_with_confirmation(a,b,e,c);break;case"addpagebreak":case"removepagebreak":this.update_page_break(a,b,e,c);break;case"adddependency":case"removedependency":this.update_dependency(a,b,e,c)}},add_spinner:function(b){var c=b.one(d.ACTIONAREA);return c?M.util.add_spinner(a,c):null},delete_with_confirmation:function(b,c,d){b.preventDefault();var e=d,f="",g=M.util.get_string("pluginname","qtype_"+e.getAttribute("class").match(/qtype_([^\s]*)/)[1]);f=M.util.get_string("confirmremovequestion","quiz",g);var h=new M.core.confirm({question:f,modal:!0});return h.on("complete-yes",function(){var c=this.add_spinner(e),d={"class":"resource",action:"DELETE",id:a.Moodle.mod_quiz.util.slot.getId(e)};this.send_request(d,c,function(c){c.deleted&&(a.Moodle.mod_quiz.util.slot.remove(e),this.reorganise_edit_page(),M.core.actionmenu&&M.core.actionmenu.instance&&M.core.actionmenu.instance.hideMenu(b))})},this),this},edit_maxmark:function(b,e,f){var g,h=f.one(d.INSTANCEMAXMARK),i=f.one(d.ACTIVITYINSTANCE),j=h.get("firstChild"),k=j.get("data"),l=k,m=h,n={"class":"resource",field:"getmaxmark",id:a.Moodle.mod_quiz.util.slot.getId(f)};b.preventDefault(),this.send_request(n,null,function(d){M.core.actionmenu&&M.core.actionmenu.instance&&M.core.actionmenu.instance.hideMenu(b),d.instancemaxmark&&(l=d.instancemaxmark);var e=a.Node.create('<form action="#" />'),h=a.Node.create('<span class="'+c.EDITINSTRUCTIONS+'" id="id_editinstructions" />').set("innerHTML",M.util.get_string("edittitleinstructions","moodle")),j=a.Node.create('<input name="maxmark" type="text" class="'+c.TITLEEDITOR+'" />').setAttrs({value:l,autocomplete:"off","aria-describedby":"id_editinstructions",maxLength:"12",size:parseInt(this.get("config").questiondecimalpoints,10)+2});e.appendChild(j),e.setData("anchor",m),i.insert(h,"before"),m.replace(e),f.addClass(c.EDITINGMAXMARK),j.focus().select(),g=j.on("blur",this.edit_maxmark_cancel,this,f,!1),this.editmaxmarkevents.push(g),g=j.on("key",this.edit_maxmark_cancel,"esc",this,f,!0),this.editmaxmarkevents.push(g),g=e.on("submit",this.edit_maxmark_submit,this,f,k),this.editmaxmarkevents.push(g)})},edit_maxmark_submit:function(b,c,e){b.preventDefault();var f=a.Lang.trim(c.one(d.ACTIVITYFORM+" "+d.ACTIVITYMAXMARK).get("value")),g=this.add_spinner(c);if(this.edit_maxmark_clear(c),c.one(d.INSTANCEMAXMARK).setContent(f),null!==f&&""!==f&&f!==e){var h={"class":"resource",field:"updatemaxmark",maxmark:f,id:a.Moodle.mod_quiz.util.slot.getId(c)};this.send_request(h,g,function(a){a.instancemaxmark&&c.one(d.INSTANCEMAXMARK).setContent(a.instancemaxmark)})}},edit_maxmark_cancel:function(a,b,c){c&&a.preventDefault(),this.edit_maxmark_clear(b)},edit_maxmark_clear:function(b){new a.EventHandle(this.editmaxmarkevents).detach();var e=b.one(d.ACTIVITYFORM),f=b.one("#id_editinstructions");e&&e.replace(e.getData("anchor")),f&&f.remove(),b.removeClass(c.EDITINGMAXMARK),a.later(100,this,function(){b.one(d.EDITMAXMARK).focus()}),a.one("input[name=maxmark")||a.one("body").append('<input type="text" name="maxmark" style="display: none">')},update_page_break:function(b,c,d,e){b.preventDefault();var f=d.next("li.activity.slot"),g=this.add_spinner(f),h="removepagebreak"===e?1:2,i={"class":"resource",field:"updatepagebreak",id:a.Moodle.mod_quiz.util.slot.getId(f),value:h};return this.send_request(i,g,function(b){if(b.slots){if("addpagebreak"===e)a.Moodle.mod_quiz.util.page.add(d);else{var c=d.next(a.Moodle.mod_quiz.util.page.SELECTORS.PAGE);a.Moodle.mod_quiz.util.page.remove(c,!0)}this.reorganise_edit_page()}}),this},update_dependency:function(b,c,d,e){b.preventDefault();var f=this.add_spinner(d),g={"class":"resource",field:"updatedependency",id:a.Moodle.mod_quiz.util.slot.getId(d),value:"adddependency"===e?1:0};return this.send_request(g,f,function(b){b.hasOwnProperty("requireprevious")&&a.Moodle.mod_quiz.util.slot.updateDependencyIcon(d,b.requireprevious)}),this},reorganise_edit_page:function(){a.Moodle.mod_quiz.util.slot.reorderSlots(),a.Moodle.mod_quiz.util.slot.reorderPageBreaks(),a.Moodle.mod_quiz.util.page.reorderPages(),a.Moodle.mod_quiz.util.slot.updateOneSlotSections(),a.Moodle.mod_quiz.util.slot.updateAllDependencyIcons()},NAME:"mod_quiz-resource-toolbox",ATTRS:{courseid:{value:0},quizid:{value:0}}}),M.mod_quiz.resource_toolbox=null,M.mod_quiz.init_resource_toolbox=function(a){return M.mod_quiz.resource_toolbox=new g(a),M.mod_quiz.resource_toolbox};var h=function(){h.superclass.constructor.apply(this,arguments)};a.extend(h,f,{editsectionevents:[],initializer:function(){M.mod_quiz.quizbase.register_module(this),e.delegate("key",this.handle_data_action,"down:enter",d.ACTIVITYACTION,this),a.delegate("click",this.handle_data_action,e,d.ACTIVITYACTION,this),a.delegate("change",this.handle_data_action,e,d.EDITSHUFFLEQUESTIONSACTION,this)},handle_data_action:function(a){var b=a.target;b.test("a")||b.test("input[data-action]")||(b=b.ancestor(d.ACTIVITYACTION));var c=b.getData("action"),e=b.ancestor(d.ACTIVITYLI);if((b.test("a")||b.test("input[data-action]"))&&c&&e)switch(c){case"edit_section_title":this.edit_section_title(a,b,e,c);break;case"shuffle_questions":this.edit_shuffle_questions(a,b,e,c);break;case"deletesection":this.delete_section_with_confirmation(a,b,e,c)}},delete_section_with_confirmation:function(b,c,e){b.preventDefault();var f=new M.core.confirm({question:M.util.get_string("confirmremovesectionheading","quiz",e.get("aria-label")),modal:!0});f.on("complete-yes",function(){var b=M.util.add_spinner(a,e.one(d.ACTIONAREA)),c={"class":"section",action:"DELETE",id:e.get("id").replace("section-","")};this.send_request(c,b,function(a){a.deleted&&window.location.reload(!0)})},this)},edit_section_title:function(b,e,f){var g,h=f.get("id").replace("section-",""),i=f.one(d.INSTANCESECTION),j=i,k={"class":"section",field:"getsectiontitle",id:h};b.preventDefault(),this.send_request(k,null,function(b){var d=b.instancesection,e=a.Node.create('<form action="#" />'),h=a.Node.create('<span class="'+c.EDITINSTRUCTIONS+'" id="id_editinstructions" />').set("innerHTML",M.util.get_string("edittitleinstructions","moodle")),k=a.Node.create('<input name="section" type="text" />').setAttrs({value:d,autocomplete:"off","aria-describedby":"id_editinstructions",maxLength:"255"});e.appendChild(k),e.setData("anchor",j),i.insert(h,"before"),j.replace(e),k.focus().select(),g=k.on("blur",this.edit_section_title_cancel,this,f,!1),this.editsectionevents.push(g),g=k.on("key",this.edit_section_title_cancel,"esc",this,f,!0),this.editsectionevents.push(g),g=e.on("submit",this.edit_section_title_submit,this,f,d),this.editsectionevents.push(g)})},edit_section_title_submit:function(b,c,e){b.preventDefault();var f=a.Lang.trim(c.one(d.SECTIONFORM+" "+d.SECTIONINPUT).get("value")),g=M.util.add_spinner(a,c.one(d.INSTANCESECTIONAREA));if(this.edit_section_title_clear(c),null!==f&&f!==e){c.one(d.INSTANCESECTION).setContent(f);var h={"class":"section",field:"updatesectiontitle",newheading:f,id:c.get("id").replace("section-","")};this.send_request(h,g,function(a){if(a){c.one(d.INSTANCESECTION).setContent(a.instancesection),c.one(d.EDITSECTIONICON).set("title",M.util.get_string("sectionheadingedit","quiz",a.instancesection)),c.one(d.EDITSECTIONICON).set("alt",M.util.get_string("sectionheadingedit","quiz",a.instancesection));var b=c.one(d.DELETESECTIONICON);b&&(b.set("title",M.util.get_string("sectionheadingremove","quiz",a.instancesection)),b.set("alt",M.util.get_string("sectionheadingremove","quiz",a.instancesection)))}})}},edit_section_title_cancel:function(a,b,c){c&&a.preventDefault(),this.edit_section_title_clear(b)},edit_section_title_clear:function(b){new a.EventHandle(this.editsectionevents).detach();var c=b.one(d.SECTIONFORM),e=b.one("#id_editinstructions");c&&c.replace(c.getData("anchor")),e&&e.remove(),a.later(100,this,function(){b.one(d.EDITSECTION).focus()}),a.one("input[name=section]")||a.one("body").append('<input type="text" name="section" style="display: none">')},edit_shuffle_questions:function(b,c,e){var f;f=e.one(d.EDITSHUFFLEQUESTIONSACTION).get("checked")?1:0;var g={"class":"section",field:"updateshufflequestions",id:e.get("id").replace("section-",""),newshuffle:f};b.preventDefault();var h=M.util.add_spinner(a,e.one(d.EDITSHUFFLEAREA));this.send_request(g,h)}},{NAME:"mod_quiz-section-toolbox",ATTRS:{courseid:{value:0},quizid:{value:0}}}),M.mod_quiz.init_section_toolbox=function(a){return new h(a)}},"@VERSION@",{requires:["base","node","event","event-key","io","moodle-mod_quiz-quizbase","moodle-mod_quiz-util-slot","moodle-core-notification-ajaxexception"]});