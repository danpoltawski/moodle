YUI.add("moodle-mod_quiz-dragdrop",function(a,b){var c={ACTIONAREA:".actions",ACTIVITY:"activity",ACTIVITYINSTANCE:"activityinstance",CONTENT:"content",COURSECONTENT:"mod-quiz-edit-content",EDITINGMOVE:"editing_move",ICONCLASS:"iconsmall",JUMPMENU:"jumpmenu",LEFT:"left",LIGHTBOX:"lightbox",MOVEDOWN:"movedown",MOVEUP:"moveup",PAGE:"page",PAGECONTENT:"page-content",RIGHT:"right",SECTION:"slots",SECTIONADDMENUS:"section_add_menus",SECTIONHANDLE:"section-handle",SLOTS:"slots",SUMMARY:"summary",SECTIONDRAGGABLE:"sectiondraggable"},d={PAGE:"li.page",SLOT:"li.slot"},e=function(){e.superclass.constructor.apply(this,arguments)};a.extend(e,M.core.dragdrop,{sectionlistselector:null,initializer:function(){if(this.groups=[c.SECTIONDRAGGABLE],this.samenodeclass="section",this.parentnodeclass="slots",a.Node.one("."+c.JUMPMENU))return!1;if(this.sectionlistselector="li.section",this.sectionlistselector){this.sectionlistselector="."+c.COURSECONTENT+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector);var b=new a.DD.Delegate({container:"."+c.COURSECONTENT,nodes:"."+c.SECTIONDRAGGABLE,target:!0,handles:["."+c.LEFT],dragConfig:{groups:this.groups}});b.dd.plug(a.Plugin.DDProxy,{moveOnEnd:!1}),b.dd.plug(a.Plugin.DDConstrained,{constrain:"#"+c.PAGECONTENT,stickY:!0}),b.dd.plug(a.Plugin.DDWinScroll)}},setup_for_section:function(b){a.Node.all(b).each(function(b){var d=a.Moodle.core_course.util.section.getId(b);if(d>0){var e=b.one("."+c.RIGHT+" a."+c.MOVEDOWN),f=b.one("."+c.RIGHT+" a."+c.MOVEUP),g=M.util.get_string("movesection","moodle",d),h=b.one("."+c.LEFT);(e||f)&&h&&(h.setStyle("cursor","move"),h.appendChild(this.get_drag_handle(g,c.SECTIONHANDLE,"icon",!0)),f&&f.remove(),e&&e.remove(),b.addClass(c.SECTIONDRAGGABLE))}},this)},drag_start:function(b){var d=b.target,e=a.Node.create('<ul class="slots"></ul>'),f=a.Node.create('<ul class="section"></ul>');f.setStyle("margin",0),f.setContent(d.get("node").get("innerHTML")),e.appendChild(f),d.get("dragNode").setContent(e),d.get("dragNode").addClass(c.COURSECONTENT)},drag_dropmiss:function(a){this.drop_hit(a)},get_section_index:function(b){var d="."+c.COURSECONTENT+" li.section",e=a.all(d),f=e.indexOf(b),g=e.indexOf(a.one("#section-0"));return f-g},drop_hit:function(b){var d=b.drag,e=d.get("node"),f=a.Moodle.core_course.util.section.getId(e),g=f,h=this.get_section_index(e),i=h;if(f!==h){g>i&&(g=h,i=f),d.get("dragNode").removeClass(c.COURSECONTENT);var j,k=a.Node.all(this.sectionlistselector),l=M.util.add_lightbox(a,e),m={},n=this.get("config").pageparams;for(j in n)n.hasOwnProperty(j)&&(m[j]=n[j]);m.sesskey=M.cfg.sesskey,m.courseid=this.get("courseid"),m.quizid=this.get("quizid"),m["class"]="section",m.field="move",m.id=f,m.value=h;var o=M.cfg.wwwroot+this.get("ajaxurl");a.io(o,{method:"POST",data:m,on:{start:function(){l.show()},success:function(b,c){try{var d=a.JSON.parse(c.responseText);d.error&&new M.core.ajaxException(d),M.mod_quiz.edit.process_sections(a,k,d,g,i)}catch(e){}var f,h=!1;do{for(h=!1,f=g;f<=i;f++)if(a.Moodle.core_course.util.section.getId(k.item(f-1))>a.Moodle.core_course.util.section.getId(k.item(f))){var j=k.item(f-1).get("id");k.item(f-1).set("id",k.item(f).get("id")),k.item(f).set("id",j),M.mod_quiz.edit.swap_sections(a,f-1,f),h=!0}i-=1}while(h);window.setTimeout(function(){l.hide()},250)},failure:function(a,b){this.ajax_failure(b),l.hide()}},context:this})}}},{NAME:"mod_quiz-dragdrop-section",ATTRS:{courseid:{value:null},quizid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.mod_quiz=M.mod_quiz||{},M.mod_quiz.init_section_dragdrop=function(a){new e(a)};var f=function(){f.superclass.constructor.apply(this,arguments)};a.extend(f,M.core.dragdrop,{initializer:function(){this.groups=["resource"],this.samenodeclass=c.ACTIVITY,this.parentnodeclass=c.SECTION,this.resourcedraghandle=this.get_drag_handle(M.util.get_string("move","moodle"),c.EDITINGMOVE,c.ICONCLASS,!0),this.samenodelabel={identifier:"dragtoafter",component:"quiz"},this.parentnodelabel={identifier:"dragtostart",component:"quiz"},this.setup_for_section();var b="li."+c.ACTIVITY,d=new a.DD.Delegate({container:"."+c.COURSECONTENT,nodes:b,target:!0,handles:["."+c.EDITINGMOVE],dragConfig:{groups:this.groups}});d.dd.plug(a.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),d.dd.plug(a.Plugin.DDConstrained,{constrain:"#"+c.SLOTS}),d.dd.plug(a.Plugin.DDWinScroll),M.mod_quiz.quizbase.register_module(this),M.mod_quiz.dragres=this},setup_for_section:function(){a.Node.all(".mod-quiz-edit-content ul.slots ul.section").each(function(b){b.setAttribute("data-draggroups",this.groups.join(" ")),new a.DD.Drop({node:b,groups:this.groups,padding:"20 0 20 0"}),this.setup_for_resource("li.activity")},this)},setup_for_resource:function(b){a.Node.all(b).each(function(a){var b=a.one("a."+c.EDITINGMOVE);b&&b.replace(this.resourcedraghandle.cloneNode(!0))},this)},drag_start:function(a){var b=a.target;b.get("dragNode").setContent(b.get("node").get("innerHTML")),b.get("dragNode").all("img.iconsmall").setStyle("vertical-align","baseline")},drag_dropmiss:function(a){this.drop_hit(a)},drop_hit:function(b){var e,f=b.drag,g=f.get("node"),h=b.drop.get("node"),i=g.one(c.ACTIONAREA),j=M.util.add_spinner(a,i),k={},l=this.get("config").pageparams;for(e in l)k[e]=l[e];k.sesskey=M.cfg.sesskey,k.courseid=this.get("courseid"),k.quizid=this.get("quizid"),k["class"]="resource",k.field="move",k.id=Number(a.Moodle.mod_quiz.util.slot.getId(g)),k.sectionId=a.Moodle.core_course.util.section.getId(h.ancestor("li.section",!0));var m=g.previous(d.SLOT);m&&(k.previousid=Number(a.Moodle.mod_quiz.util.slot.getId(m)));var n=g.previous(d.PAGE);n&&(k.page=Number(a.Moodle.mod_quiz.util.page.getId(n)));var o=M.cfg.wwwroot+this.get("ajaxurl");a.io(o,{method:"POST",data:k,on:{start:function(){this.lock_drag_handle(f,c.EDITINGMOVE),j.show()},success:function(b,d){var e=a.JSON.parse(d.responseText),h={element:g,visible:e.visible};M.mod_quiz.quizbase.invoke_function("set_visibility_resource_ui",h),this.unlock_drag_handle(f,c.EDITINGMOVE),window.setTimeout(function(){j.hide()},250),M.mod_quiz.resource_toolbox.reorganise_edit_page()},failure:function(a,b){this.ajax_failure(b),this.unlock_drag_handle(f,c.SECTIONHANDLE),j.hide(),window.location.reload(!0)}},context:this})},global_drop_over:function(a){if(a.drop&&a.drop.inGroup(this.groups)){var b=a.drag.get("node"),c=a.drop.get("node");if(this.lastdroptarget=a.drop,c.hasClass(this.samenodeclass)){var d;d=this.goingup?"before":"after",c.insert(b,d)}else!c.hasClass(this.parentnodeclass)&&!c.test('[data-droptarget="1"]')||c.contains(b)||(this.goingup?c.append(b):c.prepend(b));this.drop_over(a)}}},{NAME:"mod_quiz-dragdrop-resource",ATTRS:{courseid:{value:null},quizid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.mod_quiz=M.mod_quiz||{},M.mod_quiz.init_resource_dragdrop=function(a){new f(a)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-mod_quiz-quizbase","moodle-mod_quiz-util-base","moodle-mod_quiz-util-page","moodle-mod_quiz-util-slot","moodle-course-util"]});