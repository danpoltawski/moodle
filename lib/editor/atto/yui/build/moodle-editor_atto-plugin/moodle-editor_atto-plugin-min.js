YUI.add("moodle-editor_atto-plugin",function(a,b){function c(){c.superclass.constructor.apply(this,arguments)}function d(){}function e(){}var f=".atto_group.",g="_group";a.extend(c,a.Base,{name:null,editor:null,toolbar:null,initializer:function(a){this.name=a.name,this.toolbar=a.toolbar,this.editor=a.editor,this.buttons={},this.buttonNames=[],this.buttonStates={},this.menus={},this._primaryKeyboardShortcut=[],this._buttonHandlers=[],this._menuHideHandlers=[],this._highlightQueue={}},markUpdated:function(){return this.get("host").saveSelection(),this.get("host").updateOriginal()}},{NAME:"editorPlugin",ATTRS:{host:{writeOnce:!0},group:{writeOnce:!0,getter:function(b){var c=this.toolbar.one(f+b+g);return c||(c=a.Node.create('<div class="atto_group '+b+g+'"></div>'),this.toolbar.append(c)),c}}}}),a.namespace("M.editor_atto").EditorPlugin=c;var h='<button class="{{buttonClass}} atto_hasmenu" tabindex="-1" type="button" title="{{title}}"><img class="icon" aria-hidden="true" role="presentation" width="16" height="16" style="background-color:{{config.menuColor}};" src="{{config.iconurl}}" /><img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="{{image_url "t/expanded" "moodle"}}"/></button>',i="disabled",j="highlight",k={EDITORWRAPPER:".editor_atto_content"};d.ATTRS={},d.prototype={buttons:null,buttonNames:null,buttonStates:null,menus:null,DISABLED:0,ENABLED:1,_buttonHandlers:null,_menuHideHandlers:null,_primaryKeyboardShortcut:null,_highlightQueue:null,addButton:function(b){var c,d=this.get("group"),e=this.name,f="atto_"+e+"_button",g=this.get("host");b.exec&&(f=f+"_"+b.exec),b.buttonName?f=f+"_"+b.buttonName:b.buttonName=b.exec||e,b.buttonClass=f,b=this._normalizeIcon(b),b.title||(b.title="pluginname");var h=M.util.get_string(b.title,"atto_"+e);c=a.Node.create('<button type="button" class="'+f+'"tabindex="-1"><img class="icon" aria-hidden="true" role="presentation" width="16" height="16" src="'+b.iconurl+'"/></button>'),c.setAttribute("title",h),d.append(c);var i=this.toolbar.getAttribute("aria-activedescendant");if(i||(c.setAttribute("tabindex","0"),this.toolbar.setAttribute("aria-activedescendant",c.generateID()),this.get("host")._tabFocus=c),b=this._normalizeCallback(b),this._buttonHandlers.push(this.toolbar.delegate("click",b.callback,"."+f,this)),b.keys&&("undefined"!=typeof b.keyDescription&&(this._primaryKeyboardShortcut[f]=b.keyDescription),this._addKeyboardListener(b.callback,b.keys,f),this._primaryKeyboardShortcut[f]&&c.setAttribute("title",M.util.get_string("plugin_title_shortcut","editor_atto",{title:h,shortcut:this._primaryKeyboardShortcut[f]}))),b.tags){var j=!0;"boolean"==typeof b.tagMatchRequiresAll&&(j=b.tagMatchRequiresAll),this._buttonHandlers.push(g.on(["atto:selectionchanged","change"],function(c){"undefined"!=typeof this._highlightQueue[b.buttonName]&&this._highlightQueue[b.buttonName].cancel(),this._highlightQueue[b.buttonName]=a.soon(a.bind(function(a){g.selectionFilterMatches(b.tags,a.selectedNodes,j)?this.highlightButtons(b.buttonName):this.unHighlightButtons(b.buttonName)},this,c))},this))}return this.buttonNames.push(b.buttonName),this.buttons[b.buttonName]=c,this.buttonStates[b.buttonName]=this.ENABLED,c},addBasicButton:function(a){return a.exec?(a.icon||(a.icon="e/"+a.exec),a.callback=function(){document.execCommand(a.exec,!1,null),this.markUpdated()},this.addButton(a)):null},addToolbarMenu:function(b){var c,d,e=this.get("group"),f=this.name,g="atto_"+f+"_button";b.buttonName?g=g+"_"+b.buttonName:b.buttonName=f,b.buttonClass=g,b=this._normalizeIcon(b),b.title||(b.title="pluginname");var i=M.util.get_string(b.title,"atto_"+f);b.menuColor||(b.menuColor="transparent");var j=a.Handlebars.compile(h);return c=a.Node.create(j({buttonClass:g,config:b,title:i})),e.append(c),d=this.toolbar.getAttribute("aria-activedescendant"),d||(c.setAttribute("tabindex","0"),this.toolbar.setAttribute("aria-activedescendant",c.generateID())),this._buttonHandlers.push(this.toolbar.delegate("click",this._showToolbarMenu,"."+g,this,b),this.toolbar.delegate("key",this._showToolbarMenuAndFocus,"40, 32, enter","."+g,this,b)),this.buttonNames.push(b.buttonName),this.buttons[b.buttonName]=c,this.buttonStates[b.buttonName]=this.ENABLED,c},_showToolbarMenu:function(b,c){if(b.preventDefault(),this.isEnabled()&&!b.currentTarget.ancestor("button",!0).hasAttribute(i)){var d;this.menus[c.buttonClass]||(c.overlayWidth||(c.overlayWidth="14"),c.innerOverlayWidth||(c.innerOverlayWidth=parseInt(c.overlayWidth,10)-2+"em"),c.overlayWidth=parseInt(c.overlayWidth,10)+"em",this.menus[c.buttonClass]=new a.M.editor_atto.Menu(c),this.menus[c.buttonClass].get("contentBox").delegate("click",this._chooseMenuItem,".atto_menuentry a",this,c)),a.Array.each(this.get("host").openMenus,function(a){a.set("focusAfterHide",null)});var e=this.buttons[c.buttonName];e.focus(),this.get("host")._setTabFocus(e),d=this.menus[c.buttonClass],d.set("focusAfterHide",e),d.show(),d.align(this.buttons[c.buttonName],[a.WidgetPositionAlign.TL,a.WidgetPositionAlign.BL]),this.get("host").openMenus=[d]}},_showToolbarMenuAndFocus:function(a,b){this._showToolbarMenu(a,b),this.menus[b.buttonClass].get("boundingBox").one("a").focus()},_chooseMenuItem:function(a,b,c){var d=a.target.ancestor("a",!0).getData("index"),e=this._normalizeCallback(b.items[d],b.globalItemConfig);c=this.menus[b.buttonClass],c.set("preventHideMenu",!0),e.callback(a,e._callback,e.callbackArgs),c.set("preventHideMenu",!1),c.set("focusAfterHide",this.get("host").editor),c.hide(a)},_normalizeCallback:function(b,c){return b._callbackNormalized?b:(c||(c={}),b.inlineFormat=b.inlineFormat||c.inlineFormat,b._inlineCallback=b.callback||c.callback,b._callback=b.callback||c.callback,b.inlineFormat&&"function"==typeof b._inlineCallback&&(b._callback=function(a,c){this.get("host").applyFormat(a,b._inlineCallback,this,c)}),b.callback=a.rbind(this._callbackWrapper,this,b._callback,b.callbackArgs),b._callbackNormalized=!0,b)},_normalizeIcon:function(a){return a.iconurl||(a.iconComponent||(a.iconComponent="core"),a.iconurl=M.util.image_url(a.icon,a.iconComponent)),a},_callbackWrapper:function(a,b,c){if(a.preventDefault(),this.isEnabled()){var d=a.currentTarget.ancestor("button",!0);if(!d||!d.hasAttribute(i)){YUI.Env.UA.android||this.get("host").isActive()||this.get("host").focus(),this.get("host").saveSelection(),d&&this.get("host")._setTabFocus(d);var e=[a,c];return this.get("host").restoreSelection(),b.apply(this,e)}}},_addKeyboardListener:function(b,c,d){var e,f,g,h="key",i=k.EDITORWRAPPER;return a.Lang.isArray(c)?(a.Array.each(c,function(a){this._addKeyboardListener(b,a)},this),this):("object"==typeof c?(c.eventtype&&(h=c.eventtype),c.container&&(i=c.container),e=c.keyCodes,f=b):(g=this._getDefaultMetaKey(),e=this._getKeyEvent()+c+"+"+g,"undefined"==typeof this._primaryKeyboardShortcut[d]&&(this._primaryKeyboardShortcut[d]=this._getDefaultMetaKeyDescription(c)),f=a.bind(function(a,c){this._eventUsesExactKeyModifiers(a,c)&&b.apply(this,[c])},this,[g])),void this._buttonHandlers.push(this.editor.delegate(h,f,e,i,this)))},_eventUsesExactKeyModifiers:function(b,c){var d,e=!0;return"key"===c.type&&(d=a.Array.indexOf(b,"alt")>-1,e=e&&(c.altKey&&d||!c.altKey&&!d),d=a.Array.indexOf(b,"ctrl")>-1,e=e&&(c.ctrlKey&&d||!c.ctrlKey&&!d),d=a.Array.indexOf(b,"meta")>-1,e=e&&(c.metaKey&&d||!c.metaKey&&!d),d=a.Array.indexOf(b,"shift")>-1,e=e&&(c.shiftKey&&d||!c.shiftKey&&!d))},isEnabled:function(){var b=a.Object.some(this.buttonStates,function(a){return a===this.ENABLED},this);return b},disableButtons:function(a){return this._setButtonState(!1,a)},enableButtons:function(a){return this._setButtonState(!0,a)},_setButtonState:function(b,c){var d="setAttribute";return b&&(d="removeAttribute"),c?this.buttons[c]&&(this.buttons[c][d](i,i),this.buttonStates[c]=b?this.ENABLED:this.DISABLED):a.Array.each(this.buttonNames,function(a){this.buttons[a][d](i,i),this.buttonStates[a]=b?this.ENABLED:this.DISABLED},this),this.get("host").checkTabFocus(),this},highlightButtons:function(a){return this._changeButtonHighlight(!0,a)},unHighlightButtons:function(a){return this._changeButtonHighlight(!1,a)},_changeButtonHighlight:function(b,c){var d="addClass";return b||(d="removeClass"),c?this.buttons[c]&&this.buttons[c][d](j):a.Object.each(this.buttons,function(a){a[d](j)},this),this},_getDefaultMetaKey:function(){return"macintosh"===a.UA.os?"meta":"ctrl"},_getDefaultMetaKeyDescription:function(b){return"macintosh"===a.UA.os?M.util.get_string("editor_command_keycode","editor_atto",String.fromCharCode(b).toLowerCase()):M.util.get_string("editor_control_keycode","editor_atto",String.fromCharCode(b).toLowerCase())},_getKeyEvent:function(){return"down:"}},a.Base.mix(a.M.editor_atto.EditorPlugin,[d]),e.ATTRS={},e.prototype={_dialogue:null,getDialogue:function(b){b=b||{};var c=!1;if(b.focusAfterHide&&(c=b.focusAfterHide,delete b.focusAfterHide),!this._dialogue){var d=a.merge({visible:!1,modal:!0,close:!0,draggable:!0},b);this._dialogue=new M.core.dialogue(d)}return c!==!1&&(c===!0?this._dialogue.set("focusAfterHide",this.buttons[this.buttonNames[0]]):"string"==typeof c?this._dialogue.set("focusAfterHide",this.buttons[c]):this._dialogue.set("focusAfterHide",c)),this._dialogue}},a.Base.mix(a.M.editor_atto.EditorPlugin,[e])},"@VERSION@",{requires:["node","base","escape","event","event-outside","handlebars","event-custom","timers","moodle-editor_atto-menu"]});