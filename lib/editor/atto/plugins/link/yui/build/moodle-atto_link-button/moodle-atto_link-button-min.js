YUI.add("moodle-atto_link-button",function(a,b){var c="atto_link",d={NEWWINDOW:"atto_link_openinnewwindow",URLINPUT:"atto_link_urlentry"},e={URLINPUT:".atto_link_urlentry"},f='<form class="atto_form"><label for="{{elementid}}_atto_link_urlentry">{{get_string "enterurl" component}}</label><input class="fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_link_urlentry" size="32"/><br/>{{#if showFilepicker}}<button class="openlinkbrowser">{{get_string "browserepositories" component}}</button><br/>{{/if}}<input type="checkbox" class="newwindow" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="sameline" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label><br/><div class="mdl-align"><br/><button type="submit" class="submit">{{get_string "createlink" component}}</button></div></form>';a.namespace("M.atto_link").Button=a.Base.create("button",a.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,initializer:function(){this.addButton({icon:"e/insert_edit_link",keys:"75",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1}),this.addButton({buttonName:"unlink",callback:this._unlink,icon:"e/remove_link",title:"unlink",tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),this._currentSelection!==!1){var a=this.getDialogue({headerContent:M.util.get_string("createlink",c),focusAfterHide:!0,focusOnShowSelector:e.URLINPUT});a.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),a.show()}},_resolveAnchors:function(){var b,c,d,e,f=this.get("host").getSelectionParentNode();f&&(b=this._findSelectedAnchors(a.one(f)),b.length>0&&(c=b[0],this._currentSelection=this.get("host").getSelectionFromNode(c),d=c.getAttribute("href"),e=c.getAttribute("target"),""!==d&&this._content.one(".url").setAttribute("value",d),"_blank"===e?this._content.one(".newwindow").setAttribute("checked","checked"):this._content.one(".newwindow").removeAttribute("checked")))},_filepickerCallback:function(a){this.getDialogue().set("focusAfterHide",null).hide(),""!==a.url&&(this._setLinkOnSelection(a.url),this.markUpdated())},_setLink:function(a){var b,c;if(a.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),b=this._content.one(".url"),c=b.get("value"),""!==c){c=c.trim();var d=new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/);d.test(c)||(c="http://"+c),this._setLinkOnSelection(c),this.markUpdated()}},_setLinkOnSelection:function(b){var c,d,e,f,g=this.get("host");if(this.editor.focus(),g.setSelection(this._currentSelection),this._currentSelection[0].collapsed?(c=a.Node.create("<a>"+b+"</a>"),c.setAttribute("href",b),d=g.insertContentAtFocusPoint(c.get("outerHTML")),g.setSelection(g.getSelectionFromNode(d))):(document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,b),d=g.getSelectionParentNode()),d)return f=this._findSelectedAnchors(a.one(d)),a.Array.each(f,function(a){e=this._content.one(".newwindow"),e.get("checked")?a.setAttribute("target","_blank"):a.removeAttribute("target")},this),d},_findSelectedAnchors:function(a){var b,c,d=a.get("tagName");return d&&"a"===d.toLowerCase()?[a]:(c=[],a.all("a").each(function(a){!b&&this.get("host").selectionContainsNode(a)&&c.push(a)},this),c.length>0?c:(b=a.ancestor("a"),b?[b]:[]))},_getDialogueContent:function(){var b=this.get("host").canShowFilepicker("link"),e=a.Handlebars.compile(f);return this._content=a.Node.create(e({showFilepicker:b,component:c,CSS:d})),this._content.one(".submit").on("click",this._setLink,this),b&&this._content.one(".openlinkbrowser").on("click",function(a){a.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content},_unlink:function(){var a=this.get("host"),b=a.getSelection();if(b&&b.length)if(b[0].startOffset===b[0].endOffset){var c=a.getSelectedNodes();c&&(c.each(function(b){var c=b.ancestor("a",!0);c&&(a.setSelection(a.getSelectionFromNode(c)),document.execCommand("unlink",!1,null))},this),this.markUpdated())}else document.execCommand("unlink",!1,null),this.markUpdated()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});