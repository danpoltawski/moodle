YUI.add("moodle-atto_image-button",function(a,b){var c={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry",INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box",ALIGNSETTINGS:"atto_image_button"},d={INPUTURL:"."+c.INPUTURL},e=[{name:"verticalAlign",str:"alignment_top",value:"text-top",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_middle",value:"middle",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_bottom",value:"text-bottom",margin:"0 0.5em",isDefault:!0},{name:"float",str:"alignment_left",value:"left",margin:"0 0.5em 0 0"},{name:"float",str:"alignment_right",value:"right",margin:"0 0 0 0.5em"}],f={ISPERCENT:/\d+%/},g="atto_image",h='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<div style="display:none" role="alert" class="warning {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><br/><input type="checkbox" class="{{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="sameline" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label><br/><label class="sameline" for="{{elementid}}_{{CSS.INPUTSIZE}}">{{get_string "size" component}}</label><div id="{{elementid}}_{{CSS.INPUTSIZE}}" class="{{CSS.INPUTSIZE}}"><label class="accesshide" for="{{elementid}}_{{CSS.INPUTWIDTH}}">{{get_string "width" component}}</label><input type="text" class="{{CSS.INPUTWIDTH}} input-mini" id="{{elementid}}_{{CSS.INPUTWIDTH}}" size="4"/> x <label class="accesshide" for="{{elementid}}_{{CSS.INPUTHEIGHT}}">{{get_string "height" component}}</label><input type="text" class="{{CSS.INPUTHEIGHT}} input-mini" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" size="4"/><input type="checkbox" class="{{CSS.INPUTCONSTRAIN}} sameline" id="{{elementid}}_{{CSS.INPUTCONSTRAIN}}"/><label for="{{elementid}}_{{CSS.INPUTCONSTRAIN}}">{{get_string "constrain" component}}</label></div><label class="sameline" for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="{{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}">{{get_string str ../component}}</option>{{/each}}</select><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>',i='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';a.namespace("M.atto_image").Button=a.Base.create("button",a.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"img",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,"img",this),this.editor.delegate("click",this._handleClick,"img",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.on("dragover",function(a){a.preventDefault()},this),this.editor.on("dragenter",function(a){a.preventDefault()},this)},_handleDragDrop:function(b){var c=this,d=this.get("host"),e=a.Handlebars.compile(i);d.saveSelection(),b=b._event;var f=b.dataTransfer&&b.dataTransfer.files&&b.dataTransfer.files.length;if(f&&/^image\//.test(b.dataTransfer.files[0].type)){var h=d.get("filepickeroptions").image,j=void 0===h.savepath?"/":h.savepath,k=new FormData,l=0,m="",n=new XMLHttpRequest,o="",p=Object.keys(h.repositories);b.preventDefault(),b.stopPropagation(),k.append("repo_upload_file",b.dataTransfer.files[0]),k.append("itemid",h.itemid);for(var q=0;q<p.length;q++)if("upload"===h.repositories[p[q]].type){k.append("repo_id",h.repositories[p[q]].id);break}return k.append("env",h.env),k.append("sesskey",M.cfg.sesskey),k.append("client_id",h.client_id),k.append("savepath",j),k.append("ctx_id",h.context.id),l=(new Date).getTime(),m="moodleimage_"+Math.round(1e5*Math.random())+"-"+l,d.focus(),d.restoreSelection(),o=e({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",g),id:m}),d.insertContentAtFocusPoint(o),c.markUpdated(),n.onreadystatechange=function(){var b,d,f,g,h=c.editor.one("#"+m);if(4===n.readyState)if(200===n.status){if(b=JSON.parse(n.responseText)){if(b.error)return h&&h.remove(!0),new M.core.ajaxException(b);d=b,b.event&&"fileexists"===b.event&&(d=b.newfile),f=e({url:d.url,presentation:!0}),g=a.Node.create(f),h?h.replace(g):c.editor.appendChild(g),c.markUpdated()}}else a.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),h&&h.remove(!0)},n.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),n.send(k),!1}},_handleClick:function(a){var b=a.target,c=this.get("host").getSelectionFromNode(b);this.get("host").getSelection()!==c&&this.get("host").setSelection(c)},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),this._currentSelection!==!1){this._rawImageDimensions=null;var a=this.getDialogue({headerContent:M.util.get_string("imageproperties",g),width:"480px",focusAfterHide:!0,focusOnShowSelector:d.INPUTURL});a.set("bodyContent",this._getDialogueContent()).show()}},_loadPreviewImage:function(a){var b=new Image,d=this;b.onerror=function(){var a=d._form.one("."+c.IMAGEPREVIEW);a.setStyles({display:"none"}),d.getDialogue().centerDialogue()},b.onload=function(){var a,b,e,g,h;d._rawImageDimensions={width:this.width,height:this.height},a=d._form.one("."+c.INPUTWIDTH),b=a.get("value"),""===b&&(a.set("value",this.width),b=""+this.width),a=d._form.one("."+c.INPUTHEIGHT),e=a.get("value"),""===e&&(a.set("value",this.height),e=""+this.height),a=d._form.one("."+c.IMAGEPREVIEW),a.setAttribute("src",this.src),a.setStyles({display:"inline"}),a=d._form.one("."+c.INPUTCONSTRAIN),b.match(f.ISPERCENT)&&e.match(f.ISPERCENT)?a.set("checked",b===e):(0===this.width&&(this.width=1),0===this.height&&(this.height=1),g=Math.round(1e3*parseInt(b,10)/this.width),h=Math.round(1e3*parseInt(e,10)/this.height),a.set("checked",g===h)),d._autoAdjustSize(d),d.getDialogue().centerDialogue()},b.src=a},_getDialogueContent:function(){var b=a.Handlebars.compile(h),d=this.get("host").canShowFilepicker("image"),f=a.Node.create(b({elementid:this.get("host").get("elementid"),CSS:c,component:g,showFilepicker:d,alignments:e}));return this._form=f,this._applyImageProperties(this._form),this._form.one("."+c.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+c.IMAGEPRESENTATION).on("change",this._updateWarning,this),this._form.one("."+c.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+c.INPUTWIDTH).on("blur",this._autoAdjustSize,this),this._form.one("."+c.INPUTHEIGHT).on("blur",this._autoAdjustSize,this,!0),this._form.one("."+c.INPUTCONSTRAIN).on("change",function(a){a.target.get("checked")&&this._autoAdjustSize(a)},this),this._form.one("."+c.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+c.INPUTSUBMIT).on("click",this._setImage,this),d&&this._form.one("."+c.IMAGEBROWSER).on("click",function(){this.get("host").showFilepicker("image",this._filepickerCallback,this)},this),f},_autoAdjustSize:function(a,b){b=b||!1;var d,e,g=this._form.one("."+c.INPUTWIDTH),h="width",i=this._form.one("."+c.INPUTHEIGHT),j="height",k=this._form.one("."+c.INPUTCONSTRAIN),l=g.get("value"),m=i.get("value"),n=this._form.one("."+c.IMAGEPREVIEW);if(this._rawImageDimensions)if(""===l&&(l=this._rawImageDimensions[h],g.set("value",l),l=g.get("value")),n.setStyles({width:null,height:null}),k.get("checked")){if(b){var o;o=g,g=i,i=o,o=h,h=j,j=o,o=l,l=m,m=o}l.match(f.ISPERCENT)?(m=l,d=parseInt(l,10),e=this._rawImageDimensions.width/100*d,n.setStyle("width",e),e=this._rawImageDimensions.height/100*d,n.setStyle("height",e)):(m=Math.round(l/this._rawImageDimensions[h]*this._rawImageDimensions[j]),b?n.setStyles({width:m,height:l}):n.setStyles({width:l,height:m})),i.set("value",m)}else l.match(f.ISPERCENT)?(d=parseInt(l,10),e=this._rawImageDimensions.width/100*d,n.setStyle("width",e+"px")):n.setStyle("width",l+"px"),m.match(f.ISPERCENT)?(d=parseInt(m,10),e=this._rawImageDimensions.height/100*d,n.setStyle("height",e+"px")):n.setStyle("height",m+"px")},_filepickerCallback:function(a){if(""!==a.url){var b=this._form.one("."+c.INPUTURL);b.set("value",a.url),this._form.one("."+c.INPUTWIDTH).set("value",""),this._form.one("."+c.INPUTHEIGHT).set("value",""),this._loadPreviewImage(a.url)}},_applyImageProperties:function(a){var b=this._getSelectedImageProperties(),d=a.one("."+c.IMAGEPREVIEW);return b===!1?(d.setStyle("display","none"),void e.some(function(b){return!!b.isDefault&&(a.one("."+c.INPUTALIGNMENT).set("value",b.value),!0)},this)):(b.align&&a.one("."+c.INPUTALIGNMENT).set("value",b.align),b.customstyle&&a.one("."+c.INPUTCUSTOMSTYLE).set("value",b.customstyle),b.width&&a.one("."+c.INPUTWIDTH).set("value",b.width),b.height&&a.one("."+c.INPUTHEIGHT).set("value",b.height),b.alt&&a.one("."+c.INPUTALT).set("value",b.alt),b.src&&(a.one("."+c.INPUTURL).set("value",b.src),this._loadPreviewImage(b.src)),b.presentation&&a.one("."+c.IMAGEPRESENTATION).set("checked","checked"),void this._autoAdjustSize())},_getSelectedImageProperties:function(){var a,b,c,d,e={src:null,alt:null,width:null,height:null,align:"",presentation:!1},g=this.get("host").getSelectedNodes();return g&&(g=g.filter("img")),g&&g.size()?(d=this._removeLegacyAlignment(g.item(0)),this._selectedImage=d,c=d.getAttribute("style"),e.customstyle=c,a=d.getAttribute("width"),a.match(f.ISPERCENT)||(a=parseInt(a,10)),b=d.getAttribute("height"),b.match(f.ISPERCENT)||(b=parseInt(b,10)),0!==a&&(e.width=a),0!==b&&(e.height=b),this._getAlignmentPropeties(d,e),e.src=d.getAttribute("src"),e.alt=d.getAttribute("alt")||"",e.presentation="presentation"===d.get("role"),e):(this._selectedImage=null,!1)},_getAlignmentPropeties:function(a,b){var c,d=!1;d=e.some(function(d){var e=this._getAlignmentClass(d.value);return a.hasClass(e)?(b.align=d.value,!0):(d.isDefault&&(c=d.value),!1)},this),!d&&c&&(b.align=c)},_urlChanged:function(){var a=this._form.one("."+c.INPUTURL);""!==a.get("value")&&this._loadPreviewImage(a.get("value"))},_setImage:function(b){var d,e=this._form,g=e.one("."+c.INPUTURL).get("value"),h=e.one("."+c.INPUTALT).get("value"),j=e.one("."+c.INPUTWIDTH).get("value"),k=e.one("."+c.INPUTHEIGHT).get("value"),l=this._getAlignmentClass(e.one("."+c.INPUTALIGNMENT).get("value")),m=e.one("."+c.IMAGEPRESENTATION).get("checked"),n=e.one("."+c.INPUTCONSTRAIN).get("checked"),o=e.one("."+c.INPUTCUSTOMSTYLE).get("value"),p=[],q=this.get("host");if(b.preventDefault(),!this._updateWarning()){if(q.focus(),""!==g){if(this._selectedImage?q.setSelection(q.getSelectionFromNode(this._selectedImage)):q.setSelection(this._currentSelection),n&&p.push(c.RESPONSIVE),p.push(l),!j.match(f.ISPERCENT)&&isNaN(parseInt(j,10)))return void e.one("."+c.INPUTWIDTH).focus();if(!k.match(f.ISPERCENT)&&isNaN(parseInt(k,10)))return void e.one("."+c.INPUTHEIGHT).focus();var r=a.Handlebars.compile(i);d=r({url:g,alt:h,width:j,height:k,presentation:m,customstyle:o,classlist:p.join(" ")}),this.get("host").insertContentAtFocusPoint(d),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()}},_removeLegacyAlignment:function(b){return b.getStyle("margin")?(e.some(function(c){if(b.getStyle(c.name)!==c.value)return!1;var d=a.Node.create("<div>");return d.setStyle("margin",c.margin),b.getStyle("margin")===d.getStyle("margin")&&(b.addClass(this._getAlignmentClass(c.value)),b.setStyle(c.name,null),b.setStyle("margin",null),!0)},this),b):b},_getAlignmentClass:function(a){return c.ALIGNSETTINGS+"_"+a},_updateWarning:function(){var a=this._form,b=!0,d=a.one("."+c.INPUTALT).get("value"),e=a.one("."+c.IMAGEPRESENTATION).get("checked");return""!==d||e?(a.one("."+c.IMAGEALTWARNING).setStyle("display","none"),a.one("."+c.INPUTALT).setAttribute("aria-invalid",!1),a.one("."+c.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),b=!1):(a.one("."+c.IMAGEALTWARNING).setStyle("display","block"),a.one("."+c.INPUTALT).setAttribute("aria-invalid",!0),a.one("."+c.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),b=!0),this.getDialogue().centerDialogue(),b}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});