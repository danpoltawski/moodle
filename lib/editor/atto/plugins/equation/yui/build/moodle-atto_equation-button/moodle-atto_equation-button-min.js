YUI.add("moodle-atto_equation-button",function(a,b){var c="atto_equation",d={EQUATION_TEXT:"atto_equation_equation",EQUATION_PREVIEW:"atto_equation_preview",SUBMIT:"atto_equation_submit",LIBRARY:"atto_equation_library",LIBRARY_GROUPS:"atto_equation_groups",LIBRARY_GROUP_PREFIX:"atto_equation_group"},e={LIBRARY:"."+d.LIBRARY,LIBRARY_GROUP:"."+d.LIBRARY_GROUPS+" > div > div",EQUATION_TEXT:"."+d.EQUATION_TEXT,EQUATION_PREVIEW:"."+d.EQUATION_PREVIEW,SUBMIT:"."+d.SUBMIT,LIBRARY_BUTTON:"."+d.LIBRARY+" button"},f={START:"\\(",END:"\\)"},g={FORM:'<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.EQUATION_TEXT}}">{{{get_string "editequation" component texdocsurl}}}</label><textarea class="fullwidth {{CSS.EQUATION_TEXT}}" id="{{elementid}}_{{CSS.EQUATION_TEXT}}" rows="8"></textarea><br/><label for="{{elementid}}_{{CSS.EQUATION_PREVIEW}}">{{get_string "preview" component}}</label><div describedby="{{elementid}}_cursorinfo" class="well well-small fullwidth {{CSS.EQUATION_PREVIEW}}" id="{{elementid}}_{{CSS.EQUATION_PREVIEW}}"></div><div id="{{elementid}}_cursorinfo">{{get_string "cursorinfo" component}}</div><div class="mdl-align"><br/><button class="{{CSS.SUBMIT}}">{{get_string "saveequation" component}}</button></div></form>',LIBRARY:'<div class="{{CSS.LIBRARY}}"><ul>{{#each library}}<li><a href="#{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div class="{{CSS.LIBRARY_GROUPS}}">{{#each library}}<div id="{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"><div role="toolbar">{{#split "\n" elements}}<button tabindex="-1" data-tex="{{this}}" aria-label="{{this}}" title="{{this}}">{{../../DELIMITERS.START}}{{this}}{{../../DELIMITERS.END}}</button>{{/split}}</div></div>{{/each}}</div></div>'};a.namespace("M.atto_equation").Button=a.Base.create("button",a.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_lastCursorPos:0,_content:null,_sourceEquation:null,_groupFocus:null,_equationPatterns:[/\$\$([\S\s]+?)\$\$/,/\\\(([\S\s]+?)\\\)/,/\\\[([\S\s]+?)\\\]/,/\[tex\]([\S\s]+?)\[\/tex\]/],initializer:function(){this._groupFocus={},this.get("texfilteractive")&&(this.addButton({icon:"e/math",callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){this._resolveEquation()?this.highlightButtons():this.unHighlightButtons()},this),this.editor.all("tex").each(function(b){var c=a.Node.create("<span>"+f.START+" "+b.get("text")+" "+f.END+"</span>");b.replace(c)}))},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),this._currentSelection!==!1){var b=this._resolveEquation(),d=this.getDialogue({headerContent:M.util.get_string("pluginname",c),focusAfterHide:!0,width:600,focusOnShowSelector:e.EQUATION_TEXT}),f=this._getDialogueContent();d.set("bodyContent",f);var g=f.one(e.LIBRARY),h=new a.TabView({srcNode:g});h.render(),d.show(),require(["core/event"],function(a){a.notifyFilterContentUpdated(d.get("boundingBox").getDOMNode())}),b&&f.one(e.EQUATION_TEXT).set("text",b),this._updatePreview(!1)}},_resolveEquation:function(){var b,c=this.get("host").getSelectionParentNode(),d=this.get("host").getSelection(),e=!1;return!!this.get("host").isActive()&&(!!c&&(!(!d||0===d.length)&&(this.sourceEquation=null,d=d[0],b=a.one(c).get("text"),a.Array.find(this._equationPatterns,function(c){var f=b.match(new RegExp(c.source,"g"));if(f&&f.length)return a.Array.find(f,function(a){for(var f=0;b.indexOf(a,f)!==-1;){var g=b.indexOf(a,f),h=g+a.length,i=d.startOffset>=g&&d.startOffset<h,j=d.endOffset<=h&&d.endOffset>g;if(i&&j){var k=a.match(c);if(k&&k.length){var l=b.indexOf(k[1],g),m=l+k[1].length;return e=k[1],this.sourceEquation={startOuterPosition:g,endOuterPosition:h,outerMatch:a,startInnerPosition:l,endInnerPosition:m,innerMatch:k},!0}}f=h}},this)},this),e!==!1&&(e=e.trim()),e)))},_setEquation:function(b){var c,d,e,g,h,i;h=this.get("host"),b.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),c=b.currentTarget.ancestor(".atto_form").one("textarea"),g=c.get("value"),""!==g&&(h.setSelection(this._currentSelection),this.sourceEquation?(d=a.one(h.getSelectionParentNode()),e=d.get("text"),g=" "+g+" ",i=e.slice(0,this.sourceEquation.startInnerPosition)+g+e.slice(this.sourceEquation.endInnerPosition),d.set("text",i)):(g=f.START+" "+g+" "+f.END,h.insertContentAtFocusPoint(g)),this.markUpdated())},_throttle:function(a,b){var c=null;return function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,e)},b)}},_updatePreview:function(b){var c,d,g,h=this._content.one(e.EQUATION_TEXT),i=h.get("value"),j=h.get("selectionStart"),k="",l="\\Downarrow ";for(b&&b.preventDefault(),j||(j=0);"\\"===i.charAt(j)&&j>=0;)j-=1;if(d=/[a-zA-Z\{\}]/,0!==j)for(;d.test(i.charAt(j))&&j<i.length&&d.test(i.charAt(j-1));)j+=1;this._lastCursorPos=j,i=k+i.substring(0,j)+l+i.substring(j),i=f.START+" "+i+" "+f.END,c=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",g={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:i},a.io(c,{context:this,data:g,timeout:500,on:{complete:this._loadPreview}})},_loadPreview:function(a,b){var c=this._content.one(e.EQUATION_PREVIEW);200===b.status&&(c.setHTML(b.responseText),require(["core/event"],function(a){a.notifyFilterContentUpdated(c.getDOMNode())}))},_getDialogueContent:function(){var b=this._getLibraryContent(),f=this._throttle(this._updatePreview,500),h=a.Handlebars.compile(g.FORM);return this._content=a.Node.create(h({elementid:this.get("host").get("elementid"),component:c,library:b,texdocsurl:this.get("texdocsurl"),CSS:d})),this._content.all(e.LIBRARY_GROUP).each(function(a){this._setGroupTabFocus(a,a.one("button")),a.all("button a").setAttribute("tabindex","-1")},this),this._content.delegate("key",this._groupNavigation,"down:37,39",e.LIBRARY_BUTTON,this),this._content.one(e.SUBMIT).on("click",this._setEquation,this),this._content.one(e.EQUATION_TEXT).on("valuechange",f,this),this._content.one(e.EQUATION_TEXT).on("mouseup",f,this),this._content.one(e.EQUATION_TEXT).on("keyup",f,this),this._content.delegate("click",this._selectLibraryItem,e.LIBRARY_BUTTON,this),this._content},_groupNavigation:function(a){a.preventDefault();var b,c=a.currentTarget,d=c.get("parentNode"),e=d.all("button"),f=37!==a.keyCode?1:-1,g=e.indexOf(c);g<0&&(g=0),g+=f,g<0?g=e.size()-1:g>=e.size()&&(g=0),b=e.item(g),this._setGroupTabFocus(d,b),b.focus()},_setGroupTabFocus:function(a,b){var c=a.generateID();"undefined"!=typeof this._groupFocus[c]&&this._groupFocus[c].setAttribute("tabindex","-1"),this._groupFocus[c]=b,b.setAttribute("tabindex",0),a.setAttribute("aria-activedescendant",b.generateID())},_selectLibraryItem:function(a){var b,c,d,e=a.currentTarget.getAttribute("data-tex"),f=0;a.preventDefault(),this._setGroupTabFocus(a.currentTarget.get("parentNode"),a.currentTarget),d=a.currentTarget.ancestor(".atto_form").one("textarea"),b=d.get("value"),c=b.substring(0,this._lastCursorPos)," "!==c.charAt(c.length-1)&&(c+=" "),c+=e,f=c.length," "!==b.charAt(this._lastCursorPos)&&(c+=" "),c+=b.substring(this._lastCursorPos,b.length),d.set("value",c),d.focus();var g=d.getDOMNode();if("number"==typeof g.selectionStart)g.selectionStart=g.selectionEnd=f;else if("undefined"!=typeof g.createTextRange){var h=g.createTextRange();h.moveToPoint(f),h.select()}this._updatePreview(!1)},_getLibraryContent:function(){var b=a.Handlebars.compile(g.LIBRARY),e=this.get("library"),h="";a.Handlebars.registerHelper("split",function(a,b,c){var d,e,f;if("undefined"==typeof a||"undefined"==typeof b)return"";for(f="",d=b.trim().split(a);d.length>0;)e=d.shift().trim(),f+=c.fn(e);return f}),h=b({elementid:this.get("host").get("elementid"),component:c,library:e,CSS:d,DELIMITERS:f});var i=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",j={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:h},k=a.io(i,{sync:!0,data:j,method:"POST"});return 200===k.status&&(h=k.responseText),h}},{ATTRS:{texfilteractive:{value:!1},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview","array-extras"]});