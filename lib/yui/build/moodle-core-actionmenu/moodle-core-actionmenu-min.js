YUI.add("moodle-core-actionmenu",function(a,b){var c,d=a.one(a.config.doc.body),e={MENUSHOWN:"action-menu-shown"},f={CAN_RECEIVE_FOCUS_SELECTOR:'input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]',MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",MENUBAR:'[role="menubar"]',MENUITEM:'[role="menuitem"]',MENUCONTENT:".menu[data-rel=menu-content]",MENUCONTENTCHILD:"li a",MENUCHILD:".menu li a",TOGGLE:".toggle-display",KEEPOPEN:'[data-keepopen="1"]',MENUBARITEMS:['[role="menubar"] > [role="menuitem"]','[role="menubar"] > [role="presentation"] > [role="menuitem"]'],MENUITEMS:['> [role="menuitem"]','> [role="presentation"] > [role="menuitem"]']},g={TL:"tl",TR:"tr",BL:"bl",BR:"br"};c=function(){c.superclass.constructor.apply(this,arguments)},c.prototype={dialogue:null,events:[],owner:null,menulink:null,menuChildren:null,firstMenuChild:null,lastMenuChild:null,initializer:function(){a.all(f.MENU).each(this.enhance,this),d.delegate("key",this.moveMenuItem,"down:37,39",f.MENUBARITEMS.join(","),this),d.delegate("click",this.toggleMenu,f.MENU+" "+f.TOGGLE,this),d.delegate("key",this.showIfHidden,"down:enter,38,40",f.MENU+" "+f.TOGGLE,this),d.delegate("key",function(a){a.currentTarget.simulate("click"),a.preventDefault()},"down:32",f.MENUBARITEMS.join(","))},enhance:function(a){var b,c=a.one(f.MENUCONTENT);return!!c&&(b=c.getData("align")||this.get("align").join("-"),a.one(f.TOGGLE).set("aria-haspopup",!0),c.set("aria-hidden",!0),c.hasClass("align-"+b)||c.addClass("align-"+b),void(c.getDOMNode().childElementCount&&a.setAttribute("data-enhanced","1")))},moveMenuItem:function(a){var b,c=a.target.ancestor(f.MENUITEM,!0);return 37===a.keyCode?b=this.getMenuItem(c,!0):39===a.keyCode&&(b=this.getMenuItem(c)),b&&b.focus(),this},getMenuItem:function(a,b){var c,d,e=a.ancestor(f.MENUBAR);if(!e)return null;if(c=e.all(f.MENUITEMS.join(",")),!c)return null;var g=c.size();if(1===g)return null;var h=0,i=1,j=0;for(h=0;h<g&&c.item(h)!==a;h++);if(c.item(h)!==a)return null;b&&(i=-1);do h+=i,d=c.item(h),j++;while(d&&d.hasAttribute("hidden"));return d},hideMenu:function(a){this.dialogue&&(this.dialogue.removeClass("show"),this.dialogue.one(f.MENUCONTENT).set("aria-hidden",!0),this.dialogue=null);for(var b in this.events)this.events[b].detach&&this.events[b].detach();this.events=[],this.owner&&(this.owner.removeClass(e.MENUSHOWN),this.owner=null),this.menulink&&("click"!=a.type&&this.menulink.focus(),this.menulink=null)},showIfHidden:function(a){var b=a.target.ancestor(f.MENU),c=b.hasClass("show");return c||(a.preventDefault(),this.showMenu(a,b)),this},toggleMenu:function(a){var b=a.target.ancestor(f.MENU),c=b.hasClass("show");a.halt(!0),this.hideMenu(a),c||this.showMenu(a,b)},handleKeyboardEvent:function(a){var b,c=function(a){a.preventDefault(),a.stopPropagation()};if(a.currentTarget.ancestor(f.TOGGLE,!0))return(40===a.keyCode||9===a.keyCode&&!a.shiftKey)&&this.firstMenuChild?(this.firstMenuChild.focus(),c(a)):38===a.keyCode&&this.lastMenuChild?(this.lastMenuChild.focus(),c(a)):9===a.keyCode&&a.shiftKey&&(this.hideMenu(a),c(a)),this;if(27===a.keyCode)this.hideMenu(a),c(a);else if(32===a.keyCode)c(a),a.currentTarget.simulate("click");else if(9===a.keyCode)a.target===this.firstMenuChild&&a.shiftKey?(this.hideMenu(a),c(a)):a.target!==this.lastMenuChild||a.shiftKey||this.hideMenu(a)&&(b=this.menulink.next(f.CAN_RECEIVE_FOCUS_SELECTOR),b&&(b.focus(),c(a)));else if(38===a.keyCode||40===a.keyCode){for(var d=!1,e=0,g=1,h=0;!d&&e<this.menuChildren.size();)this.menuChildren.item(e)===a.currentTarget?d=!0:e++;if(!d)return;38===a.keyCode&&(g=-1);do e+=g,e<0?e=this.menuChildren.size()-1:e>=this.menuChildren.size()&&(e=0),b=this.menuChildren.item(e),h++;while(h<this.menuChildren.size()&&b!==a.currentTarget&&b.hasClass("hidden"));b&&(b.focus(),c(a))}},hideIfOutside:function(a){a.target.ancestor(f.MENUCONTENT,!0)||this.hideMenu(a)},showMenu:function(a,b){var c=b.getData("owner"),g=b.one(f.MENUCONTENT);return this.owner=c?b.ancestor(c):null,this.dialogue=b,b.addClass("show"),this.owner?(this.owner.addClass(e.MENUSHOWN),this.menulink=this.owner.one(f.TOGGLE)):this.menulink=a.target.ancestor(f.TOGGLE,!0),this.constrain(g.set("aria-hidden",!1)),this.menuChildren=this.dialogue.all(f.MENUCHILD),this.menuChildren.size()>0&&(this.firstMenuChild=this.menuChildren.item(0),this.lastMenuChild=this.menuChildren.item(this.menuChildren.size()-1),this.firstMenuChild.focus()),this.events.push(d.on("key",this.hideMenu,"esc",this)),this.events.push(d.on("click",this.hideIfOutside,this)),this.events.push(d.delegate("focus",this.hideIfOutside,"*",this)),this.events.push(b.delegate("key",this.handleKeyboardEvent,"down:9, 27, 38, 40, 32",f.MENUCHILD+", "+f.TOGGLE,this)),this.events.push(b.delegate("click",function(a){a.currentTarget.test(f.KEEPOPEN)||this.hideMenu(a)},f.MENUCHILD,this)),!0},constrain:function(a){var b,c,d=a.getData("constraint"),e=a.getX(),f=a.getY(),g=a.get("offsetWidth"),h=a.get("offsetHeight"),i=0,j=0,k="auto",l=null,m=null,n=null,o=null,p=null;if(d&&(d=a.ancestor(d)),d?(b=d.get("offsetWidth"),c=d.get("offsetHeight"),i=d.getX(),j=d.getY(),k=d.getStyle("overflow")||"auto"):(b=a.get("docWidth"),c=a.get("docHeight")),g>b?(l=g=b,n=e=i):e<i?n=e=i:e+g>=i+b&&(n=i+b-g),h>c&&"hidden"===k.toLowerCase()&&(m=h=c,a.setStyle("overflow","auto")),f>=j&&f+h>j+c){o=j+c-h;try{p=a.getStyle("boxShadow").replace(/.*? (\d+)px \d+px$/,"$1"),new RegExp(/^\d+$/).test(p)&&o-j>p&&(o-=p)}catch(q){}}null!==n&&a.setX(n),null!==o&&a.setY(o),null!==l&&a.setStyle("width",l.toString()+"px"),null!==m&&a.setStyle("height",m.toString()+"px")}},a.extend(c,a.Base,c.prototype,{NAME:"moodle-core-actionmenu",ATTRS:{align:{value:[g.TR,g.BR]}}}),M.core=M.core||{},M.core.actionmenu=M.core.actionmenu||{},M.core.actionmenu.instance=null,M.core.actionmenu.init=M.core.actionmenu.init||function(a){M.core.actionmenu.instance=M.core.actionmenu.instance||new c(a)},M.core.actionmenu.newDOMNode=function(a){return null===M.core.actionmenu.instance||void a.all(f.MENU).each(M.core.actionmenu.instance.enhance,M.core.actionmenu.instance)}},"@VERSION@",{requires:["base","event","node-event-simulate"]});