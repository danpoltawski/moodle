YUI.add("moodle-core-blocks",function(a,b){var c="/lib/ajax/blocks.php",d={BLOCK:"block",BLOCKREGION:"block-region",BLOCKADMINBLOCK:"block_adminblock",EDITINGMOVE:"editing_move",HEADER:"header",LIGHTBOX:"lightbox",REGIONCONTENT:"region-content",SKIPBLOCK:"skip-block",SKIPBLOCKTO:"skip-block-to",MYINDEX:"page-my-index",REGIONMAIN:"region-main",BLOCKSMOVING:"blocks-moving"},e={DRAGHANDLE:"."+d.HEADER+" .commands .moodle-core-dragdrop-draghandle"},f=function(){f.superclass.constructor.apply(this,arguments)};a.extend(f,M.core.dragdrop,{skipnodetop:null,skipnodebottom:null,dragsourceregion:null,initializer:function(){this.groups=["block"],this.samenodeclass=d.BLOCK,this.parentnodeclass=d.REGIONCONTENT;var b=a.Node.all("body#"+d.MYINDEX+" #"+d.REGIONMAIN+" > ."+d.REGIONCONTENT);if(b.size()>0){var c=b.item(0);c.addClass(d.BLOCKREGION),c.set("id",d.REGIONCONTENT),c.one("div").addClass(d.REGIONCONTENT)}var f=a.Node.all("div."+d.BLOCKREGION);if(0===f.size())return!1;if(f.size()!==this.get("regions").length){var g=a.Node.create("<div></div>").addClass(d.BLOCKREGION),h=a.Node.create("<div></div>").addClass(d.REGIONCONTENT);g.appendChild(h);var i=f.filter("#region-pre"),j=f.filter("#region-post");0===i.size()&&1===j.size()?(g.setAttrs({id:"region-pre"}),j.item(0).insert(g,"before"),f.unshift(g)):0===j.size()&&1===i.size()&&(g.setAttrs({id:"region-post"}),i.item(0).insert(g,"after"),f.push(g))}f.each(function(b){new a.DD.Drop({node:b.one("div."+d.REGIONCONTENT),groups:this.groups,padding:"40 240 40 240"});var c=new a.DD.Delegate({container:b,nodes:"."+d.BLOCK,target:!0,handles:[e.DRAGHANDLE],invalid:".block-hider-hide, .block-hider-show, .moveto",dragConfig:{groups:this.groups}});c.dd.plug(a.Plugin.DDProxy,{moveOnEnd:!1}),c.dd.plug(a.Plugin.DDWinScroll);var f=b.all("."+d.BLOCK);f.each(function(a){var b=a.one("a."+d.EDITINGMOVE);b&&(b.replace(this.get_drag_handle(b.getAttribute("title"),"","iconsmall",!0)),a.one(e.DRAGHANDLE).setStyle("cursor","move"))},this)},this)},get_block_id:function(a){return Number(a.get("id").replace(/inst/i,""))},get_block_region:function(b){var c=b.ancestor("div."+d.BLOCKREGION).get("id").replace(/region-/i,"");return a.Array.indexOf(this.get("regions"),c)===-1?(window.right_to_left()&&("post"===c?c="pre":"pre"===c&&(c="post")),"side-"+c):c},get_region_id:function(a){return a.get("id").replace(/region-/i,"")},drag_start:function(b){var c=b.target;this.dragsourceregion=c.get("node").ancestor("div."+d.BLOCKREGION),c.get("node").previous()&&c.get("node").previous().hasClass(d.SKIPBLOCK)&&(this.skipnodetop=c.get("node").previous()),c.get("node").next()&&c.get("node").next().hasClass(d.SKIPBLOCKTO)&&(this.skipnodebottom=c.get("node").next()),a.one("body").addClass(d.BLOCKSMOVING)},drop_over:function(b){var c=b.drag.get("node"),e=b.drop.get("node");if(e.hasClass(this.parentnodeclass)&&e.one("."+d.BLOCKADMINBLOCK)&&e.one("."+d.BLOCKADMINBLOCK).next("."+d.BLOCK)&&e.prepend(c),this.dragsourceregion.contains(e))return!1;var f=a.one("body"),g=this.get_region_id(this.dragsourceregion);f.hasClass("side-"+g+"-only")&&f.removeClass("side-"+g+"-only"),g=this.get_region_id(e.ancestor("div."+d.BLOCKREGION)),0===this.dragsourceregion.all("."+d.BLOCK).size()&&this.dragsourceregion.get("id").match(/(region-pre|region-post)/i)&&(f.hasClass("side-"+g+"-only")||f.addClass("side-"+g+"-only"))},drag_end:function(){this.skipnodetop=null,this.skipnodebottom=null,this.dragsourceregion=null,a.one("body").removeClass(d.BLOCKSMOVING)},drag_dropmiss:function(a){this.drop_hit(a)},drop_hit:function(b){var e=b.drag,f=e.get("node"),g=b.drop.get("node");f.previous()&&f.previous().hasClass(d.SKIPBLOCK)&&f.insert(f.previous(),"after"),this.skipnodetop&&f.insert(this.skipnodetop,"before"),this.skipnodebottom&&f.insert(this.skipnodebottom,"after");var h=M.util.add_lightbox(a,f),i={sesskey:M.cfg.sesskey,courseid:this.get("courseid"),pagelayout:this.get("pagelayout"),pagetype:this.get("pagetype"),subpage:this.get("subpage"),contextid:this.get("contextid"),action:"move",bui_moveid:this.get_block_id(f),bui_newregion:this.get_block_region(g)};this.get("cmid")&&(i.cmid=this.get("cmid")),f.next("."+this.samenodeclass)&&!f.next("."+this.samenodeclass).hasClass(d.BLOCKADMINBLOCK)&&(i.bui_beforeid=this.get_block_id(f.next("."+this.samenodeclass))),a.io(M.cfg.wwwroot+c,{method:"POST",data:i,on:{start:function(){h.show()},success:function(b,c){window.setTimeout(function(){h.hide()},250);try{var d=a.JSON.parse(c.responseText);d.error&&new M.core.ajaxException(d)}catch(e){}},failure:function(a,b){this.ajax_failure(b),h.hide()}},context:this})}},{NAME:"core-blocks-dragdrop",ATTRS:{courseid:{value:null},cmid:{value:null},contextid:{value:null},pagelayout:{value:null},pagetype:{value:null},subpage:{value:null},regions:{value:null}}}),M.core=M.core||{},M.core.blockdraganddrop=M.core.blockdraganddrop||{},M.core.blockdraganddrop._isusingnewblocksmethod=null,M.core.blockdraganddrop.is_using_blocks_render_method=function(){if(null===this._isusingnewblocksmethod){var b=a.all(".block-region[data-blockregion]").size(),c=a.all(".block-region").size();this._isusingnewblocksmethod=c===b}return this._isusingnewblocksmethod},M.core.blockdraganddrop.init=function(a){this.is_using_blocks_render_method()?new g(a):new f(a)},M.core_blocks=M.core_blocks||{},M.core_blocks.init_dragdrop=function(a){M.core.blockdraganddrop.init(a)};var g=function(){g.superclass.constructor.apply(this,arguments)};g.prototype={skipnodetop:null,skipnodebottom:null,regionobjects:{},initializer:function(){var b,c,f,g=this.get("regions"),i=0;this.groups=["block"],this.samenodeclass=d.BLOCK,this.parentnodeclass=d.BLOCKREGION;var j=a.Node.all("body#"+d.MYINDEX+" #"+d.REGIONMAIN+" > ."+d.REGIONCONTENT);if(j.size()>0){var k=j.item(0);k.addClass(d.BLOCKREGION),k.set("id",d.REGIONCONTENT),k.one("div").addClass(d.REGIONCONTENT)}for(i in g)c=g[i],b=new h({manager:this,region:c,node:a.one("#block-region-"+c)}),this.regionobjects[c]=b,new a.DD.Drop({node:b.get_droptarget(),groups:this.groups,padding:"40 240 40 240"}),f=new a.DD.Delegate({container:b.get_droptarget(),nodes:"."+d.BLOCK,target:!0,handles:[e.DRAGHANDLE],invalid:".block-hider-hide, .block-hider-show, .moveto, .block_fake",dragConfig:{groups:this.groups}}),f.dd.plug(a.Plugin.DDProxy,{moveOnEnd:!1}),f.dd.plug(a.Plugin.DDWinScroll),a.DD.DDM.on("ddm:start",this.enable_all_regions,this),b.change_block_move_icons(this)},get_block_id:function(a){return Number(a.get("id").replace(/inst/i,""))},get_block_region:function(a){return a.test("[data-blockregion]")||(a=a.ancestor("[data-blockregion]")),a.getData("blockregion")},get_region_object:function(a){return this.regionobjects[this.get_block_region(a)]},enable_all_regions:function(){var b=a.DD.DDM.activeDrag.get("groups");if(b&&a.Array.indexOf(b,"block")!==-1){var c;for(c in this.regionobjects)this.regionobjects.hasOwnProperty(c)&&this.regionobjects[c].enable()}},disable_regions_if_required:function(){var a=0;for(a in this.regionobjects)this.regionobjects[a].disable_if_required()},drag_start:function(a){var b=a.target;b.get("node").previous()&&b.get("node").previous().hasClass(d.SKIPBLOCK)&&(this.skipnodetop=b.get("node").previous()),b.get("node").next()&&b.get("node").next().hasClass(d.SKIPBLOCKTO)&&(this.skipnodebottom=b.get("node").next())},drop_over:function(a){var b=a.drag.get("node"),c=a.drop.get("node");c.hasClass(d.REGIONCONTENT)&&c.one("."+d.BLOCKADMINBLOCK)&&c.one("."+d.BLOCKADMINBLOCK).next("."+d.BLOCK)&&c.prepend(b)},drop_end:function(){this.skipnodetop=null,this.skipnodebottom=null,this.disable_regions_if_required()},drag_dropmiss:function(a){this.drop_hit(a)},drop_hit:function(b){var e=b.drag.get("node"),f=b.drop.get("node");e.previous()&&e.previous().hasClass(d.SKIPBLOCK)&&e.insert(e.previous(),"after"),this.skipnodetop&&e.insert(this.skipnodetop,"before"),this.skipnodebottom&&e.insert(this.skipnodebottom,"after");var g=M.util.add_lightbox(a,e),h={sesskey:M.cfg.sesskey,courseid:this.get("courseid"),pagelayout:this.get("pagelayout"),pagetype:this.get("pagetype"),subpage:this.get("subpage"),contextid:this.get("contextid"),action:"move",bui_moveid:this.get_block_id(e),bui_newregion:this.get_block_region(f)};this.get("cmid")&&(h.cmid=this.get("cmid")),e.next("."+d.BLOCK)&&!e.next("."+d.BLOCK).hasClass(d.BLOCKADMINBLOCK)&&(h.bui_beforeid=this.get_block_id(e.next("."+d.BLOCK))),a.io(M.cfg.wwwroot+c,{method:"POST",data:h,on:{start:function(){g.show()},success:function(b,c){window.setTimeout(function(){g.hide()},250);try{var d=a.JSON.parse(c.responseText);d.error&&new M.core.ajaxException(d)}catch(e){}},failure:function(a,b){this.ajax_failure(b),g.hide()},complete:function(){this.disable_regions_if_required()}},context:this})}},a.extend(g,M.core.dragdrop,g.prototype,{NAME:"core-blocks-dragdrop-manager",ATTRS:{courseid:{value:null},cmid:{value:null},contextid:{value:null},pagelayout:{value:null},pagetype:{value:null},subpage:{value:null},regions:{value:[]}}});var h=function(){h.superclass.constructor.apply(this,arguments)};h.prototype={initializer:function(){var b=this.get("node");b||(b=this.create_and_add_node());var c=a.one("body"),e=b.all("."+d.BLOCK).size()>0,f=this.get_has_region_class();this.set("hasblocks",e),c.hasClass(f)||c.addClass(f),c.addClass(e?this.get_used_region_class():this.get_empty_region_class()),c.removeClass(e?this.get_empty_region_class():this.get_used_region_class())},create_and_add_node:function(){var b,c,e,f=a.Node.create,g=this.get("region"),h=f('<div id="block-region-'+g+'" data-droptarget="1"></div>').addClass(d.BLOCKREGION).setData("blockregion",g),i=this.get("manager").get("regions"),j=!1,k=!1,l=!1;for(b in i)i[b].match(/(pre|left)/)?j=i[b]:i[b].match(/(post|right)/)&&(k=i[b]);return j!==!1&&k!==!1&&(g===j?(e=a.one("#block-region-"+k),e&&(e.insert(h,"before"),l=!0)):(c=a.one("#block-region-"+j),c&&(c.insert(h,"after"),l=!0))),l===!1&&a.one("body").append(h),this.set("node",h),h},change_block_move_icons:function(a){var b,c;this.get("node").all("."+d.BLOCK+" a."+d.EDITINGMOVE).each(function(d){d.setStyle("cursor","move"),b=a.get_drag_handle(d.getAttribute("title"),"","icon",!0),c=b.one("img"),c.addClass("iconsmall"),c.removeClass("icon"),d.replace(b)})},get_has_region_class:function(){return"has-region-"+this.get("region")},get_empty_region_class:function(){return"empty-region-"+this.get("region")},get_used_region_class:function(){return"used-region-"+this.get("region")},get_droptarget:function(){var a=this.get("node");return a.test('[data-droptarget="1"]')?a:a.one('[data-droptarget="1"]')},enable:function(){a.one("body").addClass(this.get_used_region_class()).removeClass(this.get_empty_region_class())},disable_if_required:function(){0===this.get("node").all("."+d.BLOCK).size()&&a.one("body").addClass(this.get_empty_region_class()).removeClass(this.get_used_region_class())}},a.extend(h,a.Base,h.prototype,{NAME:"core-blocks-dragdrop-blockregion",ATTRS:{manager:{writeOnce:"initOnly",validator:function(b){return a.Lang.isObject(b)&&b instanceof g}},region:{writeOnce:"initOnly",validator:function(b){return a.Lang.isString(b)}},node:{validator:function(b){return a.Lang.isObject(b)||a.Lang.isNull(b)}},hasblocks:{value:!1,validator:function(b){return a.Lang.isBoolean(b)}}}})},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification"]});