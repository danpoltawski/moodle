YUI.add("moodle-core_outcome-editoutcome",function(e,t){var n=e.Lang,r,i,s="outcomeList",o=new M.core_outcome.OutcomeList,u,a="contentBox",f="srcNode",l="#outcome_edit_panel",c="#outcome_move_panel",h="editPanel",p="movePanel",d="a[data-action=add]",v="a[data-action=edit]",m="a[data-action=move]",g="a[data-action=delete]",y="div[data-action=folder]",b="input[type=hidden]",w="#outcome_id",E="input[name=id]",S="#id_idnumber",x="#outcome_parentid",T="input[name=outcome_docnum]",N="input[name=outcome_idnumber]",C="input[name=outcome_subjects]",k="input[name=outcome_edulevels]",L="input[name=outcome_assessable]",A="textarea[name=outcome_description]",O="select[name=outcome_reference]",_="select[name=outcome_placement]",D="div[data-errorcode=outcomesetidnumberchange]",P="div[data-errorcode=outcomeidnumberchange]",H="label.move_label",B=".error",j,F,I='{{#if modified}}<div class="{{className "modified"}}">'+M.str.outcome.outcomemodified+"</div>"+"{{/if}}"+'<a href="#" data-id="0" data-action="add">'+M.str.outcome.addoutcome+"</a> "+"{{{outcomeList outcomes}}}",q='{{#if outcomes}}<ul tabindex="-1">{{#each outcomes}}<li id="outcome_wrapper_{{id}}"><div class="{{className "row"}}"><div id="outcome_{{id}}" tabindex="0" data-id="{{id}}" class="{{className "outcome"}} {{#if assessable}}{{className "assessable"}} {{/if}}{{#if opened}}{{className "folder" "opened"}}{{/if}}{{#if closed}}{{className "folder" "closed"}}{{/if}}{{#if leaf}}{{className "leaf"}}{{/if}}"{{#if children}} data-action="folder" role="button"{{/if}}>{{{docnum}}} {{{description}}}</div><div class="{{className "actions"}}"><a href="#" data-id="{{id}}" role="button" data-action="add" title="{{{title "addchildoutcome" description}}}">'+M.str.outcome.add+"</a> "+'<a href="#" data-id="{{id}}" role="button" data-action="edit" title="'+'{{{title "editx" description}}}'+'">'+M.str.outcome.edit+"</a> "+'<a href="#" data-id="{{id}}" role="button" data-action="move" title="'+'{{{title "movex" description}}}'+'">'+M.str.outcome.move+"</a> "+'<a href="#" data-id="{{id}}" role="button" data-action="delete" title="'+'{{{title "deletex" description}}}'+'">'+M.str.outcome.delete+"</a>"+"</div>"+"</div>"+"{{#if opened}}"+"{{{outcomeList children}}}"+"{{/if}}"+"</li>"+"{{/each}}"+"</ul>"+"{{/if}}",R=function(e,t){return M.util.get_string(e,"outcome",t)},U=function(e){return F({outcomes:e})},z=function(){var n=e.Array(arguments);return n.unshift(t),n.pop(),e.ClassNameManager.getClassName.apply(e.ClassNameManager,n)},W=function(){W.superclass.constructor.apply(this,arguments)};e.extend(W,e.Widget,{initializer:function(){try{if(this.get("dataNode")){var t=this.get("dataNode").get("value");if(t.length>0){var n=e.JSON.parse(t);this.get(s).add(n)}}}catch(r){r.visible=!0,new M.core.exception(r)}e.one(S).on("valuechange",this._handle_unique_id_change,this,{original:e.one(S).get("value"),errorNode:e.one(D)})},renderUI:function(){e.Handlebars.registerHelper("title",R),e.Handlebars.registerHelper("outcomeList",U),e.Handlebars.registerHelper("className",z),F=e.Handlebars.compile(q),j=e.Handlebars.compile(I),this._update_ui()},bindUI:function(){this.get(a).delegate("click",this._handle_add,d,this),this.get(a).delegate("click",this._handle_edit,v,this),this.get(a).delegate("click",this._handle_move,m,this),this.get(a).delegate("click",this._handle_delete,g,this),this.get(a).delegate("click",this._handle_folder,y,this),this.get(a).delegate("key",this._handle_folder,"enter",y,this)},_update_ui:function(){this.get(s).sort();var t=this.get(s).toJSON(),r=this.get(s).filter_by_modified(),i=e.Array.filter(t,function(r){return r.children=e.Array.filter(t,function(e){return e.parentid===r.id&&e.deleted===0}),!n.isNull(o.getById(r.id))&&r.children.length>0?r.opened=!0:r.children.length>0?r.closed=!0:r.leaf=!0,n.isNull(r.parentid)&&r.deleted===0}),u=j({outcomes:i,modified:r.length>0});this.get(a).setHTML(u),this.get(s).size()===1&&this.get(a).all(m).hide(),this.get("saveNode").set("value",e.JSON.stringify(r)),this.get("dataNode").set("value",e.JSON.stringify(this.get(s).toJSON()))},_update_ui_and_focus:function(e){this._open_parents(e),this._update_ui(),this.get(a).one("#outcome_"+e.get("id")).focus()},_handle_add:function(e){e.preventDefault(),r=e.target,this._populate_edit_panel(new M.core_outcome.OutcomeModel({parentid:e.target.getData("id")})),this.get(h).show()},_handle_edit:function(e){e.preventDefault(),r=e.target;var t=this.get(s).getById(e.target.getData("id"));this._populate_edit_panel(t),this.get(h).show()},_handle_move:function(t){t.preventDefault(),r=t.target,u=this.get(s).getById(t.target.getData("id"));var n=this.get(p).get(f);n.one(H).set("text",M.util.get_string("movex","outcome",u.get_short_description())),n.one(_).set("value","child");var i=n.one(O);i.setContent(""),e.Array.each(this.get(s).filter_out_branch(u),function(t){if(t.get("deleted")==1)return;i.appendChild(e.Node.create("<option></option>").set("value",t.get("id")).setContent(this._menu_prefix(t)+e.Escape.html(t.get_short_description())))},this),this.get(p).show()},_handle_delete:function(e){e.preventDefault();var t=this.get(s).getById(e.target.getData("id"));this.get(s).remove_outcome(t),this._update_ui()},_handle_folder:function(e){e.preventDefault();var t=this.get(s).getById(e.target.getData("id"));n.isNull(o.getById(t.get("id")))?(o.add(t),this._update_ui(),this.get(a).one("#outcome_wrapper_"+t.get("id")+" ul").focus()):(o.remove(t),this._update_ui(),this.get(a).one("#outcome_"+t.get("id")).focus())},_populate_edit_panel:function(t){var r=this.get(h).get(f),s=0;t.isNew()||(s=t.get("id"));var o=function(e){return n.isNull(e)?"":e};e.one(w).set("value",s),e.one(x).set("value",t.get("parentid")),r.one(N).set("value",o(t.get("rawidnumber"))),r.one(T).set("value",o(t.get("rawdocnum"))),r.one(C).set("value",t.get("rawsubjects").join(", ")),r.one(k).set("value",t.get("rawedulevels").join(", ")),r.one(L).set("checked",t.get("assessable")),r.one(A).set("value",o(t.get("rawdescription"))),n.isUndefined(i
)||(i.detach(),i=undefined),!t.isNew()&&t.get("id")>0&&(i=r.one(N).on("valuechange",this._handle_unique_id_change,this,{original:r.one(N).get("value"),errorNode:e.one(P)})),this._clear_panel_errors(this.get(h))},_handle_edit_panel_save:function(t){t.preventDefault();var r=this.get(h).get(f),i=e.one(w).get("value"),o=this.get(s),u=new M.core_outcome.OutcomeModel;i!=0&&u.setAttrs(this.get(s).getById(i).toJSON());var a={parentid:e.one(x).get("value"),outcomesetid:e.one(E).get("value"),rawidnumber:r.one(N).get("value"),rawdocnum:r.one(T).get("value"),rawsubjects:this._split(r.one(C).get("value")),rawedulevels:this._split(r.one(k).get("value")),rawdescription:r.one(A).get("value")};r.one(L).get("checked")?a.assessable=1:a.assessable=0,u.setAttrs(a),u.validate_and_update(function(e){o.some(function(t){return t.get("idnumber")===u.get("idnumber")&&t.get("id")!==u.get("id")?(n.isArray(e)||(e=[]),e.push("outcomeidnumbernotunique"),!0):!1}),this._handle_edit_panel_validation(u,e)},this)},_handle_edit_panel_validation:function(t,i){if(n.isArray(i)){this._clear_panel_errors(this.get(h)),e.Array.each(i,function(e){this.get(h).get(f).one("div[data-errorcode="+e+"]").show()},this);return}r=undefined,this.get(h).hide(),this.get(s).add_new_outcome(t),this._update_ui_and_focus(t)},_handle_move_panel_save:function(e){e.preventDefault(),r=undefined,this.get(p).hide();var t=this.get(p).get(f),n=this.get(s).getById(t.one(O).get("value")),i=this.get(s).find_new_position(n,t.one(_).get("value"));this.get(s).move_outcome(u,i),this._update_ui_and_focus(u)},_handle_unique_id_change:function(e,t){t.original===e.target.get("value")||t.original===""?t.errorNode.hide():t.errorNode.show()},_create_panel:function(t,n,i){var s=new M.core.dialogue({headerContent:n,centered:!0,width:"",render:!0,visible:!1,modal:!0});return s.set("bodyContent",e.one(t)),s.get("boundingBox").addClass(this.getClassName("panel")),s.after("visibleChange",function(t){!t.newVal&&r instanceof e.Node&&(r.focus(),r=undefined)}),s.addButton({value:M.str.outcome.ok,action:i,context:this}),s.addButton({value:M.str.moodle.cancel,action:function(e){e.preventDefault(),this.hide()}}),s},_create_edit_panel:function(){return this._create_panel(l,M.str.outcome.addoutcome,this._handle_edit_panel_save)},_create_move_panel:function(){return this._create_panel(c,M.str.outcome.moveoutcome,this._handle_move_panel_save)},_clear_panel_errors:function(e){e.get(f).all(B).hide()},_split:function(t){return n.trim(t)===""?[]:e.Array.unique(e.Array.map(t.split(","),n.trim),function(e,t){return e.toLowerCase()===t.toLowerCase()})},_repeat:function(e,t){return(new Array(1+t)).join(e)},_menu_prefix:function(e){var t=this.get(s).get_depth(e);return t>0?this._repeat("&nbsp;",t*2)+"-&nbsp;":""},_open_parents:function(e){var t=e;while(!n.isNull(t.get("parentid")))t=this.get(s).getById(t.get("parentid")),o.add(t)},_node_input_hidden_validator:function(t){return e.one(t)instanceof e.Node&&e.one(t).test(b)},_node_setter:function(t){return e.one(t)}},{NAME:t,ATTRS:{dataNode:{validator:"_node_input_hidden_validator",setter:"_node_setter",writeOnce:!0},saveNode:{validator:"_node_input_hidden_validator",setter:"_node_setter",writeOnce:!0},outcomeList:{readOnly:!0,valueFn:function(){return new M.core_outcome.OutcomeList}},editPanel:{readOnly:!0,valueFn:"_create_edit_panel"},movePanel:{readOnly:!0,valueFn:"_create_move_panel"}}}),M.core_outcome=M.core_outcome||{},M.core_outcome.editoutcome=W,M.core_outcome.init_editoutcome=function(e){var t=new W(e);return t.get("dataNode")&&t.render(),t}},"@VERSION@",{requires:["widget","event-valuechange","handlebars","json-parse","json-stringify","moodle-core_outcome-models","moodle-core-notification-dialogue","moodle-core-notification-exception"]});
