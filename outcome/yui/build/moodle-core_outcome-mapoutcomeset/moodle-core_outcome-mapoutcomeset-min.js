YUI.add("moodle-core_outcome-mapoutcomeset",function(e,t){var n=e.Lang,r,i,s,o,u=[],a=[],f={},l,c,h=M.util.image_url("t/delete","core"),p="filterList",d="contentBox",v="srcNode",m="panel",g="input[type=hidden]",y="a[data-action=add]",b="a[data-action=delete]",w="#add_button",E="#outcomesets",S="#edulevels",x="#subjects",T,N,C='{{#unless isFrozen}}<a href="#" data-id="0" data-action="add" role="button">{{strselectoutcomesets}}</a> {{/unless}}{{#if filters}}<ul class="{{ulClass}}" tabindex="-1">{{#filters}}<li>{{#unless ../isFrozen}}<span class="actions"><a href="#" data-id="{{id}}" role="button" data-action="delete"><img src="{{../../urlImgDelete}}" /><span class="accesshide">{{{getString "deletex" name}}}</span></a></span>{{/unless}}&nbsp;<span id="outcomeset_{{id}}" tabindex="-1">{{{name}}}</span></li>{{/filters}}</ul>{{/if}}',k='<table role="presentation">{{#if filters}}<tr><th>{{stroutcomeset}}</th><th>{{strsubject}}</th><th>{{streducationlevel}}</th><th></th></tr>{{/if}}{{#filters}}<tr><td>{{{shorten name}}}</td><td>{{#if subjects}}{{{subjects}}}{{else}}{{../../strallsubjects}}{{/if}}</td><td>{{#if edulevels}}{{{edulevels}}}{{else}}{{../../stralleducationlevels}}{{/if}}</td><td></td></tr>{{/filters}}<tr><td><label for="outcomesets" class="accesshide">{{stroutcomeset}}</label><select id="outcomesets">{{#outcomesets}}<option value="{{id}}" {{selected id}}>{{{shorten name}}}</option>{{/outcomesets}}</select></td><td><label for="subjects" class="accesshide">{{strsubjects}}</label><select id="subjects" {{disableifempty subjects}}><option value="0">{{strallsubjects}}</option>{{#each subjects}}<option value="{{this.rawname}}">{{{this.name}}}</option>{{/each}}</select></td><td><label for="edulevels" class="accesshide">{{streducationlevels}}</label><select id="edulevels" {{disableifempty edulevels}}><option value="0">{{stralleducationlevels}}</option>{{#each edulevels}}<option value="{{this.rawname}}">{{{this.name}}}</option>{{/each}}</select></td><td><button id="add_button" {{disableifempty selectedoutcomeset}}>{{stradd}}</button></td></tr></table>',L=function(e,t){return M.util.get_string(e,"outcome",t)},A=function(e){return l==e?'selected="selected"':""},O=function(e){return M.core_outcome.shortenText(e,50)},_=function(e){var t=!0;return n.isArray(e)?t=e.length===0:n.isString(e)&&(t=e==="0"||e===""),t?'disabled="disabled"':""},D=function(){D.superclass.constructor.apply(this,arguments)};e.extend(D,e.Widget,{initializer:function(){r=new M.core_outcome.SimpleIO({contextId:this.get("contextId")})},renderUI:function(){e.Handlebars.registerHelper("getString",L),e.Handlebars.registerHelper("selected",A),e.Handlebars.registerHelper("disableifempty",_),e.Handlebars.registerHelper("shorten",O),T=e.Handlebars.compile(C),N=e.Handlebars.compile(k),i=e.Node.create("<div></div>"),i.addClass(this.getClassName("content","wrapper")),this.get(d).appendChild(i),this._update_ui()},bindUI:function(){this.get("isFrozen")||(this.get(d).delegate("click",this._handle_add,y,this),this.get(d).delegate("click",this._handle_delete,b,this))},_update_ui:function(){this.get(p).sort();var t=T({isFrozen:this.get("isFrozen"),filters:this.get(p).display_list(),ulClass:this.getClassName("filter","list"),urlImgDelete:h,strselectoutcomesets:M.str.outcome.selectoutcomesets});i.setHTML(t),this.get("saveNode").set("value",e.JSON.stringify(this.get(p).toJSON()))},_update_panel_ui:function(){var e=N({filters:o.toJSON(),outcomesets:c,edulevels:u,subjects:a,selectedoutcomeset:l,stroutcomeset:M.str.outcome.outcomeset,streducationlevel:M.str.outcome.educationlevel,strsubject:M.str.outcome.subject,strsubjects:M.str.outcome.subjects,strallsubjects:M.str.outcome.allsubjects,streducationlevels:M.str.outcome.educationlevels,stralleducationlevels:M.str.outcome.alleducationlevels,stradd:M.str.outcome.add});this.get(m).set("bodyContent",e),this.get(m).centered()},_reset_panel_ui:function(){u=[],a=[],l=undefined,this._update_panel_ui(),this._do_default_panel_focus()},_update_panel_ui_from_cache:function(e){u=f[e].edulevels,a=f[e].subjects,l=e,this._update_panel_ui(),this._do_default_panel_focus()},_do_default_panel_focus:function(){this.get(m).get(v).one(E).focus()},_handle_add:function(e){e.preventDefault(),s=e.target,o=new H,this._ensure_outcome_set_menu(function(){this._update_panel_ui(),this.get(m).show()})},_handle_delete:function(t){t.preventDefault();var n=t.target;n.test("a")||(n=n.ancestor("a"));var r=this.get(p).getById(n.getData("id"));this.get(p).remove(r),this._update_ui();var i=this.get(d).one("ul");i instanceof e.Node||(i=this.get(d).one(y)),i.focus()},_handle_panel_save:function(e){e.preventDefault(),this.get(m).get(v).one(E).get("value")!=0&&this._handle_add_button(e),this.get(p).add(o),this.get(m).hide(),this._update_ui(),this.get(d).one("ul").focus()},_handle_panel_cancel:function(e){e.preventDefault(),this.get(m).hide()},_handle_outcome_set_change:function(e){var t=e.target.get("value");if(t==="0"){this._reset_panel_ui();return}if(f[t]!==undefined){this._update_panel_ui_from_cache(t);return}r.send({action:"get_outcome_set_filter_menus",outcomesetid:t},function(e){f[t]={edulevels:e.edulevels,subjects:e.subjects},this._update_panel_ui_from_cache(t)},this)},_handle_add_button:function(t){t.preventDefault();var n=this.get(m).get(v),r=n.one(E).get("value"),i=n.one(x),s=n.one(S),u=s.get("value"),a=s.get("options").item(s.get("selectedIndex")).getHTML(),f=i.get("value"),l=i.get("options").item(i.get("selectedIndex")).getHTML();if(r==="0")return;var h="notFound";e.Array.some(c,function(e){return e.id==r?(h=e.name,!0):!1}),o.add({outcomesetid:r,name:h,edulevels:a,rawedulevels:u,subjects:l,rawsubjects:f}),this._reset_panel_ui()},_ensure_outcome_set_menu:function(e){if(c!==undefined){e.call(this);return}r.send({action:"get_mappable_outcome_sets_menu"},function(t){!n.isArray(t)||t.length===0?new M.core.alert({title:M.str.moodle.error,message:M.str.outcome.nooutcomesetsfound,yesLabel:M.str.outcome.close,visible:!0}):(c=t,e.call(this))},this
)},_create_panel:function(){var t=new M.core.dialogue({headerContent:M.str.outcome.selectoutcomesets,width:"",centered:!0,render:!0,visible:!1,modal:!0});return t.get(v).addClass(this.getClassName("panel")),t.after("visibleChange",function(t){!t.newVal&&s instanceof e.Node&&(s.focus(),s=undefined)}),t.addButton({value:M.str.outcome.ok,action:this._handle_panel_save,context:this}),t.addButton({value:M.str.moodle.cancel,action:this._handle_panel_cancel,context:this}),t.get(v).delegate("change",this._handle_outcome_set_change,E,this),t.get(v).delegate("click",this._handle_add_button,w,this),t}},{HTML_PARSER:{saveNode:g,filterList:function(t){var n=new H;try{var r=t.one(g).get("value");r.length>0&&n.add(e.JSON.parse(r))}catch(i){i.visible=!0,new M.core.exception(i)}return n}},NAME:t,ATTRS:{contextId:{},isFrozen:{value:!1,validator:n.isBoolean},saveNode:{validator:function(t){return t instanceof e.Node}},filterList:{valueFn:function(){return new H}},panel:{readOnly:!0,valueFn:"_create_panel"}}});var P=e.Base.create("filterModel",e.Model,[],{initializer:function(){this.set("id",[this.get("outcomesetid"),this.get("edulevels"),this.get("subjects")].join("_"))},get_display_name:function(){var e=this.get("name");return this.get("subjects")!==null&&this.get("subjects")!==""?e=e+", "+M.str.outcome.subject+": "+this.get("subjects"):e=e+", "+M.str.outcome.allsubjects,this.get("edulevels")!==null&&this.get("edulevels")!==""?e=e+", "+M.str.outcome.educationlevel+": "+this.get("edulevels"):e=e+", "+M.str.outcome.alleducationlevels,e},_edulevels_setter:function(e){return e==="0"?null:!isNaN(e)&&parseFloat(e)==parseInt(e,10)?parseInt(e,10):e},_no_zero_setter:function(e){return e==="0"?null:e}},{ATTRS:{outcomesetid:{value:null,writeOnce:"initOnly"},name:{value:null,writeOnce:"initOnly"},edulevels:{value:null,writeOnce:"initOnly",setter:"_edulevels_setter"},rawedulevels:{value:null,writeOnce:"initOnly",setter:"_edulevels_setter"},subjects:{value:null,writeOnce:"initOnly",setter:"_no_zero_setter"},rawsubjects:{value:null,writeOnce:"initOnly",setter:"_no_zero_setter"}}}),H=e.Base.create("filterList",e.ModelList,[],{model:P,display_list:function(){var e=[];return this.each(function(t){e.push({id:t.get("id"),name:t.get_display_name()})},this),e},_sort:function(e,t){var n=this._compare(e.get("name"),t.get("name"));return n===0&&(n=this._compare(e.get("edulevels"),t.get("edulevels")),n===0&&(n=this._compare(e.get("subjects"),t.get("subjects")))),n},comparator:function(e){var t=this.indexOf(e);return t===-1&&(t=this.size()),t}});M.core_outcome=M.core_outcome||{},M.core_outcome.mapoutcomeset=D,M.core_outcome.init_mapoutcomeset=function(e){var t=new D(e);return t.render(),t}},"@VERSION@",{requires:["widget","model","model-list","handlebars","json-parse","json-stringify","moodle-core_outcome-models","moodle-core-notification-dialogue","moodle-core-notification-exception","moodle-core-notification-alert","moodle-core_outcome-simpleio"]});
