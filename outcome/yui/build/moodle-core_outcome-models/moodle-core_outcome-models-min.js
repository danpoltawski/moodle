YUI.add("moodle-core_outcome-models",function(e,t){var n=e.Lang,r=-1,i=function(e,t){n.isUndefined(t)&&(t=30);if(e.length>t){var r=e.substr(0,t-1);return r=r.substr(0,r.lastIndexOf(" ")),r+"..."}return e},s=function(e){return!isNaN(e)&&parseFloat(e)==parseInt(e,10)},o=function(e){return n.isString(e)&&n.trim(e).length>0},u=function(e){return parseInt(e,10)},a=function(e){return e=parseInt(e,10),e===1?e:0},f=function(e){return e=parseInt(e,10),e<0?0:e},l=function(e){return n.isNull(e)?null:s(e)?(e=parseInt(e,10),e===0?null:e):null},c=function(e){return n.isString(e)?(e=n.trim(e),e.length===0?null:e):null},h=e.Base.create("outcomeModel",e.Model,[],{validate_and_update:function(t,r){var i=new M.core_outcome.SimpleIO;i.send({action:"validate_outcome",sesskey:M.cfg.sesskey,data:e.JSON.stringify(this.toJSON())},function(e){n.isArray(e.errors)?t.call(r,e.errors):(this.setAttrs(e),t.call(r))},this)},get_short_description:function(e){return i(this.get("description"),e)},_get_changed:function(t){return t===!0?!0:!e.Object.isEmpty(this.changed)}},{ATTRS:{id:{value:null,validator:s,setter:u},parentid:{value:null,setter:l},idnumber:{value:null,validator:o,setter:c},rawidnumber:{value:null,validator:o,setter:c},docnum:{value:null,setter:c},rawdocnum:{value:null,setter:c},description:{value:null,validator:o,setter:c},rawdescription:{value:null,validator:o,setter:c},assessable:{value:1,validator:s,setter:a},deleted:{value:0,validator:s,setter:a},sortorder:{value:0,validator:s,setter:f},edulevels:{value:[],validator:n.isArray},rawedulevels:{value:[],validator:n.isArray},subjects:{value:[],validator:n.isArray},rawsubjects:{value:[],validator:n.isArray},hasChanged:{value:!1,validator:n.isBoolean,getter:"_get_changed"}}}),p=e.Base.create("outcomeList",e.ModelList,[],{model:h,comparator:function(e){return e.get("sortorder")},filter_by_modified:function(){return this.filter(function(e){return e.get("id")<0||e.isModified()||e.get("hasChanged")})},filter_out_branch:function(e){return this.filter(function(t){return e.get("id")!==t.get("id")&&!this.is_child_of(e,t)},this)},filter_by_branch:function(e){return this.filter(function(t){return e.get("id")===t.get("id")||this.is_child_of(e,t)},this)},filter_by_parentid:function(e){return this.filter(function(t){return t.get("parentid")===e},this)},get_depth:function(e){var t=e.get("parentid"),r=0;while(!n.isNull(t))r++,t=this.getById(t).get("parentid");return r},find_new_position:function(e,t){var n={parentid:null,sortorder:null};if(t==="before")n.parentid=e.get("parentid"),n.sortorder=e.get("sortorder");else if(t==="after"){var r=this.filter_by_branch(e);n.parentid=e.get("parentid"),n.sortorder=r.pop().get("sortorder")+1}else t==="child"&&(n.parentid=e.get("id"),n.sortorder=e.get("sortorder")+1);return n},move_outcome:function(t,n){var r=this.filter_by_branch(t),i=n.sortorder;this.remove(r),r[0].set("parentid",n.parentid),e.Array.each(r,function(e){e.set("sortorder",i),this.open_sort_order_gap(i),this.add(e),i++},this),this.repair_sort_order()},is_child_of:function(e,t){var r=t.get("parentid");while(!n.isNull(r)){if(r===e.get("id"))return!0;r=this.getById(r).get("parentid")}return!1},add_new_outcome:function(e){if(!e.isNew()){this.getById(e.get("id")).setAttrs(e.toJSON());return}var t=e.get("parentid");e.set("parentid",null),e.set("id",r),e.set("sortorder",this.size()),this.add(e),r--;if(t!==null){var n=this.getById(t),i=this.filter_by_parentid(n.get("id"));i.length>0?this.move_outcome(e,this.find_new_position(i.pop(),"after")):this.move_outcome(e,this.find_new_position(n,"child"))}},remove_outcome:function(t){var n=this.filter_by_parentid(t.get("id"));t.get("id")<0?(this.remove(t),e.Array.each(n,function(e){e.set("parentid",t.get("parentid"))})):t.set("deleted",1),e.Array.each(n,function(e){this.remove_outcome(e)},this),this.repair_sort_order()},repair_sort_order:function(){var e=0;this.each(function(t){t.set("sortorder",e),e++})},open_sort_order_gap:function(e){this.each(function(t){t.get("sortorder")>=e&&t.set("sortorder",t.get("sortorder")+1)})},close_sort_order_gap:function(e){this.each(function(t){t.get("sortorder")>e&&t.set("sortorder",t.get("sortorder")-1)})}}),d=e.Base.create("outcomeSetModel",e.Model,[],{get_short_name:function(e){return i(this.get("name"),e)}},{ATTRS:{id:{value:null,validator:s,setter:u},idnumber:{value:null,validator:o,setter:c},name:{value:null,validator:o,setter:c},description:{value:null,setter:c},provider:{value:null,setter:c},revision:{value:null,setter:c},region:{value:null,setter:c},deleted:{value:0,validator:s,setter:a},timecreated:{value:null,validator:s,setter:u},timemodified:{value:null,validator:s,setter:u}}}),v=e.Base.create("outcomeSetList",e.ModelList,[],{model:d,comparator:function(e){return e.get("name")}});M.core_outcome=M.core_outcome||{},M.core_outcome.shortenText=i,M.core_outcome.OutcomeModel=h,M.core_outcome.OutcomeList=p,M.core_outcome.OutcomeSetModel=d,M.core_outcome.OutcomeSetList=v},"@VERSION@",{requires:["base","model","model-list","moodle-core_outcome-simpleio","json-stringify"]});
