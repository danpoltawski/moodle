YUI.add("moodle-qtype_ddimageortext-form",function(a,b){var c="moodle-qtype_ddimageortext-form",d=function(){d.superclass.constructor.apply(this,arguments)};a.extend(d,M.qtype_ddimageortext.dd_base_class,{pendingid:"",fp:null,initializer:function(){this.pendingid="qtype_ddimageortext-form-"+Math.random().toString(36).slice(2),M.util.js_pending(this.pendingid),this.fp=this.file_pickers();var b=a.one(this.get("topnode"));b.one("div.fcontainer").append('<div class="ddarea"><div class="droparea"></div><div class="dragitems"></div><div class="dropzones"></div></div>'),this.doc=this.doc_structure(this),this.draw_dd_area()},draw_dd_area:function(){var b=this.fp.file("bgimage").href;if(this.stop_selector_events(),this.set_options_for_drag_item_selectors(),null!==b){this.doc.load_bg_img(b),this.load_drag_homes();var c=new a.DD.Drop({node:this.doc.bg_img()});c.on("drop:hit",function(a){a.drag.get("node").setData("gooddrop",!0)}),this.afterimageloaddone=!1,this.doc.bg_img().on("load",this.constrain_image_size,this,"bgimage"),this.doc.drag_item_homes().on("load",this.constrain_image_size,this,"dragimage"),this.doc.bg_img().after("load",this.poll_for_image_load,this,!0,0,this.after_all_images_loaded),this.doc.drag_item_homes().after("load",this.poll_for_image_load,this,!0,0,this.after_all_images_loaded)}else this.setup_form_events(),M.util.js_complete(this.pendingid);this.update_visibility_of_file_pickers()},after_all_images_loaded:function(){this.update_padding_sizes_all(),this.update_drag_instances(),this.reposition_drags_for_form(),this.set_options_for_drag_item_selectors(),this.setup_form_events(),a.later(500,this,this.reposition_drags_for_form,[],!0)},constrain_image_size:function(a,b){var c=this.get("maxsizes")[b],d=Math.max(a.target.get("width")/c.width,a.target.get("height")/c.height);d>1&&a.target.set("width",Math.floor(a.target.get("width")/d)),a.target.addClass("constrained"),a.target.detach("load",this.constrain_image_size)},load_drag_homes:function(){for(var a=0;a<this.form.get_form_value("noitems",[]);a++)this.load_drag_home(a)},load_drag_home:function(a){var b=null;"image"===this.form.get_form_value("drags",[a,"dragitemtype"])&&(b=this.fp.file(this.form.to_name_with_index("dragitem",[a])).href),this.doc.add_or_update_drag_item_home(a,b,this.form.get_form_value("draglabel",[a]),this.form.get_form_value("drags",[a,"draggroup"]))},update_drag_instances:function(){for(var a=0;a<this.form.get_form_value("nodropzone",[]);a++){var b=this.form.get_form_value("drops",[a,"choice"]);if("0"!==b&&null===this.doc.drag_item(a)){var c=this.doc.clone_new_drag_item(a,b-1);null!==c&&this.doc.draggable_for_form(c)}}},set_options_for_drag_item_selectors:function(){for(var b={0:""},c=0;c<this.form.get_form_value("noitems",[]);c++){var d=this.form.get_form_value("draglabel",[c]),e=this.fp.file(this.form.to_name_with_index("dragitem",[c]));"image"===this.form.get_form_value("drags",[c,"dragitemtype"])&&null!==e.name?b[c+1]=c+1+". "+d+" ("+e.name+")":""!==d&&(b[c+1]=c+1+". "+d)}for(c=0;c<this.form.get_form_value("nodropzone",[]);c++){var f=a.one("#id_drops_"+c+"_choice"),g=f.get("value");f.all("option").remove(!0);for(var h in b){h=+h;var i='<option value="'+h+'">'+b[h]+"</option>";f.append(i);var j=f.one('option[value="'+h+'"]');if(h===+g)j.set("selected",!0);else if(0!==h){var k=a.one("#id_drags_"+(h-1)+"_infinite");k&&!k.get("checked")&&this.item_is_allocated_to_dropzone(h)&&j.set("disabled",!0)}}}},stop_selector_events:function(){a.all("fieldset#id_dropzoneheader select").detachAll()},item_is_allocated_to_dropzone:function(b){return a.all("fieldset#id_dropzoneheader select").some(function(a){return Number(a.get("value"))===b})},setup_form_events:function(){a.all("fieldset#id_dropzoneheader input").on("blur",function(a){var b=a.target.getAttribute("name"),c=this.form.from_name_with_index(b).indexes[0],d=[this.form.get_form_value("drops",[c,"xleft"]),this.form.get_form_value("drops",[c,"ytop"])],e=this.constrain_xy(c,d);this.form.set_form_value("drops",[c,"xleft"],e[0]),this.form.set_form_value("drops",[c,"ytop"],e[1])},this),a.all("fieldset#id_dropzoneheader select").on("change",function(a){var b=a.target.getAttribute("name"),c=this.form.from_name_with_index(b).indexes[0],d=this.doc.drag_item(c);null!==d&&d.remove(!0),this.draw_dd_area()},this);for(var b=0;b<this.form.get_form_value("noitems",[]);b++)a.all("#fgroup_id_drags_"+b+" select.draggroup").on("change",this.redraw_dd_area,this),a.all("#fgroup_id_drags_"+b+" select.dragitemtype").on("change",this.redraw_dd_area,this),a.all("fieldset#draggableitemheader_"+b+' input[type="text"]').on("blur",this.set_options_for_drag_item_selectors,this),a.all("fieldset#draggableitemheader_"+b+' input[type="checkbox"]').on("change",this.set_options_for_drag_item_selectors,this);a.after(function(a){var b=this.fp.name(a.id);"bgimage"!==b&&this.doc.drag_items().remove(!0),this.draw_dd_area()},M.form_filepicker,"callback",this)},redraw_dd_area:function(){this.doc.drag_items().remove(!0),this.draw_dd_area()},update_visibility_of_file_pickers:function(){for(var b=0;b<this.form.get_form_value("noitems",[]);b++)"image"===this.form.get_form_value("drags",[b,"dragitemtype"])?a.one("input#id_dragitem_"+b).get("parentNode").get("parentNode").setStyle("display","block"):a.one("input#id_dragitem_"+b).get("parentNode").get("parentNode").setStyle("display","none")},reposition_drags_for_form:function(){this.doc.drag_items().each(function(a){var b=a.getData("draginstanceno");this.reposition_drag_for_form(b)},this),M.util.js_complete(this.pendingid)},reposition_drag_for_form:function(a){var b=this.doc.drag_item(a);if(null!==b&&!b.hasClass("yui3-dd-dragging")){var c=[this.form.get_form_value("drops",[a,"xleft"]),this.form.get_form_value("drops",[a,"ytop"])];if(""===c[0]&&""===c[1]){var d=b.getData("dragitemno");b.setXY(this.doc.drag_item_home(d).getXY())}else b.setXY(this.convert_to_window_xy(c))}},set_drag_xy:function(a,b){b=this.constrain_xy(a,this.convert_to_bg_img_xy(b)),this.form.set_form_value("drops",[a,"xleft"],Math.round(b[0])),this.form.set_form_value("drops",[a,"ytop"],Math.round(b[1]))},reset_drag_xy:function(a){this.form.set_form_value("drops",[a,"xleft"],""),this.form.set_form_value("drops",[a,"ytop"],"")},constrain_xy:function(a,b){var c=this.doc.drag_item(a),d=Math.min(b[0],this.doc.bg_img().get("width")-c.get("offsetWidth")),e=Math.min(b[1],this.doc.bg_img().get("height")-c.get("offsetHeight"));return d=Math.max(d,0),e=Math.max(e,0),[d,e]},convert_to_bg_img_xy:function(a){return[Number(a[0])-this.doc.bg_img().getX()-1,Number(a[1])-this.doc.bg_img().getY()-1]},form:{to_name_with_index:function(a,b){for(var c=a,d=0;d<b.length;d++)c=c+"["+b[d]+"]";return c},get_el:function(a,b){var c=document.getElementById("mform1");return c.elements[this.to_name_with_index(a,b)]},get_form_value:function(a,b){var c=this.get_el(a,b);return"checkbox"===c.type?c.checked:c.value},set_form_value:function(a,b,c){var d=this.get_el(a,b);"checkbox"===d.type?d.checked=c:d.value=c},from_name_with_index:function(a){var b={};b.indexes=[];var c=a.indexOf("[");for(b.name=a.substring(0,c);c!==-1;){var d=a.indexOf("]",c+1);b.indexes.push(a.substring(c+1,d)),c=a.indexOf("[",d+1)}return b}},file_pickers:function(){var b,c;if(void 0===b){b={},c={};var d=a.all("form.mform input.filepickerhidden");d.each(function(a){b[a.get("value")]=a.get("name"),c[a.get("name")]=a.get("parentNode")},this)}var e={file:function(a){var b=c[a],d=b.one("div.filepicker-filelist a");return d?{href:d.get("href"),name:d.get("innerHTML")}:{href:null,name:null}},name:function(a){return b[a]}};return e}},{NAME:c,ATTRS:{maxsizes:{value:null}}}),M.qtype_ddimageortext=M.qtype_ddimageortext||{},M.qtype_ddimageortext.init_form=function(a){return new d(a)}},"@VERSION@",{requires:["moodle-qtype_ddimageortext-dd","form_filepicker"]});