YUI.add("moodle-qtype_ddimageortext-dd",function(a,b){var c="ddimageortext_dd",d=function(){d.superclass.constructor.apply(this,arguments)};a.extend(d,a.Base,{doc:null,polltimer:null,afterimageloaddone:!1,poll_for_image_load:function(b,c,d,e){if(!this.afterimageloaddone){var f=this.doc.bg_img().get("complete");c&&(f=f&&this.doc.bg_img().hasClass("constrained"));var g=!this.doc.drag_item_homes().some(function(a){if("IMG"!==a.get("tagName"))return!1;var b=a.get("complete");return c&&(b=b&&a.hasClass("constrained")),!b});if(f&&g)null!==this.polltimer&&(this.polltimer.cancel(),this.polltimer=null),this.doc.drag_item_homes().detach("load",this.poll_for_image_load),this.doc.bg_img().detach("load",this.poll_for_image_load),0!==d?a.later(d,this,e):e.call(this),this.afterimageloaddone=!0;else if(null===this.polltimer){var h=[null,c,d,e];this.polltimer=a.later(1e3,this,this.poll_for_image_load,h,!0)}}},doc_structure:function(b){var c=a.one(this.get("topnode")),d=c.one("div.dragitems"),e=c.one("div.droparea");return{top_node:function(){return c},drag_items:function(){return d.all(".drag")},drop_zones:function(){return c.all("div.dropzones div.dropzone")},drop_zone_group:function(a){return c.all("div.dropzones div.group"+a)},drag_items_cloned_from:function(a){return d.all(".dragitems"+a)},drag_item:function(a){return d.one(".draginstance"+a)},drag_items_in_group:function(a){return d.all(".drag.group"+a)},drag_item_homes:function(){return d.all(".draghome")},bg_img:function(){return c.one(".dropbackground")},load_bg_img:function(a){e.setContent('<img class="dropbackground" src="'+a+'"/>'),this.bg_img().on("load",this.on_image_load,this,"bg_image")},add_or_update_drag_item_home:function(a,b,c,e){var f=this.drag_item_home(a),g="draghome dragitemhomes"+a+" group"+e,h='<img class="'+g+'" src="'+b+'" alt="'+c+'" />',i='<div class="'+g+'">'+c+"</div>";null===f?b?d.append(h):""!==c&&d.append(i):(b?d.insert(h,f):""!==c&&d.insert(i,f),f.remove(!0));var j=d.one(".dragitemhomes"+a);null!==j&&(j.setData("groupno",e),j.setData("dragitemno",a))},drag_item_home:function(a){return d.one(".dragitemhomes"+a)},get_classname_numeric_suffix:function(a,b){var c=a.getAttribute("class");if(""!==c)for(var d=c.split(" "),e=0;e<d.length;e++){var f=new RegExp("^"+b+"([0-9])+$");if(f.test(d[e])){var g=new RegExp("([0-9])+$"),h=g.exec(d[e]);return+h[0]}}throw'Prefix "'+b+'" not found in class names.'},clone_new_drag_item:function(a,b){var c=this.drag_item_home(b);if(null===c)return null;var d=c.cloneNode(!0);return d.removeClass("dragitemhomes"+b),d.addClass("dragitems"+b),d.addClass("draginstance"+a),d.removeClass("draghome"),d.addClass("drag"),d.setStyles({visibility:"visible",position:"absolute"}),d.setData("draginstanceno",a),d.setData("dragitemno",b),c.get("parentNode").appendChild(d),d},draggable_for_question:function(b,d,e){new a.DD.Drag({node:b,dragMode:"point",groups:[d]}).plug(a.Plugin.DDConstrained,{constrain2node:c}),b.setData("group",d),b.setData("choice",e)},draggable_for_form:function(d){var e=new a.DD.Drag({node:d,dragMode:"point"}).plug(a.Plugin.DDConstrained,{constrain2node:c});e.on("drag:end",function(a){var c=a.target.get("node"),d=c.getData("draginstanceno"),e=c.getData("gooddrop");e?b.set_drag_xy(d,[a.pageX,a.pageY]):b.reset_drag_xy(d)},this),e.on("drag:start",function(a){var b=a.target;b.get("node").setData("gooddrop",!1)},this)}}},update_padding_sizes_all:function(){for(var a=1;a<=8;a++)this.update_padding_size_for_group(a)},update_padding_size_for_group:function(a){var b=this.doc.top_node().all(".draghome.group"+a);if(0!==b.size()){var c=0,d=0;b.each(function(a){c=Math.max(c,a.get("clientWidth")),d=Math.max(d,a.get("clientHeight"))},this),b.each(function(a){var b=Math.round((10+d-a.get("clientHeight"))/2),e=Math.round((10+c-a.get("clientWidth"))/2);a.setStyle("padding",b+"px "+e+"px "+b+"px "+e+"px")},this),this.doc.drop_zone_group(a).setStyles({width:c+10,height:d+10})}},convert_to_window_xy:function(a){return[Number(a[0])+this.doc.bg_img().getX()+1,Number(a[1])+this.doc.bg_img().getY()+1]}},{NAME:c,ATTRS:{drops:{value:null},readonly:{value:!1},topnode:{value:null}}}),M.qtype_ddimageortext=M.qtype_ddimageortext||{},M.qtype_ddimageortext.dd_base_class=d;var e="ddimageortext_question",f=function(){f.superclass.constructor.apply(this,arguments)};a.extend(f,M.qtype_ddimageortext.dd_base_class,{touchscrolldisable:null,pendingid:"",initializer:function(){this.pendingid="qtype_ddimageortext-"+Math.random().toString(36).slice(2),M.util.js_pending(this.pendingid),this.doc=this.doc_structure(this),this.poll_for_image_load(null,!1,10,this.create_all_drag_and_drops),this.doc.bg_img().after("load",this.poll_for_image_load,this,!1,10,this.create_all_drag_and_drops),this.doc.drag_item_homes().after("load",this.poll_for_image_load,this,!1,10,this.create_all_drag_and_drops),this.get("readonly")?a.one("window").on("resize",function(){this.reposition_drags_for_question()},this):a.later(500,this,this.reposition_drags_for_question,!0)},prevent_touchmove_from_scrolling:function(b){var c=a.UA.ie?"MSPointerStart":"touchstart",d=a.UA.ie?"MSPointerEnd":"touchend",e=a.UA.ie?"MSPointerMove":"touchmove";b.on(c,function(){this.touchscrolldisable||(this.touchscrolldisable=a.one("body").on(e,function(a){a=a||window.event,a.preventDefault()}))},this),b.on(d,function(){this.touchscrolldisable&&(this.touchscrolldisable.detach(),this.touchscrolldisable=null)},this)},create_all_drag_and_drops:function(){this.init_drops(),this.update_padding_sizes_all();var a=0;this.doc.drag_item_homes().each(function(b){var c=Number(this.doc.get_classname_numeric_suffix(b,"dragitemhomes")),d=+this.doc.get_classname_numeric_suffix(b,"choice"),e=+this.doc.get_classname_numeric_suffix(b,"group"),f=this.doc.drop_zone_group(e).size(),g=this.doc.clone_new_drag_item(a,c);if(a++,this.get("readonly")||(this.doc.draggable_for_question(g,e,d),this.prevent_touchmove_from_scrolling(g)),g.hasClass("infinite"))for(var h=f-1;h>0;)g=this.doc.clone_new_drag_item(a,c),a++,this.get("readonly")||(this.doc.draggable_for_question(g,e,d),this.prevent_touchmove_from_scrolling(g)),h--},this),this.reposition_drags_for_question(),this.get("readonly")||(this.doc.drop_zones().set("tabIndex",0),this.doc.drop_zones().each(function(a){a.on("dragchange",this.drop_zone_key_press,this)},this)),M.util.js_complete(this.pendingid)},drop_zone_key_press:function(a){switch(a.direction){case"next":this.place_next_drag_in(a.target);break;case"previous":this.place_previous_drag_in(a.target);break;case"remove":this.remove_drag_from_drop(a.target)}a.preventDefault(),this.reposition_drags_for_question()},place_next_drag_in:function(a){this.search_for_unplaced_drop_choice(a,1)},place_previous_drag_in:function(a){this.search_for_unplaced_drop_choice(a,-1)},search_for_unplaced_drop_choice:function(a,b){var c,d=this.current_drag_in_drop(a);if(""===d)if(1===b)c=1;else{c=1;var e=a.getData("group");this.doc.drag_items_in_group(e).each(function(a){c=Math.max(c,a.getData("choice"))},this)}else c=+d+b;var f;do{if(0===this.get_choices_for_drop(c,a).size())return void this.remove_drag_from_drop(a);f=this.get_unplaced_choice_for_drop(c,a),c+=b}while(null===f);this.place_drag_in_drop(f,a)},current_drag_in_drop:function(b){var c=b.getData("inputid"),d=a.one("input#"+c);return d.get("value")},remove_drag_from_drop:function(a){this.place_drag_in_drop(null,a)},place_drag_in_drop:function(b,c){var d=c.getData("inputid"),e=a.one("input#"+d);null!==b?e.set("value",b.getData("choice")):e.set("value","")},reposition_drags_for_question:function(b){this.doc.drag_items().removeClass("placed"),this.doc.drag_items().each(function(a){void 0!==a.dd&&a.dd.detachAll("drag:start")},this),this.doc.drop_zones().each(function(a){var b=a.getData("xy");a.setXY(this.convert_to_window_xy(b));var c="input#"+a.getData("inputid"),d=this.doc.top_node().one(c),e=d.get("value");if(""!==e){var f=this.get_unplaced_choice_for_drop(e,a);null!==f&&(f.setXY(a.getXY()),f.addClass("placed"),void 0!==f.dd&&f.dd.once("drag:start",function(a,b){b.set("value",""),a.target.get("node").removeClass("placed")},this,d))}},this),this.doc.drag_items().each(function(a){if(!a.hasClass("placed")&&!a.hasClass("yui3-dd-dragging")){var b=this.doc.drag_item_home(a.getData("dragitemno"));a.setXY(b.getXY())}},this),b&&a.later(500,this,this.reposition_drags_for_question,!0)},get_choices_for_drop:function(a,b){var c=b.getData("group");return this.doc.top_node().all("div.dragitemgroup"+c+" .choice"+a+".drag")},get_unplaced_choice_for_drop:function(a,b){var c=this.get_choices_for_drop(a,b),d=null;return c.some(function(a){return!(!this.get("readonly")&&(a.hasClass("placed")||a.hasClass("yui3-dd-dragging")))&&(d=a,!0)}),d},init_drops:function(){for(var b=this.doc.top_node().one("div.dropzones"),c={},d=1;d<=8;d++){var e=a.Node.create('<div class = "dropzonegroup'+d+'"></div>');b.append(e),c[d]=e}var f=function(a){var b=a.drag.get("node"),c=a.drop.get("node");Number(c.getData("group"))===b.getData("group")&&this.place_drag_in_drop(b,c)};for(var g in this.get("drops")){var h=this.get("drops")[g],i="dropzone group"+h.group+" place"+g,j=h.text.replace('"','"');j||(j=M.util.get_string("blank","qtype_ddimageortext"));var k='<div title="'+j+'" class="'+i+'"><span class="accesshide">'+j+"</span>&nbsp;</div>",l=a.Node.create(k);c[h.group].append(l),l.setStyles({opacity:.5}),l.setData("xy",h.xy),l.setData("place",g),l.setData("inputid",h.fieldname.replace(":","_")),l.setData("group",h.group);var m=new a.DD.Drop({node:l,groups:[h.group]});m.on("drop:hit",f,this)}}},{NAME:e,ATTRS:{}}),a.Event.define("dragchange",{_event:a.UA.webkit||a.UA.ie?"keydown":"keypress",_keys:{32:"next",37:"previous",38:"previous",39:"next",40:"next",27:"remove"},_keyHandler:function(a,b){this._keys[a.keyCode]&&(a.direction=this._keys[a.keyCode],b.fire(a))},on:function(a,b,c){b._detacher=a.on(this._event,this._keyHandler,this,c)}}),M.qtype_ddimageortext.init_question=function(a){return new f(a)}},"@VERSION@",{requires:["node","dd","dd-drop","dd-constrain"]});