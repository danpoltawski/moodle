YUI.add("moodle-qtype_ddmarker-form",function(a,b){var c="moodle-qtype_ddmarker-form",d=function(){d.superclass.constructor.apply(this,arguments)};a.extend(d,M.qtype_ddmarker.dd_base_class,{fp:null,initializer:function(){var b="qtype_ddmarker-form-"+Math.random().toString(36).slice(2);M.util.js_pending(b),this.fp=this.file_pickers();var c=a.one(this.get("topnode"));c.one("div.fcontainer").append('<div class="ddarea"><div class="markertexts"></div><div class="droparea"></div><div class="dropzones"></div><ul class="pager unstyled list-unstyled"><li><span id="xcoordpreview">X = </span></li><li><span id="ycoordpreview">Y = </span></li></ul><div class="grid"></div></div>'),this.doc=this.doc_structure(this),this.stop_selector_events(),this.set_options_for_drag_item_selectors(),this.setup_form_events(),a.later(500,this,this.update_drop_zones,[b],!0),a.after(this.load_bg_image,M.form_filepicker,"callback",this),this.load_bg_image();var d=a.one(this.get("topnode"));d.one(".grid").on("mousemove",function(a){var b=d.one(".dropbackground"),c=Math.round(Number(a.pageX)-b.getX()-1),e=Math.round(Number(a.pageY)-b.getY()-1);d.one("#xcoordpreview").setHTML("X = "+c),d.one("#ycoordpreview").setHTML("Y = "+e)})},load_bg_image:function(){var b=this.fp.file("bgimage").href;if(null!==b){this.doc.load_bg_img(b);var c=new a.DD.Drop({node:this.doc.bg_img()});c.on("drop:hit",function(a){a.drag.get("node").setData("gooddrop",!0)}),this.afterimageloaddone=!1,this.doc.bg_img().on("load",this.constrain_image_size,this)}},constrain_image_size:function(a){var b=this.get("maxsizes").bgimage,c=Math.max(a.target.get("width")/b.width,a.target.get("height")/b.height);c>1&&a.target.set("width",Math.floor(a.target.get("width")/c)),a.target.addClass("constrained"),a.target.detach("load",this.constrain_image_size)},update_drop_zones:function(b){null!==this.graphics&&this.graphics.destroy(),this.restart_colours(),this.graphics=new a.Graphic({render:"div.ddarea div.dropzones"});for(var c=this.form.get_form_value("nodropzone",[]),d=0;d<c;d++){var e=this.form.get_form_value("drops",[d,"choice"]),f=this.get_marker_text(e),g=this.form.get_form_value("drops",[d,"shape"]),h=this.get_coords(d),i=this.get_next_colour();a.one("input#id_drops_"+d+"_coords").setStyle("background-color",i),this.draw_drop_zone(d,f,g,h,i,!1)}this.doc.bg_img()&&a.one("div.ddarea .grid").setXY(this.convert_to_window_xy([0,0])).setStyle("width",this.doc.bg_img().get("width")).setStyle("height",this.doc.bg_img().get("height")),M.util.js_complete(b)},get_coords:function(a){var b=this.form.get_form_value("drops",[a,"coords"]);return b.replace(new RegExp("\\s*","g"),"")},get_marker_text:function(a){if(0!==Number(a)){var b=this.form.get_form_value("drags",[a-1,"label"]);return b.replace(new RegExp("^\\s*(.*)\\s*$"),"$1")}return""},set_options_for_drag_item_selectors:function(){for(var b={0:""},c=1;c<=this.form.get_form_value("noitems",[]);c++){var d=this.get_marker_text(c);""!==d&&(b[c]=a.Escape.html(d))}var e,f=[];for(c=0;c<this.form.get_form_value("nodropzone",[]);c++)e=a.one("#id_drops_"+c+"_choice"),f[c]=Number(e.get("value"));for(c=0;c<this.form.get_form_value("nodropzone",[]);c++){e=a.one("#id_drops_"+c+"_choice"),e.all("option").remove(!0);for(var g in b){g=Number(g);var h='<option value="'+g+'">'+b[g]+"</option>";e.append(h);var i=e.one('option[value="'+g+'"]');if(g===f[c])i.set("selected",!0);else if(0!==g){var j=this.form.get_form_value("drags",[g-1,"noofdrags"]);if(0!==Number(j))for(var k in f)if(Number(f[k])===g){if(1===Number(j)){i.set("disabled",!0);break}j--}}}}},stop_selector_events:function(){a.all("fieldset#id_dropzoneheader select").detachAll()},setup_form_events:function(){a.all("fieldset#id_draggableitemheader input").on("change",function(){this.set_options_for_drag_item_selectors()},this),a.all("fieldset#id_draggableitemheader select").on("change",function(){this.set_options_for_drag_item_selectors()},this),a.all("fieldset#id_dropzoneheader select").on("change",function(){this.set_options_for_drag_item_selectors()},this)},form:{to_name_with_index:function(a,b){for(var c=a,d=0;d<b.length;d++)c=c+"["+b[d]+"]";return c},get_el:function(a,b){var c=document.getElementById("mform1");return c.elements[this.to_name_with_index(a,b)]},get_form_value:function(a,b){var c=this.get_el(a,b);return"checkbox"===c.type?c.checked:c.value},set_form_value:function(a,b,c){var d=this.get_el(a,b);"checkbox"===d.type?d.checked=c:d.value=c},from_name_with_index:function(a){var b={};b.indexes=[];var c=a.indexOf("[");for(b.name=a.substring(0,c);c!==-1;){var d=a.indexOf("]",c+1);b.indexes.push(a.substring(c+1,d)),c=a.indexOf("[",d+1)}return b}},file_pickers:function(){var b,c;if(void 0===b){b={},c={};var d=a.all("form.mform input.filepickerhidden");d.each(function(a){b[a.get("value")]=a.get("name"),c[a.get("name")]=a.get("parentNode")},this)}var e={file:function(a){var b=c[a],d=b.one("div.filepicker-filelist a");return d?{href:d.get("href"),name:d.get("innerHTML")}:{href:null,name:null}},name:function(a){return b[a]}};return e}},{NAME:c,ATTRS:{maxsizes:{value:null}}}),M.qtype_ddmarker=M.qtype_ddmarker||{},M.qtype_ddmarker.init_form=function(a){return new d(a)}},"@VERSION@",{requires:["moodle-qtype_ddmarker-dd","form_filepicker","graphics","escape"]});