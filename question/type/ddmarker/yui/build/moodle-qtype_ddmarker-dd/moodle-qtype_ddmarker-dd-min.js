YUI.add("moodle-qtype_ddmarker-dd",function(a,b){var c="moodle-qtype_ddmarker-dd",d=function(){d.superclass.constructor.apply(this,arguments)};a.extend(d,a.Base,{doc:null,polltimer:null,afterimageloaddone:!1,graphics:null,poll_for_image_load:function(b,c,d,e){if(!this.afterimageloaddone){var f=this.doc.bg_img().get("complete");if(c&&(f=f&&this.doc.bg_img().hasClass("constrained")),f)null!==this.polltimer&&(this.polltimer.cancel(),this.polltimer=null),this.doc.bg_img().detach("load",this.poll_for_image_load),0!==d?a.later(d,this,e):e.call(this),this.afterimageloaddone=!0;else if(null===this.polltimer){var g=[null,c,d,e];this.polltimer=a.later(1e3,this,this.poll_for_image_load,g,!0)}}},doc_structure:function(){var b=a.one(this.get("topnode")),c=b.one("div.dragitems"),d=b.one("div.droparea");return{top_node:function(){return b},bg_img:function(){return b.one(".dropbackground")},load_bg_img:function(a){d.setContent('<img class="dropbackground" src="'+a+'"/>'),this.bg_img().on("load",this.on_image_load,this,"bg_image")},drag_items:function(){return c.all(".dragitem")},drag_items_for_choice:function(a){return c.all("span.dragitem.choice"+a)},drag_item_for_choice:function(a,b){return c.one("span.dragitem.choice"+a+".item"+b)},drag_item_being_dragged:function(a){return c.one("span.dragitem.beingdragged.choice"+a)},drag_item_home:function(a){return c.one("span.draghome.choice"+a)},drag_item_homes:function(){return c.all("span.draghome")},get_classname_numeric_suffix:function(a,b){var c=a.getAttribute("class");if(""!==c)for(var d=c.split(" "),e=0;e<d.length;e++){var f=new RegExp("^"+b+"([0-9])+$");if(f.test(d[e])){var g=new RegExp("([0-9])+$"),h=g.exec(d[e]);return Number(h[0])}}return null},inputs_for_choices:function(){return b.all("input.choices")},input_for_choice:function(a){return b.one("input.choice"+a)},marker_texts:function(){return b.one("div.markertexts")}}},colours:["#FFFFFF","#B0C4DE","#DCDCDC","#D8BFD8","#87CEFA","#DAA520","#FFD700","#F0E68C"],nextcolourindex:0,restart_colours:function(){this.nextcolourindex=0},get_next_colour:function(){var a=this.colours[this.nextcolourindex];return this.nextcolourindex++,this.nextcolourindex===this.colours.length&&(this.nextcolourindex=0),a},convert_to_window_xy:function(a){return[Number(a[0])+this.doc.bg_img().getX()+1,Number(a[1])+this.doc.bg_img().getY()+1]},shapes:[],draw_drop_zone:function(a,b,c,d,e,f){var g;if(g=f?this.doc.marker_texts().one("span.markertext"+a+" a"):this.doc.marker_texts().one("span.markertext"+a))""!==b?g.setContent(b):g.remove(!0);else if(""!==b){var h="markertext markertext"+a;f?this.doc.marker_texts().append('<span class="'+h+'"><a href="#">'+b+"</a></span>"):this.doc.marker_texts().append('<span class="'+h+'">'+b+"</span>")}var i="draw_shape_"+c;if(this[i]instanceof Function){var j=this[i](a,d,e);if(null!==j){var k=this.doc.top_node().one("div.ddarea div.markertexts span.markertext"+a);if(null!==k){k.setStyle("opacity","0.6"),j[0]-=k.get("offsetWidth")/2,j[1]-=k.get("offsetHeight")/2,k.setXY(this.convert_to_window_xy(j));var l=k.one("a");null!==l&&(l.once("click",function(a,b){var c=this.shapes[b].get("fill");c.opacity=1,this.shapes[b].set("fill",c)},this,a),l.set("tabIndex",0))}}}},draw_shape_circle:function(a,b,c){var d=b.match(/(\d+),(\d+);(\d+)/);if(d&&4===d.length){var e=[Number(d[1])-d[3],Number(d[2])-d[3]];if(this.coords_in_img(e)){var f=[2*Number(d[3]),2*Number(d[3])],g=this.graphics.addShape({type:"circle",width:f[0],height:f[1],fill:{color:c,opacity:"0.5"},stroke:{weight:1,color:"black"}});return g.setXY(this.convert_to_window_xy(e)),this.shapes[a]=g,[Number(d[1]),Number(d[2])]}}return null},draw_shape_rectangle:function(a,b,c){var d=b.match(/(\d+),(\d+);(\d+),(\d+)/);if(d&&5===d.length){var e=[Number(d[1]),Number(d[2])],f=[Number(d[3]),Number(d[4])];if(this.coords_in_img([e[0]+f[0],e[1]+f[1]])){var g=this.graphics.addShape({type:"rect",width:f[0],height:f[1],fill:{color:c,opacity:"0.5"},stroke:{weight:1,color:"black"}});return g.setXY(this.convert_to_window_xy(e)),this.shapes[a]=g,[Number(e[0])+f[0]/2,Number(e[1])+f[1]/2]}}return null},draw_shape_polygon:function(a,b,c){var d=b.split(";"),e=[];for(var f in d){var g=d[f].match(/^(\d+),(\d+)$/);null!==g&&this.coords_in_img([g[1],g[2]])&&(e[e.length]=[g[1],g[2]])}if(e.length>2){var h=this.graphics.addShape({type:"path",stroke:{weight:1,color:"black"},fill:{color:c,opacity:"0.5"}}),i=[0,0],j=[this.doc.bg_img().get("width"),this.doc.bg_img().get("height")];for(f=0;f<e.length;f++)j[0]=Math.min(e[f][0],j[0]),j[1]=Math.min(e[f][1],j[1]),i[0]=Math.max(e[f][0],i[0]),i[1]=Math.max(e[f][1],i[1]),0===f?h.moveTo(e[f][0],e[f][1]):h.lineTo(e[f][0],e[f][1]);return Number(e[0][0])===Number(e[e.length-1][0])&&Number(e[0][1])===Number(e[e.length-1][1])||h.lineTo(e[0][0],e[0][1]),h.end(),h.setXY(this.doc.bg_img().getXY()),this.shapes[a]=h,[(j[0]+i[0])/2,(j[1]+i[1])/2]}return null},coords_in_img:function(a){return a[0]<=this.doc.bg_img().get("width")&&a[1]<=this.doc.bg_img().get("height")}},{NAME:c,ATTRS:{drops:{value:null},readonly:{value:!1},topnode:{value:null}}}),M.qtype_ddmarker=M.qtype_ddmarker||{},M.qtype_ddmarker.dd_base_class=d;var e="ddmarker_question",f=function(){f.superclass.constructor.apply(this,arguments)};a.extend(f,M.qtype_ddmarker.dd_base_class,{touchscrolldisable:null,pendingid:"",initializer:function(){this.pendingid="qtype_ddmarker-"+Math.random().toString(36).slice(2),M.util.js_pending(this.pendingid),this.doc=this.doc_structure(this),this.poll_for_image_load(null,!1,0,this.after_image_load),this.doc.bg_img().after("load",this.poll_for_image_load,this,!1,0,this.after_image_load)},after_image_load:function(){this.redraw_drags_and_drops(),M.util.js_complete(this.pendingid),a.later(2e3,this,this.redraw_drags_and_drops,[],!0)},clone_new_drag_item:function(a,b){var c=a.cloneNode(!0);return c.removeClass("draghome"),c.addClass("dragitem"),c.addClass("item"+b),c.one("span.markertext").setStyle("opacity",.6),a.insert(c,"after"),this.get("readonly")||this.draggable(c),c},prevent_touchmove_from_scrolling:function(b){var c=a.UA.ie?"MSPointerStart":"touchstart",d=a.UA.ie?"MSPointerEnd":"touchend",e=a.UA.ie?"MSPointerMove":"touchmove";b.on(c,function(){this.touchscrolldisable||(this.touchscrolldisable=a.one("body").on(e,function(a){a=a||window.event,a.preventDefault()}))},this),b.on(d,function(){this.touchscrolldisable&&(this.touchscrolldisable.detach(),this.touchscrolldisable=null)},this)},draggable:function(b){var c=new a.DD.Drag({node:b,dragMode:"intersect"}).plug(a.Plugin.DDConstrained,{constrain2node:this.doc.top_node()});c.after("drag:start",function(a){var b=a.target.get("node");b.addClass("beingdragged");var c=this.get_choiceno_for_node(b),d=this.get_itemno_for_node(b);null!==d&&b.removeClass("item"+b),this.save_all_xy_for_choice(c,null),this.redraw_drags_and_drops()},this),c.after("drag:end",function(a){var b=a.target.get("node");b.removeClass("beingdragged");var c=this.get_choiceno_for_node(b);this.save_all_xy_for_choice(c,b),this.redraw_drags_and_drops()},this),b.set("tabIndex",0),b.on("dragchange",this.drop_zone_key_press,this),this.prevent_touchmove_from_scrolling(b)},save_all_xy_for_choice:function(a,b){for(var c,d=[],e=0;e<=this.doc.drag_items_for_choice(a).size();e++){var f=this.doc.drag_item_for_choice(a,e);f&&(f.removeClass("item"+e),f.hasClass("beingdragged")||(c=this.convert_to_bg_img_xy(f.getXY()),this.xy_in_bgimg(c)&&(f.removeClass("item"+e),f.addClass("item"+d.length),d[d.length]=c)))}null!==b&&(c=this.convert_to_bg_img_xy(b.getXY()),b.addClass("item"+d.length),this.xy_in_bgimg(c)&&(d[d.length]=c)),this.set_form_value(a,d.join(";"))},reset_drag_xy:function(a){this.set_form_value(a,"")},set_form_value:function(a,b){this.doc.input_for_choice(a).set("value",b)},xy_in_bgimg:function(a){return!(a[0]<0||a[1]<0||a[0]>this.doc.bg_img().get("width")||a[1]>this.doc.bg_img().get("height"))},constrain_to_bgimg:function(a){var b=this.convert_to_bg_img_xy(a);return b[0]=Math.max(0,b[0]),b[1]=Math.max(0,b[1]),b[0]=Math.min(this.doc.bg_img().get("width"),b[0]),b[1]=Math.min(this.doc.bg_img().get("height"),b[1]),this.convert_to_window_xy(b)},convert_to_bg_img_xy:function(a){return[Number(a[0])-this.doc.bg_img().getX()-1,Number(a[1])-this.doc.bg_img().getY()-1]},redraw_drags_and_drops:function(){if(this.doc.drag_items().each(function(a){a.addClass("unneeded")},this),this.doc.inputs_for_choices().each(function(a){for(var b=this.get_choiceno_for_node(a),c=this.get_coords(a),d=this.doc.drag_item_home(b),e=0;e<c.length;e++){var f=this.doc.drag_item_for_choice(b,e);!f||f.hasClass("beingdragged")?f=this.clone_new_drag_item(d,e):f.removeClass("unneeded"),f.setXY(c[e])}},this),this.doc.drag_items().each(function(a){a.hasClass("unneeded")&&!a.hasClass("beingdragged")&&a.remove(!0)},this),null!==this.graphics?this.graphics.clear():this.graphics=new a.Graphic({render:this.doc.top_node().one("div.ddarea div.dropzones")}),0!==this.get("dropzones").length){this.restart_colours();for(var b in this.get("dropzones")){var c=this.get_next_colour(),d=this.get("dropzones")[b];this.draw_drop_zone(b,d.markertext,d.shape,d.coords,c,!0)}}},get_coords:function(a){var b=this.get_choiceno_for_node(a),c=a.get("value"),d=a.hasClass("infinite"),e=this.get_noofdrags_for_node(a),f=null!==this.doc.drag_item_being_dragged(b),g=[];if(""!==c)for(var h=c.split(";"),i=0;i<h.length;i++)g[g.length]=this.convert_to_window_xy(h[i].split(","));var j=g.length+(f?1:0);return(d||j<e)&&(g[g.length]=this.drag_home_xy(b)),g},drag_home_xy:function(a){var b=this.doc.drag_item_home(a);return[b.getX(),b.getY()-12]},get_choiceno_for_node:function(a){return Number(this.doc.get_classname_numeric_suffix(a,"choice"))},get_itemno_for_node:function(a){return Number(this.doc.get_classname_numeric_suffix(a,"item"))},get_noofdrags_for_node:function(a){return Number(this.doc.get_classname_numeric_suffix(a,"noofdrags"))},drop_zone_key_press:function(a){var b=a.target,c=b.getXY();switch(a.direction){case"left":c[0]-=1;break;case"right":c[0]+=1;break;case"down":c[1]+=1;break;case"up":c[1]-=1;break;case"remove":c=null}var d=this.get_choiceno_for_node(b);c=null!==c?this.constrain_to_bgimg(c):this.drag_home_xy(d),a.preventDefault(),b.setXY(c),this.save_all_xy_for_choice(d,null)}},{NAME:e,ATTRS:{dropzones:{value:[]}}}),a.Event.define("dragchange",{_event:a.UA.webkit||a.UA.ie?"keydown":"keypress",_keys:{32:"remove",37:"left",38:"up",39:"right",40:"down",65:"left",87:"up",68:"right",83:"down",27:"remove"},_keyHandler:function(a,b){this._keys[a.keyCode]&&(a.direction=this._keys[a.keyCode],b.fire(a))},on:function(a,b,c){b._detacher=a.on(this._event,this._keyHandler,this,c)}}),M.qtype_ddmarker.init_question=function(a){return new f(a)}},"@VERSION@",{requires:["node","event-resize","dd","dd-drop","dd-constrain","graphics"]});