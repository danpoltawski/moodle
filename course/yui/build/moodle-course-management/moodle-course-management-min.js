YUI.add("moodle-course-management",function(a,b){function c(){c.superclass.constructor.apply(this,arguments)}function d(a){c.superclass.constructor.apply(this,[a])}function e(){e.superclass.constructor.apply(this,arguments)}function f(){f.superclass.constructor.apply(this,arguments)}function g(){g.superclass.constructor.apply(this,arguments)}c.NAME="moodle-course-management",c.CSS_PREFIX="management",c.ATTRS={element:{setter:function(b){return"string"==typeof b&&(b=a.one("#"+b)),b}},categorylisting:{value:null},courselisting:{value:null},coursedetails:{value:null},activecategoryid:{value:null},activecourseid:{value:null},categories:{setter:function(b,c){if(a.Lang.isArray(b))return b;var d=this.get(c);return d.push(b),d},value:[]},courses:{validator:function(b){return a.Lang.isArray(b)},value:[]},page:{getter:function(a,b){return null===a&&(a=this.get("element").getData(b),this.set(b,a)),a},value:null},totalpages:{getter:function(a,b){return null===a&&(a=this.get("element").getData(b),this.set(b,a)),a},value:null},totalcourses:{getter:function(a,b){return null===a&&(a=this.get("element").getData(b),this.set(b,a)),a},value:null},ajaxurl:{getter:function(a){return null===a&&(a=M.cfg.wwwroot+"/course/ajax/management.php"),a},value:null},dragdrop:{value:null}},c.prototype={categoriesinit:!1,initializer:function(){this.set("element","coursecat-management");var a=this.get("element"),b=a.one("#category-listing"),c=a.one("#course-listing"),e=null,f=null;b&&(e=b.one('.listitem[data-selected="1"]')),c&&(f=c.one('.listitem[data-selected="1"]')),this.set("categorylisting",b),this.set("courselisting",c),this.set("coursedetails",a.one("#course-detail")),e&&this.set("activecategoryid",e.getData("id")),f&&this.set("activecourseid",f.getData("id")),this.initialiseCategories(b),this.initialiseCourses(),c&&this.set("dragdrop",new d({console:this}))},initialiseCategories:function(a){var b=0;if(!a)return!1;var c=a.one("#menumovecategoriesto");c&&c.setAttribute("disabled",!0);var d=a.one("#menuresortcategoriesby");d&&d.setAttribute("disabled",!0);var e=a.one("#menuresortcoursesby");e&&e.setAttribute("disabled",!0),a.all(".listitem[data-id]").each(function(a){this.set("categories",new f({node:a,console:this})),b++},this),this.categoriesinit||(this.get("categorylisting").delegate("click",this.handleCategoryDelegation,"a[data-action]",this),this.get("categorylisting").delegate("click",this.handleCategoryDelegation,'input[name="bcat[]"]',this),this.get("categorylisting").delegate("click",this.handleBulkSortByaction,"#menuselectsortby",this),this.categoriesinit=!0)},initialiseCourses:function(){var a=this.getCategoryById(this.get("activecategoryid")),b=this.get("courselisting"),c=0;if(!b)return!1;var d=b.one("#menumovecoursesto");d&&d.setAttribute("disabled",!0),b.all(".listitem[data-id]").each(function(b){this.registerCourse(new g({node:b,console:this,category:a})),c++},this),b.delegate("click",this.handleCourseDelegation,"a[data-action]",this),b.delegate("click",this.handleCourseDelegation,'input[name="bc[]"]',this)},registerCourse:function(a){var b=this.get("courses");b.push(a),this.set("courses",b)},handleCourseDelegation:function(a){var b=a.currentTarget,c=b.getData("action"),d=b.ancestor(".listitem").getData("id"),e=this.getCourseById(d);e&&e.handle(c,a)},handleCategoryDelegation:function(a){var b=a.currentTarget,c=b.getData("action"),d=b.ancestor(".listitem").getData("id"),e=this.getCategoryById(d);e&&e.handle(c,a)},isCourseSelected:function(a){var b=!1;if(a&&a.get("checked"))b=!0;else{var c,d,e=this.get("courses"),f=e.length;for(c=0;c<f;c++)if(e.hasOwnProperty(c)&&(d=e[c],d.get("node").one('input[name="bc[]"]').get("checked"))){b=!0;break}}return b},isCategorySelected:function(a){var b=!1;if(a&&a.get("checked"))b=!0;else{var c,d,e=this.get("categories"),f=e.length;for(c=0;c<f;c++)if(e.hasOwnProperty(c)&&(d=e[c],d.get("node").one('input[name="bcat[]"]').get("checked"))){b=!0;break}}return b},handleBulkSortByaction:function(a){var b=this.get("categorylisting").one("#menuresortcategoriesby"),c=this.get("categorylisting").one("#menuresortcoursesby"),d=this.get("categorylisting").one('input[name="bulksort"]'),e=a;e?a&&a.currentTarget&&(e=a.currentTarget):e=this.get("categorylisting").one("#menuselectsortby"),e&&(this.get("categories").length<=1||!this.isCategorySelected()&&"selectedcategories"===e.get("options").item(e.get("selectedIndex")).getAttribute("value")?(b&&b.setAttribute("disabled",!0),c&&c.setAttribute("disabled",!0),d&&d.setAttribute("disabled",!0)):(b&&b.removeAttribute("disabled"),c&&c.removeAttribute("disabled"),d&&d.removeAttribute("disabled")))},getCategoryById:function(a){var b,c,d=this.get("categories"),e=d.length;for(b=0;b<e;b++)if(d.hasOwnProperty(b)&&(c=d[b],c.get("categoryid")===a))return c;return!1},getCourseById:function(a){var b,c,d=this.get("courses"),e=d.length;for(b=0;b<e;b++)if(d.hasOwnProperty(b)&&(c=d[b],c.get("courseid")===a))return c;return!1},removeCourseById:function(a){var b,c,d=this.get("courses"),e=d.length;for(c=0;c<e;c++)if(b=d[c],b.get("courseid")===a){d.splice(c,1);break}},performAjaxAction:function(b,c,d,e){var f=new a.IO;c.action=b,c.ajax="1",c.sesskey=M.cfg.sesskey,null===d&&(d=function(){}),f.send(this.get("ajaxurl"),{method:"POST",on:{complete:d},context:e,data:c,arguments:c})}},a.extend(c,a.Base,c.prototype),M.course=M.course||{},M.course.management=M.course.management||{},M.course.management.console=null,M.course.management.init=function(a){M.course.management.console=new c(a)},d.NAME="moodle-course-management-dd",d.CSS_PREFIX="management-dd",d.ATTRS={console:{writeOnce:"initOnly"}},d.prototype={goingup:!1,lasty:null,previoussibling:null,initializer:function(){var b=this.get("console"),c=b.get("element"),d=c.one("#category-listing"),e=c.one("#course-listing > .course-listing"),f=d?d.one("ul.ml"):null,g=e?e.one("ul.ml"):null,h=!!e&&e.getData("canmoveoutof"),i=h?c:g;return!!g&&(g.all("> li").each(function(a){this.initCourseListing(a,i)},this),g.setData("dd",new a.DD.Drop({node:g})),h&&f&&f.all("li > div").each(function(a){this.initCategoryListitem(a)},this),a.DD.DDM.on("drag:start",this.dragStart,this),a.DD.DDM.on("drag:end",this.dragEnd,this),a.DD.DDM.on("drag:drag",this.dragDrag,this),a.DD.DDM.on("drop:over",this.dropOver,this),a.DD.DDM.on("drop:enter",this.dropEnter,this),a.DD.DDM.on("drop:exit",this.dropExit,this),void a.DD.DDM.on("drop:hit",this.dropHit,this))},initCourseListing:function(b,c){b.setData("dd",new a.DD.Drag({node:b,target:{padding:"0 0 0 20"}}).addHandle(".drag-handle").plug(a.Plugin.DDProxy,{moveOnEnd:!1,borderStyle:!1}).plug(a.Plugin.DDConstrained,{constrain2node:c}))},initCategoryListitem:function(b){b.setData("dd",new a.DD.Drop({node:b}))},dragStart:function(a){var b=a.target,c=b.get("node"),d=b.get("dragNode");c.addClass("course-being-dragged"),d.addClass("course-being-dragged-proxy").set("innerHTML",c.one("a.coursename").get("innerHTML")),this.previoussibling=c.get("previousSibling")},dragEnd:function(a){var b=a.target,c=b.get("node");c.removeClass("course-being-dragged"),this.get("console").get("element").all("#category-listing li.highlight").removeClass("highlight")},dragDrag:function(a){var b=a.target.lastXY[1];b<this.lasty?this.goingup=!0:this.goingup=!1,this.lasty=b},dropOver:function(a){var b=a.drag.get("node"),c=a.drop.get("node"),d=c.get("tagName").toLowerCase();if("li"===d&&c.hasClass("listitem-course")){if(!this.goingup&&(c=c.get("nextSibling"),!c))return c=a.drop.get("node"),c.get("parentNode").append(b),!1;c.get("parentNode").insertBefore(b,c),a.drop.sizeShim()}},dropEnter:function(a){var b=a.drop.get("node"),c=b.get("tagName").toLowerCase();"div"===c&&b.ancestor("li.listitem-category").addClass("highlight")},dropExit:function(a){var b=a.drop.get("node"),c=b.get("tagName").toLowerCase();"div"===c&&b.ancestor("li.listitem-category").removeClass("highlight")},dropHit:function(a){var b,c,d,e,f,g,h,i=a.drag.get("node"),j=a.drop.get("node"),k=null!==j.ancestor(".listitem-category"),l=!k&&j.test(".listitem-course"),m=this.get("console");return!!i.test(".listitem-course")&&(d=i.getData("id"),void(k?(b=j.ancestor(".listitem-category").getData("id"),c=m.getCategoryById(b),c&&(e=m.getCourseById(d),e&&c.moveCourseTo(e))):(l||j.ancestor("#course-listing"))&&(e=m.getCourseById(d),g=i.get("previousSibling"),f=g?g.getData("id")||0:0,h=this.previoussibling?this.previoussibling.getData("id"):0,f!==h&&e.moveAfter(f,h))))}},a.extend(d,a.Base,d.prototype),e.NAME="moodle-course-management-item",e.CSS_PREFIX="management-item",e.ATTRS={node:{},console:{},itemname:{value:"item"}},e.prototype={highlighttimeout:null,checkAjaxResponse:function(b,c,d){if(200!==c.status)return!1;if(null===b||null===d)return!1;var e=a.JSON.parse(c.responseText);return e.error!==!1&&new M.core.exception(e),e.outcome!==!1&&e},moveup:function(b,c,d){var e,f,g,h,i,j,k,l=this.checkAjaxResponse(b,c,d);return l!==!1&&(e=this.get("node"),h=e.previous(".listitem"),void(h?(h.insert(e,"before"),i=h.one(" > div a.action-moveup"),g=e.one(" > div a.action-movedown"),i&&g||(f=e.one(" > div a.action-moveup"),j=h.one(" > div a.action-movedown"),i||g?g||f.insert(j,"after"):(k=a.Node.create('<a style="visibility:hidden;">&nbsp;</a>'),j.replace(k),f.replace(j),k.replace(f),k.destroy())),f=e.one(" > div a.action-moveup"),f?f.focus():(g=e.one(" > div a.action-movedown"),g&&g.focus()),this.updated(!0)):window.location.reload()))},movedown:function(b,c,d){var e,f,g,h,i,j,k,l=this.checkAjaxResponse(b,c,d);return l!==!1&&(e=this.get("node"),f=e.next(".listitem"),void(f?(e.insert(f,"before"),j=f.one(" > div a.action-movedown"),g=e.one(" > div a.action-moveup"),j&&g||(i=f.one(" > div a.action-moveup"),h=e.one(" > div a.action-movedown"),j||g?g||h.insert(i,"before"):(k=a.Node.create('<a style="visibility:hidden;">&nbsp;</a>'),i.replace(k),h.replace(i),k.replace(h),k.destroy())),h=e.one(" > div a.action-movedown"),h?h.focus():(g=e.one(" > div a.action-moveup"),g&&g.focus()),this.updated(!0)):window.location.reload()))},show:function(a,b,c){var d,e=this.checkAjaxResponse(a,b,c);return e!==!1&&(this.markVisible(),d=this.get("node").one("a[data-action=hide]"),d&&d.focus(),void this.updated())},markVisible:function(){return this.get("node").setAttribute("data-visible","1"),!0},hide:function(a,b,c){var d,e=this.checkAjaxResponse(a,b,c);return e!==!1&&(this.markHidden(),d=this.get("node").one("a[data-action=show]"),d&&d.focus(),void this.updated())},markHidden:function(){return this.get("node").setAttribute("data-visible","0"),!0},updated:function(a){a&&this.highlight()},highlight:function(){var a=this.get("node");a.siblings(".highlight").removeClass("highlight"),a.addClass("highlight"),this.highlighttimeout&&window.clearTimeout(this.highlighttimeout),this.highlighttimeout=window.setTimeout(function(){a.removeClass("highlight")},2500)}},a.extend(e,a.Base,e.prototype),f.NAME="moodle-course-management-category",f.CSS_PREFIX="management-category",f.ATTRS={categoryid:{getter:function(a,b){return null===a&&(a=this.get("node").getData("id"),this.set(b,a)),a},value:null,writeOnce:!0},selected:{getter:function(a,b){return null===a&&(a=this.get("node").getData(b),null===a&&(a=!1),this.set(b,a)),a},value:null},courses:{validator:function(b){return a.Lang.isArray(b)},value:[]}},f.prototype={initializer:function(){this.set("itemname","category")},getName:function(){return this.get("node").one("a.categoryname").get("innerHTML")},registerCourse:function(a){var b=this.get("courses");b.push(a),this.set("courses",b)},handle:function(a,b){var c={categoryid:this.get("categoryid")},d=this.get("console").get("activecategoryid");switch(d&&d!==c.categoryid&&(c.selectedcategory=d),a){case"moveup":b.preventDefault(),this.get("console").performAjaxAction("movecategoryup",c,this.moveup,this);break;case"movedown":b.preventDefault(),this.get("console").performAjaxAction("movecategorydown",c,this.movedown,this);break;case"show":b.preventDefault(),this.get("console").performAjaxAction("showcategory",c,this.show,this);break;case"hide":b.preventDefault(),this.get("console").performAjaxAction("hidecategory",c,this.hide,this);break;case"expand":b.preventDefault(),"0"===this.get("node").getData("expanded")&&(this.get("node").setAttribute("data-expanded","1").setData("expanded","true"),this.get("console").performAjaxAction("getsubcategorieshtml",c,this.loadSubcategories,this)),this.expand();break;case"collapse":b.preventDefault(),this.collapse();break;case"select":var e=this.get("console"),f=e.get("categorylisting").one("#menumovecategoriesto");f&&(e.isCategorySelected(b.currentTarget)&&e.get("categories").length>1?f.removeAttribute("disabled"):f.setAttribute("disabled",!0),e.handleBulkSortByaction());break;default:return!1}},expand:function(){var a=this.get("node"),b=a.one("a[data-action=expand]"),c=a.one("ul[role=group]");a.removeClass("collapsed").setAttribute("aria-expanded","true"),b.setAttribute("data-action","collapse").setAttrs({title:M.util.get_string("collapsecategory","moodle",this.getName())}).one("img").setAttrs({src:M.util.image_url("t/switch_minus","moodle"),alt:M.util.get_string("collapse","moodle")}),c&&c.setAttribute("aria-hidden","false"),this.get("console").performAjaxAction("expandcategory",{categoryid:this.get("categoryid")},null,this)},collapse:function(){var a=this.get("node"),b=a.one("a[data-action=collapse]"),c=a.one("ul[role=group]");a.addClass("collapsed").setAttribute("aria-expanded","false"),b.setAttribute("data-action","expand").setAttrs({title:M.util.get_string("expandcategory","moodle",this.getName())}).one("img").setAttrs({src:M.util.image_url("t/switch_plus","moodle"),alt:M.util.get_string("expand","moodle")}),c&&c.setAttribute("aria-hidden","true"),this.get("console").performAjaxAction("collapsecategory",{categoryid:this.get("categoryid")},null,this)},loadSubcategories:function(a,b,c){var d,e,f=this.checkAjaxResponse(a,b,c),g=this.get("node"),h=this.get("console");return f!==!1&&(g.append(f.html),h.initialiseCategories(g),M.core&&M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(g),d=g.one("ul[role=group]"),e=g.one("a[data-action=collapse]"),d&&e&&e.setAttribute("aria-controls",d.generateID()),!0)},moveCourseTo:function(b){var c=this;a.use("moodle-core-notification-confirm",function(){var a=new M.core.confirm({title:M.util.get_string("confirm","moodle"),question:M.util.get_string("confirmcoursemove","moodle",{course:b.getName(),category:c.getName()}),yesLabel:M.util.get_string("move","moodle"),noLabel:M.util.get_string("cancel","moodle")});a.on("complete-yes",function(){a.hide(),a.destroy(),this.get("console").performAjaxAction("movecourseintocategory",{categoryid:this.get("categoryid"),courseid:b.get("courseid")},this.completeMoveCourse,this)},c),a.show()})},completeMoveCourse:function(a,b,c){var d,e,f,g=this.checkAjaxResponse(a,b,c),h=this.get("console");return g!==!1&&(!!(e=h.getCourseById(c.courseid))&&(this.highlight(),e&&(g.paginationtotals&&(f=h.get("courselisting").one(".listing-pagination-totals"),f&&f.set("innerHTML",g.paginationtotals)),"undefined"!==g.totalcatcourses&&(f=this.get("node").one(".course-count span"),f&&f.set("innerHTML",f.get("innerHTML").replace(/^\d+/,g.totalcatcourses))),"undefined"!=typeof g.fromcatcoursecount&&(d=h.get("activecategoryid"),d=h.getCategoryById(d),d&&(f=d.get("node").one(".course-count span"),f&&f.set("innerHTML",f.get("innerHTML").replace(/^\d+/,g.fromcatcoursecount)))),e.remove()),!0))},show:function(a,b,c){var d,e=this.checkAjaxResponse(a,b,c);return e!==!1&&(this.markVisible(),d=this.get("node").one("a[data-action=hide]"),d&&d.focus(),e.categoryvisibility&&this.updateChildVisibility(e.categoryvisibility),e.coursevisibility&&this.updateCourseVisiblity(e.coursevisibility),void this.updated())},hide:function(a,b,c){var d,e=this.checkAjaxResponse(a,b,c);return e!==!1&&(this.markHidden(),d=this.get("node").one("a[data-action=show]"),d&&d.focus(),e.categoryvisibility&&this.updateChildVisibility(e.categoryvisibility),e.coursevisibility&&this.updateCourseVisiblity(e.coursevisibility),void this.updated())},updateCourseVisiblity:function(a){var b,c,d=this.get("console");try{for(b in a)"object"==typeof a[b]&&(c=d.getCourseById(a[b].id),c&&("1"===a[b].visible?c.markVisible():c.markHidden()))}catch(e){}return this},updateChildVisibility:function(a){var b,c,d=this.get("console");try{for(b in a)"object"==typeof a[b]&&(c=d.getCategoryById(a[b].id),c&&("1"===a[b].visible?c.markVisible():c.markHidden()))}catch(e){}return this}},a.extend(f,e,f.prototype),g.NAME="moodle-course-management-course",g.CSS_PREFIX="management-course",g.ATTRS={courseid:{},selected:{getter:function(a,b){return null===a&&(a=this.get("node").getData(b),this.set(b,a)),a},value:null},node:{},console:{writeOnce:"initOnly"},category:{writeOnce:"initOnly"}},g.prototype={initializer:function(){var a=this.get("node"),b=this.get("category");this.set("courseid",a.getData("id")),b&&b.registerCourse&&b.registerCourse(this),this.set("itemname","course")},getName:function(){return this.get("node").one("a.coursename").get("innerHTML")},handle:function(a,b){var c=this.get("console"),d={courseid:this.get("courseid")};switch(a){case"moveup":b.halt(),c.performAjaxAction("movecourseup",d,this.moveup,this);break;case"movedown":b.halt(),c.performAjaxAction("movecoursedown",d,this.movedown,this);break;case"show":b.halt(),c.performAjaxAction("showcourse",d,this.show,this);break;case"hide":b.halt(),c.performAjaxAction("hidecourse",d,this.hide,this);break;case"select":var e=this.get("console"),f=e.get("courselisting").one("#menumovecoursesto");f&&(e.isCourseSelected(b.currentTarget)?f.removeAttribute("disabled"):f.setAttribute("disabled",!0));break;default:return!1}},remove:function(){this.get("console").removeCourseById(this.get("courseid")),this.get("node").remove()},moveAfter:function(a,b){var c=this.get("console"),d={courseid:this.get("courseid"),moveafter:a,previous:b};c.performAjaxAction("movecourseafter",d,this.moveAfterResponse,this)},moveAfterResponse:function(a,b,c){var d,e=this.checkAjaxResponse(a,b,c),f=this.get("node");return e===!1?(d=f.ancestor("ul").one("li[data-id="+c.previous+"]"),d?d.insertAfter(f,"after"):f.ancestor("ul").one("li").insert(f,"before"),!1):void this.highlight()}},a.extend(g,e,g.prototype)},"@VERSION@",{requires:["base","node","io-base","moodle-core-notification-exception","json-parse","dd-constrain","dd-proxy","dd-drop","dd-delegate","node-event-delegate"]});