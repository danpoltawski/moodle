YUI.add("moodle-course-dragdrop",function(a,b){var c={ACTIONAREA:".actions",ACTIVITY:"activity",ACTIVITYINSTANCE:"activityinstance",CONTENT:"content",COURSECONTENT:"course-content",EDITINGMOVE:"editing_move",ICONCLASS:"iconsmall",JUMPMENU:"jumpmenu",LEFT:"left",LIGHTBOX:"lightbox",MOVEDOWN:"movedown",MOVEUP:"moveup",PAGECONTENT:"page-content",RIGHT:"right",SECTION:"section",SECTIONADDMENUS:"section_add_menus",SECTIONHANDLE:"section-handle",SUMMARY:"summary",SECTIONDRAGGABLE:"sectiondraggable"};M.course=M.course||{};var d=function(){d.superclass.constructor.apply(this,arguments)};a.extend(d,M.core.dragdrop,{sectionlistselector:null,initializer:function(){if(this.groups=[c.SECTIONDRAGGABLE],this.samenodeclass=M.course.format.get_sectionwrapperclass(),this.parentnodeclass=M.course.format.get_containerclass(),a.Node.one("."+c.JUMPMENU))return!1;if(this.sectionlistselector=M.course.format.get_section_wrapper(a),this.sectionlistselector){this.sectionlistselector="."+c.COURSECONTENT+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector);var b=new a.DD.Delegate({container:"."+c.COURSECONTENT,nodes:"."+c.SECTIONDRAGGABLE,target:!0,handles:["."+c.LEFT],dragConfig:{groups:this.groups}});b.dd.plug(a.Plugin.DDProxy,{moveOnEnd:!1}),b.dd.plug(a.Plugin.DDConstrained,{constrain:"#"+c.PAGECONTENT,stickY:!0}),b.dd.plug(a.Plugin.DDWinScroll)}},setup_for_section:function(b){a.Node.all(b).each(function(b){var d=a.Moodle.core_course.util.section.getId(b);if(d>0){var e=b.one("."+c.RIGHT+" a."+c.MOVEDOWN),f=b.one("."+c.RIGHT+" a."+c.MOVEUP),g=M.util.get_string("movesection","moodle",d),h=b.one("."+c.LEFT);if((e||f)&&h){if(h.setStyle("cursor","move"),h.appendChild(this.get_drag_handle(g,c.SECTIONHANDLE,"icon",!0)),f&&(f.previous("br")?f.previous("br").remove():f.next("br")&&f.next("br").remove(),f.ancestor(".section_action_menu")&&"li"==f.ancestor().get("nodeName").toLowerCase()?f.ancestor().remove():f.remove()),e){e.previous("br")?e.previous("br").remove():e.next("br")&&e.next("br").remove();var i=e.ancestor().get("nodeName").toLowerCase();e.ancestor(".section_action_menu")&&"li"==i?e.ancestor().remove():e.remove()}b.addClass(c.SECTIONDRAGGABLE)}}},this)},drag_start:function(b){var d=b.target,e=a.Node.create("<"+M.course.format.get_containernode()+"></"+M.course.format.get_containernode()+">");e.addClass(M.course.format.get_containerclass());var f=a.Node.create("<"+M.course.format.get_sectionwrappernode()+"></"+M.course.format.get_sectionwrappernode()+">");f.addClass(M.course.format.get_sectionwrapperclass()),f.setStyle("margin",0),f.setContent(d.get("node").get("innerHTML")),e.appendChild(f),d.get("dragNode").setContent(e),d.get("dragNode").addClass(c.COURSECONTENT)},drag_dropmiss:function(a){this.drop_hit(a)},get_section_index:function(b){var d="."+c.COURSECONTENT+" "+M.course.format.get_section_selector(a),e=a.all(d),f=e.indexOf(b),g=e.indexOf(a.one("#section-0"));return f-g},drop_hit:function(b){var d=b.drag,e=d.get("node"),f=a.Moodle.core_course.util.section.getId(e),g=f,h=this.get_section_index(e),i=h;if(f!==h){g>i&&(g=h,i=f),d.get("dragNode").removeClass(c.COURSECONTENT);var j,k=a.Node.all(this.sectionlistselector),l=M.util.add_lightbox(a,e),m={},n=this.get("config").pageparams;for(j in n)n.hasOwnProperty(j)&&(m[j]=n[j]);m.sesskey=M.cfg.sesskey,m.courseId=this.get("courseid"),m["class"]="section",m.field="move",m.id=f,m.value=h;var o=M.cfg.wwwroot+this.get("ajaxurl");a.io(o,{method:"POST",data:m,on:{start:function(){l.show()},success:function(b,c){try{var d=a.JSON.parse(c.responseText);d.error&&new M.core.ajaxException(d),M.course.format.process_sections(a,k,d,g,i)}catch(e){}var f,h=!1;do{for(h=!1,f=g;f<=i;f++)if(a.Moodle.core_course.util.section.getId(k.item(f-1))>a.Moodle.core_course.util.section.getId(k.item(f))){var j=k.item(f-1).get("id");k.item(f-1).set("id",k.item(f).get("id")),k.item(f).set("id",j),M.course.format.swap_sections(a,f-1,f),h=!0}i-=1}while(h);window.setTimeout(function(){l.hide()},250)},failure:function(a,b){this.ajax_failure(b),l.hide()}},context:this})}}},{NAME:"course-dragdrop-section",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_section_dragdrop=function(a){new d(a)};var e=function(){e.superclass.constructor.apply(this,arguments)};a.extend(e,M.core.dragdrop,{initializer:function(){this.groups=["resource"],this.samenodeclass=c.ACTIVITY,this.parentnodeclass=c.SECTION,this.resourcedraghandle=this.get_drag_handle(M.util.get_string("movecoursemodule","moodle"),c.EDITINGMOVE,c.ICONCLASS,!0),this.samenodelabel={identifier:"afterresource",component:"moodle"},this.parentnodelabel={identifier:"totopofsection",component:"moodle"};var b=M.course.format.get_section_selector(a);if(b){b="."+c.COURSECONTENT+" "+b,this.setup_for_section(b);var d=b.slice(c.COURSECONTENT.length+2)+" li."+c.ACTIVITY,e=new a.DD.Delegate({container:"."+c.COURSECONTENT,nodes:d,target:!0,handles:["."+c.EDITINGMOVE],dragConfig:{groups:this.groups}});e.dd.plug(a.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),e.dd.plug(a.Plugin.DDConstrained,{constrain:"#"+c.PAGECONTENT}),e.dd.plug(a.Plugin.DDWinScroll),M.course.coursebase.register_module(this),M.course.dragres=this}},setup_for_section:function(b){a.Node.all(b).each(function(b){var d=b.one("."+c.CONTENT+" ul."+c.SECTION);d||(d=a.Node.create("<ul></ul>"),d.addClass(c.SECTION),b.one("."+c.CONTENT+" div."+c.SUMMARY).insert(d,"after")),d.setAttribute("data-draggroups",this.groups.join(" ")),new a.DD.Drop({node:d,groups:this.groups,padding:"20 0 20 0"}),this.setup_for_resource("#"+b.get("id")+" li."+c.ACTIVITY)},this)},setup_for_resource:function(b){a.Node.all(b).each(function(b){var d=b.getData("draggroups");d||(b.setAttribute("data-draggroups",this.groups.join(" ")),new a.DD.Drop({node:b,groups:this.groups,padding:"20 0 20 0"}));var e=b.one("a."+c.EDITINGMOVE);e&&e.replace(this.resourcedraghandle.cloneNode(!0))},this)},drag_start:function(a){var b=a.target;b.get("dragNode").setContent(b.get("node").get("innerHTML")),b.get("dragNode").all("img.iconsmall").setStyle("vertical-align","baseline")},drag_dropmiss:function(a){this.drop_hit(a)},drop_hit:function(b){var d,e=b.drag,f=e.get("node"),g=b.drop.get("node"),h=f.one(c.ACTIONAREA),i=M.util.add_spinner(a,h),j={},k=this.get("config").pageparams;for(d in k)j[d]=k[d];j.sesskey=M.cfg.sesskey,j.courseId=this.get("courseid"),j["class"]="resource",j.field="move",j.id=Number(a.Moodle.core_course.util.cm.getId(f)),j.sectionId=a.Moodle.core_course.util.section.getId(g.ancestor(M.course.format.get_section_wrapper(a),!0)),f.next()&&(j.beforeId=Number(a.Moodle.core_course.util.cm.getId(f.next())));var l=M.cfg.wwwroot+this.get("ajaxurl");a.io(l,{method:"POST",data:j,on:{start:function(){this.lock_drag_handle(e,c.EDITINGMOVE),i.show()},success:function(b,d){var g=a.JSON.parse(d.responseText),h={element:f,visible:g.visible};M.course.coursebase.invoke_function("set_visibility_resource_ui",h),this.unlock_drag_handle(e,c.EDITINGMOVE),window.setTimeout(function(){i.hide()},250)},failure:function(a,b){this.ajax_failure(b),this.unlock_drag_handle(e,c.SECTIONHANDLE),i.hide()}},context:this})}},{NAME:"course-dragdrop-resource",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_resource_dragdrop=function(a){new e(a)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-course-coursebase","moodle-course-util"]});