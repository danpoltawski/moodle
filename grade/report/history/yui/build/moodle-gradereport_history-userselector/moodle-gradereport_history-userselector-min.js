YUI.add("moodle-gradereport_history-userselector",function(a,b){var c="gradereport_history",d={AJAXURL:"ajaxurl",BASE:"base",CHECKBOX_NAME_PREFIX:"usp-u",COURSEID:"courseid",DIALOGUE_PREFIX:"moodle-dialogue",NAME:"gradereport_history_usp",PAGE:"page",PARAMS:"params",PERPAGE:"perPage",SEARCH:"search",SEARCHBTN:"searchbtn",SELECTEDUSERS:"selectedUsers",URL:"url",USERCOUNT:"userCount"},e={ACCESSHIDE:"accesshide",AJAXCONTENT:"usp-ajax-content",CHECKBOX:"usp-checkbox",CLOSE:"close",CLOSEBTN:"usp-finish",CONTENT:"usp-content",DETAILS:"details",EXTRAFIELDS:"extrafields",FIRSTADDED:"usp-first-added",FULLNAME:"fullname",HEADER:"usp-header",HIDDEN:"hidden",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",MORERESULTS:"usp-more-results",OPTIONS:"options",PICTURE:"usp-picture",RESULTSCOUNT:"usp-results-count",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",SEARCHFIELD:"usp-search-field",SEARCHRESULTS:"usp-search-results",SELECTED:"selected",USER:"usp-user",USERS:"usp-users",WRAP:"usp-wrap"},f={AJAXCONTENT:"."+e.AJAXCONTENT,FINISHBTN:"."+e.CLOSEBTN+" input",FIRSTADDED:"."+e.FIRSTADDED,FULLNAME:"."+e.FULLNAME+" label",LIGHTBOX:"."+e.LIGHTBOX,MORERESULTS:"."+e.MORERESULTS,OPTIONS:"."+e.OPTIONS,PICTURE:"."+e.USER+" .userpicture",RESULTSCOUNT:"."+e.RESULTSCOUNT,RESULTSUSERS:"."+e.SEARCHRESULTS+" ."+e.USERS,SEARCHBTN:"."+e.SEARCHBTN,SEARCHFIELD:"."+e.SEARCHFIELD,SELECTEDNAMES:".felement .selectednames",TRIGGER:".gradereport_history_plugin input.selectortrigger",USER:"."+e.USER,USERFULLNAMES:'input[name="userfullnames"]',USERIDS:'input[name="userids"]',USERSELECT:"."+e.CHECKBOX+" input[type=checkbox]"},g=function(){g.superclass.constructor.apply(this,arguments)};a.namespace("M.gradereport_history").UserSelector=a.extend(g,M.core.dialogue,{_firstDisplay:!0,_usersBufferList:null,_userTabFocus:null,_userTemplate:null,initializer:function(){var b,g,h,i=this.get("boundingBox");h=a.Handlebars.compile('<div class="{{CSS.WRAP}}"><div class="{{CSS.HEADER}}"><div class="{{CSS.SEARCH}}" role="search"><form><input type="text" class="{{CSS.SEARCHFIELD}}" aria-label="{{get_string "search" "moodle"}}" value="" /><input type="submit" class="{{CSS.SEARCHBTN}}"value="{{get_string "search" "moodle"}}"></form><div aria-live="polite" class="{{CSS.RESULTSCOUNT}}">{{get_string "loading" "admin"}}</div></div></div><div class="{{CSS.CONTENT}}"><form><div class="{{CSS.AJAXCONTENT}}" aria-live="polite"></div><div class="{{CSS.LIGHTBOX}} {{CSS.HIDDEN}}"><img class="{{CSS.LOADINGICON}}" alt="{{get_string "loading" "admin"}}"src="{{{loadingIcon}}}"></div><div class="{{CSS.CLOSEBTN}}"><input type="submit" value="{{get_string "finishselectingusers" COMPONENT}}"></div></form></div></div>'),b=a.Node.create(h({COMPONENT:c,CSS:e,loadingIcon:M.util.image_url("i/loading","moodle")})),this.getStdModNode(a.WidgetStdMod.HEADER).prepend(a.Node.create("<h1>"+this.get("title")+"</h1>")),this.setStdModContent(a.WidgetStdMod.BODY,b,a.WidgetStdMod.REPLACE),this.get("boundingBox").one(".moodle-dialogue-wrap").addClass("moodle-dialogue-content"),a.one(f.TRIGGER).on("click",this.show,this),i.one(f.FINISHBTN).on("click",this.finishSelectingUsers,this),i.delegate("key",this.userKeyboardNavigation,"down:38,40",f.AJAXCONTENT,this),a.delegate("click",this.selectUser,f.AJAXCONTENT,f.USERSELECT,this),a.delegate("click",this.selectUser,f.AJAXCONTENT,f.PICTURE,this),g=this.get(d.PARAMS),g.id=this.get(d.COURSEID),this.set(d.PARAMS,g),i.one(f.SEARCHBTN).on("click",this.search,this,!1)},show:function(b){var c;return this._usersBufferList=a.clone(this.get(d.SELECTEDUSERS)),this._firstDisplay?(this._firstDisplay=!1,this.search(b,!1)):(c=this.get("boundingBox"),c.all(f.USER).each(function(a){this.markUserNode(a,!1)},this),a.Object.each(this._usersBufferList,function(a,b){var d=c.one(f.USER+'[data-userid="'+b+'"]');d&&this.markUserNode(d,!0)},this),this.setUserTabFocus(c.one(f.USER))),a.namespace("M.gradereport_history.UserSelector").superclass.show.call(this)},search:function(b,c){b&&b.preventDefault();var e;c?this.set(d.PAGE,this.get(d.PAGE)+1):(this.set(d.USERCOUNT,0),this.set(d.PAGE,0)),e=this.get(d.PARAMS),e.sesskey=M.cfg.sesskey,e.action="searchusers",e.search=this.get("boundingBox").one(f.SEARCHFIELD).get("value"),e.page=this.get(d.PAGE),e.perpage=this.get(d.PERPAGE),a.io(M.cfg.wwwroot+this.get(d.AJAXURL),{method:"POST",data:window.build_querystring(e),on:{start:this.preSearch,complete:this.processSearchResults,end:this.postSearch},context:this,arguments:{append:c}})},preSearch:function(a,b){var c=this.get("boundingBox");c.one(f.LIGHTBOX).removeClass(e.HIDDEN),b.append||c.one(f.RESULTSCOUNT).setHTML(M.util.get_string("loading","admin"))},postSearch:function(a,b){var c,d=this.get("boundingBox"),g=d.one(f.FIRSTADDED);d.one(f.LIGHTBOX).addClass(e.HIDDEN),b.append&&g?(this.setUserTabFocus(g),g.one(f.USERSELECT).focus()):(c=d.one(f.USER),c&&this.setUserTabFocus(c))},processSearchResults:function(b,g,h){var i,j,k,l,m,n,o,p,q,r=!1,s=!1,t=this.get("boundingBox"),u=!0;try{r=a.JSON.parse(g.responseText),r.success&&!r.error||(s=!0)}catch(v){s=!0}if(s)return this.setContent(""),void t.one(f.RESULTSCOUNT).setHTML(M.util.get_string("errajaxsearch",c));i=h.append?t.one(f.RESULTSUSERS):a.Node.create('<div role="listbox" aria-activedescendant="" aria-multiselectable="true" class="'+e.USERS+'"></div>'),this._userTemplate||(this._userTemplate=a.Handlebars.compile('<div role="option" aria-selected="false" class="{{CSS.USER}} clearfix" data-userid="{{userId}}"><div class="{{CSS.CHECKBOX}}"><input name="{{USP.CHECKBOX_NAME_PREFIX}}{{userId}}" type="checkbox" tabindex="-1"id="{{checkboxId}}" aria-describedby="{{checkboxId}} {{extraFieldsId}}"/></div><div class="{{CSS.PICTURE}}">{{{picture}}}</div><div class="{{CSS.DETAILS}}"><div class="{{CSS.FULLNAME}}"><label for="{{checkboxId}}">{{fullname}}</label></div><div id="{{extraFieldsId}}" class="{{CSS.EXTRAFIELDS}}">{{extrafields}}</div></div></div>')),j=this._userTemplate,k=this.get(d.USERCOUNT),l="";var w;for(m in r.response.users)k++,w=r.response.users[m],l=!!a.Object.hasKey(this._usersBufferList,w.userid),n=a.Node.create(j({checkboxId:a.guid(),COMPONENT:c,count:k,CSS:e,extrafields:w.extrafields,extraFieldsId:a.guid(),fullname:w.fullname,picture:w.picture,userId:w.userid,USP:d})),this.markUserNode(n,l),h.append&&u&&(i.all(f.FIRSTADDED).removeClass(e.FIRSTADDED),n.addClass(e.FIRSTADDED),u=!1),i.append(n);this.set(d.USERCOUNT,k),q=parseInt(r.response.totalusers,10),h.append?q<=(this.get(d.PAGE)+1)*this.get(d.PERPAGE)&&t.one(f.MORERESULTS).remove():(0===q?(t.one(f.RESULTSCOUNT).setHTML(M.util.get_string("noresults","moodle")),o=""):(1===q?t.one(f.RESULTSCOUNT).setHTML(M.util.get_string("foundoneuser",c)):t.one(f.RESULTSCOUNT).setHTML(M.util.get_string("foundnusers",c,q)),o=a.Node.create('<div class="'+e.SEARCHRESULTS+'"></div>').append(i),r.response.totalusers>(this.get(d.PAGE)+1)*this.get(d.PERPAGE)&&(p=a.Node.create('<div class="'+e.MORERESULTS+'"><a href="#" role="button">'+M.util.get_string("loadmoreusers",c)+"</a></div>"),p.one("a").on("click",this.search,this,!0),p.one("a").on("key",this.search,"space",this,!0),o.append(p))),this.setContent(o))},finishSelectingUsers:function(a){a.preventDefault(),this.applySelection(),this.hide()},applySelection:function(){var b=a.Object.keys(this._usersBufferList);this.set(d.SELECTEDUSERS,a.clone(this._usersBufferList)).setNameDisplay(),a.one(f.USERIDS).set("value",b.join())},selectUser:function(a){var b=a.currentTarget.ancestor(f.USER),c=b.one(f.USERSELECT),d=b.one(f.FULLNAME).get("innerHTML"),e=c.get("checked"),g=b.getData("userid");a.currentTarget!==c&&(e=!e),e?this._usersBufferList[g]=d:(delete this._usersBufferList[g],delete this._usersBufferList[parseInt(g,10)]),this.markUserNode(b,e)},markUserNode:function(a,b){return b?a.addClass(e.SELECTED).set("aria-selected",!0).one(f.USERSELECT).set("checked",!0):a.removeClass(e.SELECTED).set("aria-selected",!1).one(f.USERSELECT).set("checked",!1),this},setContent:function(a){return this.get("boundingBox").one(f.AJAXCONTENT).setHTML(a),this},setNameDisplay:function(){var b=a.Object.values(this.get(d.SELECTEDUSERS));a.one(f.SELECTEDNAMES).set("innerHTML",b.join(", ")),a.one(f.USERFULLNAMES).set("value",b.join())},userKeyboardNavigation:function(a){var b,c=this.get("boundingBox"),d=c.all(f.USER),e=1,g=a.target.ancestor(f.USER,!0);38===a.keyCode&&(e=-1),b=this.findFocusableUser(d,g,e),b&&(a.preventDefault(),b.one(f.USERSELECT).focus(),this.setUserTabFocus(b))},findFocusableUser:function(a,b,c){var d=a.indexOf(b);return a.size()<1?null:d<0?a.item(0):(d+=c,d<0?d=a.size()-1:d>=a.size()&&(d=0),a.item(d))},setUserTabFocus:function(a){this._userTabFocus&&this._userTabFocus.setAttribute("tabindex","-1"),a&&(this._userTabFocus=a.one(f.USERSELECT),this._userTabFocus.setAttribute("tabindex","0"),this.get("boundingBox").one(f.RESULTSUSERS).setAttribute("aria-activedescendant",this._userTabFocus.generateID()))}},{NAME:d.NAME,CSS_PREFIX:d.CSS_PREFIX,ATTRS:{title:{validator:a.Lang.isString,valueFn:function(){return M.util.get_string("selectusers",c)}},url:{validator:a.Lang.isString,value:null},ajaxurl:{validator:a.Lang.isString,value:null},selectedUsers:{validator:a.Lang.isObject,value:null,getter:function(a){return null===a?{}:a}},courseid:{value:null},params:{validator:a.Lang.isArray,value:[]},page:{validator:a.Lang.isNumber,value:0},userCount:{value:0,validator:a.Lang.isNumber},perPage:{value:25,Validator:a.Lang.isNumber}}}),a.Base.modifyAttrs(a.namespace("M.gradereport_history.UserSelector"),{extraClasses:{value:["gradereport_history_usp"]},focusOnPreviousTargetAfterHide:{value:!0},width:{value:"500px"},visible:{value:!1},modal:{value:!0},draggable:{value:!0}}),a.namespace("M.gradereport_history.UserSelector").init=function(a){return new g(a)}},"@VERSION@",{requires:["escape","event-delegate","event-key","handlebars","io-base","json-parse","moodle-core-notification-dialogue"]});